---
phase: 13-album-management
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - src/app/admin/(protected)/albums/[id]/page.tsx
  - src/app/admin/(protected)/albums/[id]/AlbumDetailClient.tsx
  - src/presentation/components/SortablePhotoCard.tsx
  - src/presentation/components/index.ts
  - src/app/admin/(protected)/albums/AlbumsPageClient.tsx
autonomous: false

must_haves:
  truths:
    - "Admin can navigate from albums list to an album's photo management page"
    - "Admin can see which photo is the current cover (visually distinguished)"
    - "Admin can click to set any photo as the album cover"
    - "Admin can drag photos to reorder them within the album"
    - "Photo order persists after page reload"
    - "Public album page shows photos in the admin-arranged order"
  artifacts:
    - path: "src/app/admin/(protected)/albums/[id]/page.tsx"
      provides: "Server component for admin album detail page"
      min_lines: 15
    - path: "src/app/admin/(protected)/albums/[id]/AlbumDetailClient.tsx"
      provides: "Client component with drag-drop grid and cover selection"
      min_lines: 80
    - path: "src/presentation/components/SortablePhotoCard.tsx"
      provides: "Sortable photo card with cover indicator and set-cover button"
      min_lines: 40
  key_links:
    - from: "src/app/admin/(protected)/albums/[id]/AlbumDetailClient.tsx"
      to: "/api/admin/albums/[id]/photos/reorder"
      via: "fetch POST on drag end"
      pattern: "photos/reorder"
    - from: "src/app/admin/(protected)/albums/[id]/AlbumDetailClient.tsx"
      to: "/api/admin/albums/[id]"
      via: "fetch PATCH for cover photo"
      pattern: "api/admin/albums/"
    - from: "src/app/admin/(protected)/albums/AlbumsPageClient.tsx"
      to: "/admin/albums/[id]"
      via: "navigation link on album card"
      pattern: "admin/albums/"
---

<objective>
Build the admin album detail page with drag-to-reorder photo grid and cover photo selection.

Purpose: This is the main user-facing feature of Phase 13 -- an admin page at `/admin/albums/[id]` where the admin can see all photos in an album, drag them to reorder, and click to set a cover photo. The current cover is visually distinguished with a badge. This also adds navigation from the albums list to each album's detail page.

Output: New admin album detail page, SortablePhotoCard component, and updated albums list with links to detail pages.
</objective>

<execution_context>
@/Users/arxherre/.claude/get-shit-done/workflows/execute-plan.md
@/Users/arxherre/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-album-management/13-RESEARCH.md
@.planning/phases/13-album-management/13-01-SUMMARY.md
@src/app/admin/(protected)/albums/page.tsx
@src/app/admin/(protected)/albums/AlbumsPageClient.tsx
@src/presentation/components/SortableAlbumCard.tsx
@src/presentation/components/FadeImage.tsx
@src/presentation/components/index.ts
@src/domain/entities/Album.ts
@src/domain/entities/Photo.ts
@src/app/api/admin/albums/[id]/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin album detail page with drag-to-reorder and cover selection</name>
  <files>
    src/app/admin/(protected)/albums/[id]/page.tsx
    src/app/admin/(protected)/albums/[id]/AlbumDetailClient.tsx
    src/presentation/components/SortablePhotoCard.tsx
    src/presentation/components/index.ts
  </files>
  <action>
    **Create `src/presentation/components/SortablePhotoCard.tsx`** — A sortable photo card for the album detail grid. Uses `useSortable` from `@dnd-kit/sortable` and `CSS` from `@dnd-kit/utilities` (same pattern as existing `SortableAlbumCard.tsx`).

    Props interface:
    ```typescript
    interface SortablePhotoCardProps {
      photo: {
        id: string;
        title: string | null;
        originalFilename: string;
        blurDataUrl: string | null;
      };
      isCover: boolean;
      onSetCover: (photoId: string) => void;
    }
    ```

    Component structure:
    - Outer div with `ref={setNodeRef}` and `style` (transform + transition + opacity when dragging)
    - Cover badge: If `isCover`, show a small absolute-positioned badge (top-left) with "Cover" text. Blue background, white text, rounded, z-10. Example: `<div className="absolute top-2 left-2 z-10 rounded bg-blue-600 px-2 py-0.5 text-xs font-medium text-white">Cover</div>`
    - Photo thumbnail area: aspect-square container with overflow-hidden and rounded-lg. Use a simple `<img>` tag with `src={/api/images/${photo.id}}` and `alt={photo.title || photo.originalFilename}`, className `h-full w-full object-cover`. Apply `{...attributes} {...listeners}` on the entire card div (not a separate handle) so the whole card is draggable, with `className="cursor-grab"`.
    - Filename label below the image: small text showing `photo.title || photo.originalFilename`, truncated.
    - "Set as cover" button: Only shown when `!isCover`. Small text button below the photo. `onClick={() => onSetCover(photo.id)}`. Style: `text-xs text-gray-500 hover:text-blue-600`.
    - When `isCover`, show "Current cover" text in the same spot instead of the button, styled as `text-xs text-blue-600 font-medium`.

    **Update `src/presentation/components/index.ts`** — Add export:
    ```
    export { SortablePhotoCard } from "./SortablePhotoCard";
    ```

    **Create `src/app/admin/(protected)/albums/[id]/AlbumDetailClient.tsx`** — Client component with dnd-kit grid and cover selection. Follow the pattern from `AlbumsPageClient.tsx` but adapted for a photo grid.

    Key implementation details:
    - State: `photos` (array), `album` (for coverPhotoId tracking), `isSaving`, `error`, `activeId` (for DragOverlay)
    - Sensors: `useSensors(useSensor(PointerSensor), useSensor(KeyboardSensor))`
    - DndContext with `closestCenter` collision detection, `onDragStart` (set activeId), `onDragEnd` (reorder)
    - SortableContext with `rectSortingStrategy` (NOT verticalListSortingStrategy -- this is a grid)
    - Grid layout: `<div className="grid grid-cols-2 gap-4 sm:grid-cols-3 lg:grid-cols-4">`
    - DragOverlay: Show a presentational clone of the active photo when dragging. Track `activeId` via `onDragStart`. The overlay is a simple div with the photo thumbnail (not using useSortable). Set `opacity-80` and `shadow-xl` on the overlay for visual feedback.
    - `handleDragEnd`: Optimistic arrayMove + POST to `/api/admin/albums/${album.id}/photos/reorder` with `{ photoIds: newPhotos.map(p => p.id) }`. Revert on error.
    - `handleSetCover`: Optimistic update of `album.coverPhotoId` + PATCH to `/api/admin/albums/${album.id}` with `{ coverPhotoId: photoId }`. Revert on error.
    - Header section: Album title as h1, "Back to Albums" link (`/admin/albums`), photo count.
    - Empty state: If no photos, show a message like "No photos in this album. Add photos from the photo library."
    - Status messages: Same pattern as AlbumsPageClient (saving indicator, error with auto-dismiss).
    - Import DndContext, closestCenter, PointerSensor, KeyboardSensor, useSensor, useSensors, DragEndEvent, DragStartEvent, DragOverlay from `@dnd-kit/core`. Import SortableContext, rectSortingStrategy, arrayMove from `@dnd-kit/sortable`. Import SortablePhotoCard from `@/presentation/components`.

    **Create `src/app/admin/(protected)/albums/[id]/page.tsx`** — Server component. Follow the pattern from the albums list page.
    - Import `SQLiteAlbumRepository` and `SQLitePhotoRepository`
    - Fetch album and photos in parallel: `Promise.all([albumRepo.findById(id), photoRepo.findByAlbumId(id)])`
    - If album not found, call `notFound()`
    - Filter photos to only `status === "ready"` (same as public page)
    - Pass `album` and `photos` to `AlbumDetailClient`
    - The `params` prop uses `Promise<{ id: string }>` pattern (Next.js 16)
    - Pass serializable data: map photos to plain objects with `{ id, title, originalFilename, blurDataUrl, status }`

  </action>
  <verify>
    Run `npm run typecheck` — no errors.
    Run `npm run lint` — no errors.
    Run `npm run build` — builds successfully.
    Visit `/admin/albums/[id]` (any album) — page renders with photo grid.
  </verify>
  <done>
    - Admin album detail page exists at /admin/albums/[id]
    - Photos display in a responsive grid (2 cols on mobile, 3 on sm, 4 on lg)
    - Current cover photo has a "Cover" badge
    - Non-cover photos have a "Set as cover" button
    - Dragging a photo reorders the grid and persists via API
    - DragOverlay provides clean visual feedback during drag
  </done>
</task>

<task type="auto">
  <name>Task 2: Add navigation link from albums list to album detail pages</name>
  <files>
    src/app/admin/(protected)/albums/AlbumsPageClient.tsx
    src/presentation/components/SortableAlbumCard.tsx
  </files>
  <action>
    **Update `src/presentation/components/SortableAlbumCard.tsx`** — Add an `onManage` callback prop to the interface:
    ```typescript
    onManage?: () => void;
    ```

    Add a "Manage" button in the actions area (next to Edit and Delete buttons). Style it the same as the Edit button but with a different color to distinguish it. Example:
    ```tsx
    <button
      type="button"
      onClick={onManage}
      className="rounded-md px-3 py-1.5 text-sm font-medium text-indigo-600 hover:bg-indigo-50"
    >
      Manage Photos
    </button>
    ```

    Place this button BEFORE the Edit button in the actions div.

    **Update `src/app/admin/(protected)/albums/AlbumsPageClient.tsx`** — Import `useRouter` is already there. Add a `handleManageClick` handler:
    ```typescript
    const handleManageClick = (albumId: string) => {
      router.push(`/admin/albums/${albumId}`);
    };
    ```

    Pass `onManage={() => handleManageClick(album.id)}` to each `SortableAlbumCard`.

  </action>
  <verify>
    Run `npm run typecheck` — no errors.
    Run `npm run lint` — no errors.
    Run `npm run build` — builds successfully.
  </verify>
  <done>
    - Each album card in the admin albums list has a "Manage Photos" button
    - Clicking "Manage Photos" navigates to /admin/albums/[id]
    - Navigation works correctly for each album
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete album management feature: admin album detail page with drag-to-reorder photo grid and cover photo selection, plus navigation from the albums list.
  </what-built>
  <how-to-verify>
    1. Start the dev server (`npm run dev`) and ensure the worker is running (`npm run worker`)
    2. Navigate to `/admin/albums` — each album should have a "Manage Photos" button
    3. Click "Manage Photos" on an album with photos — should see a grid of photos
    4. **Cover photo selection**: Click "Set as cover" on any photo. The photo should get a blue "Cover" badge. The previously selected cover (if any) should lose the badge and gain the "Set as cover" button.
    5. **Drag reorder**: Drag a photo to a different position in the grid. The grid should update immediately. A "Saving..." indicator should appear briefly.
    6. **Persistence**: Reload the page. Photos should be in the same order you arranged them. The cover should still be the one you selected.
    7. **Public page**: Navigate to the public album page (`/albums/[id]` for the same album). Photos should appear in the same order the admin arranged them.
    8. **Empty state**: If you have an album with no photos, click "Manage Photos" — should show a friendly empty state message.
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with the layout, drag behavior, or cover selection.</resume-signal>
</task>

</tasks>

<verification>
- `npm run typecheck` passes
- `npm run build` succeeds
- `npm run lint` passes
- Admin can navigate from albums list to album detail via "Manage Photos" button
- Album detail page shows photos in a grid with drag-to-reorder
- Cover photo is visually distinguished with a badge
- Clicking "Set as cover" updates the cover via PATCH API
- Dragging photos reorders them via POST API
- Photo order persists across page reloads
- Public album page reflects admin-set photo order
</verification>

<success_criteria>

1. ALBM-01: Admin can select a cover photo by clicking "Set as cover" in the album detail view
2. ALBM-02: Current cover photo shows a blue "Cover" badge in the admin album detail view
3. ALBM-03: Admin can drag photos to reorder them within the album detail view
4. ALBM-04: Public album page displays photos in the same order the admin arranged
5. Navigation exists from the albums list to each album's detail page
   </success_criteria>

<output>
After completion, create `.planning/phases/13-album-management/13-02-SUMMARY.md`
</output>
