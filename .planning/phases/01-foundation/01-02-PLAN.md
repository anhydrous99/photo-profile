---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/domain/entities/Photo.ts
  - src/domain/entities/Album.ts
  - src/domain/entities/index.ts
  - src/domain/repositories/PhotoRepository.ts
  - src/domain/repositories/AlbumRepository.ts
  - src/domain/repositories/index.ts
  - src/infrastructure/database/schema.ts
  - src/infrastructure/database/client.ts
  - src/infrastructure/database/index.ts
  - src/infrastructure/config/env.ts
  - drizzle.config.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Domain entities define Photo and Album with required fields"
    - "Repository interfaces define CRUD operations for Photo and Album"
    - "Drizzle schema creates photos, albums, and photo_albums tables"
    - "Database connection initializes without errors"
    - "Environment validation fails fast on missing required variables"
  artifacts:
    - path: "src/domain/entities/Photo.ts"
      provides: "Photo entity type"
      exports: ["Photo"]
    - path: "src/domain/entities/Album.ts"
      provides: "Album entity type"
      exports: ["Album"]
    - path: "src/domain/repositories/PhotoRepository.ts"
      provides: "Photo repository interface"
      exports: ["PhotoRepository"]
    - path: "src/domain/repositories/AlbumRepository.ts"
      provides: "Album repository interface"
      exports: ["AlbumRepository"]
    - path: "src/infrastructure/database/schema.ts"
      provides: "Drizzle table definitions"
      contains: "sqliteTable"
    - path: "src/infrastructure/database/client.ts"
      provides: "Database connection"
      exports: ["db"]
    - path: "src/infrastructure/config/env.ts"
      provides: "Validated environment variables"
      exports: ["env"]
  key_links:
    - from: "src/infrastructure/database/schema.ts"
      to: "src/domain/entities/*"
      via: "type alignment"
      pattern: "photos|albums|photoAlbums"
    - from: "src/infrastructure/database/client.ts"
      to: "src/infrastructure/database/schema.ts"
      via: "schema import"
      pattern: "import.*schema"
    - from: "src/infrastructure/config/env.ts"
      to: "process.env"
      via: "Zod validation"
      pattern: "z\\.object"
---

<objective>
Create domain entities, repository interfaces, and Drizzle ORM database schema for Photo and Album entities.

Purpose: Establish the domain model and data layer contracts that enable clean separation between business logic and database implementation. The Drizzle schema provides the SQLite persistence layer.

Output: Photo and Album domain entities with repository interfaces; Drizzle schema with photos, albums, and photo_albums tables; database client with environment validation.
</objective>

<execution_context>
@/Users/arxherre/.claude/get-shit-done/workflows/execute-plan.md
@/Users/arxherre/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Domain Entities and Repository Interfaces</name>
  <files>
    src/domain/entities/Photo.ts
    src/domain/entities/Album.ts
    src/domain/entities/index.ts
    src/domain/repositories/PhotoRepository.ts
    src/domain/repositories/AlbumRepository.ts
    src/domain/repositories/index.ts
  </files>
  <action>
Create domain layer with ZERO external dependencies (no Drizzle, no framework imports).

**Photo Entity (src/domain/entities/Photo.ts):**

```typescript
export interface Photo {
  id: string;
  title: string | null;
  description: string | null;
  originalFilename: string;
  status: "processing" | "ready" | "error";
  createdAt: Date;
  updatedAt: Date;
}
```

**Album Entity (src/domain/entities/Album.ts):**

```typescript
export interface Album {
  id: string;
  title: string;
  description: string | null;
  coverPhotoId: string | null;
  sortOrder: number;
  isPublished: boolean;
  createdAt: Date;
}
```

**Photo Repository Interface (src/domain/repositories/PhotoRepository.ts):**

```typescript
import type { Photo } from "../entities/Photo";

export interface PhotoRepository {
  findById(id: string): Promise<Photo | null>;
  findAll(): Promise<Photo[]>;
  findByAlbumId(albumId: string): Promise<Photo[]>;
  save(photo: Photo): Promise<void>;
  delete(id: string): Promise<void>;
}
```

**Album Repository Interface (src/domain/repositories/AlbumRepository.ts):**

```typescript
import type { Album } from "../entities/Album";

export interface AlbumRepository {
  findById(id: string): Promise<Album | null>;
  findAll(): Promise<Album[]>;
  findPublished(): Promise<Album[]>;
  save(album: Album): Promise<void>;
  delete(id: string): Promise<void>;
}
```

**Index files for clean imports:**

- src/domain/entities/index.ts: Re-export Photo, Album
- src/domain/repositories/index.ts: Re-export PhotoRepository, AlbumRepository

Delete .gitkeep files from directories that now have content.
</action>
<verify>
Run `npx tsc --noEmit` - No TypeScript errors.
Run `grep -r "import.*drizzle" src/domain/` - Returns nothing (domain has no external deps).
</verify>
<done>
Photo and Album entities defined with all required fields. PhotoRepository and AlbumRepository interfaces define CRUD operations. Domain layer has zero external dependencies.
</done>
</task>

<task type="auto">
  <name>Task 2: Create Drizzle Schema and Database Client</name>
  <files>
    src/infrastructure/config/env.ts
    src/infrastructure/database/schema.ts
    src/infrastructure/database/client.ts
    src/infrastructure/database/index.ts
    drizzle.config.ts
    package.json
    .env.local
  </files>
  <action>
Install Drizzle ORM and dependencies:
```bash
npm install drizzle-orm better-sqlite3 zod
npm install -D drizzle-kit @types/better-sqlite3
```

**Environment Validation (src/infrastructure/config/env.ts):**
Create Zod schema that validates required environment variables at import time:

- DATABASE_PATH (required): Path to SQLite database file
- STORAGE_PATH (required): Path to file storage directory
- REDIS_URL (optional): Defaults to redis://localhost:6379
- NODE_ENV (optional): Defaults to 'development'

Use safeParse and throw detailed error on failure. Export typed `env` object.

**Drizzle Schema (src/infrastructure/database/schema.ts):**
Create three tables using drizzle-orm/sqlite-core:

1. `photos` table:
   - id: text primary key
   - title: text nullable
   - description: text nullable
   - originalFilename: text not null
   - status: text enum ['processing', 'ready', 'error'] default 'processing'
   - createdAt: integer timestamp_ms with default current time
   - updatedAt: integer timestamp_ms with default current time

2. `albums` table:
   - id: text primary key
   - title: text not null
   - description: text nullable
   - coverPhotoId: text nullable, references photos.id
   - sortOrder: integer default 0
   - isPublished: integer boolean default false
   - createdAt: integer timestamp_ms with default current time

3. `photoAlbums` junction table:
   - photoId: text not null, references photos.id with cascade delete
   - albumId: text not null, references albums.id with cascade delete
   - sortOrder: integer default 0
   - Composite primary key on (photoId, albumId)
   - Indexes on photoId and albumId for query performance

Use `sql\`(unixepoch() \* 1000)\`` for default timestamps (SQLite syntax).

**Database Client (src/infrastructure/database/client.ts):**

- Import env from config to ensure validation runs first
- Resolve database path using path.resolve with process.cwd()
- Create better-sqlite3 database instance
- Create drizzle instance with schema
- Export `db` for use in repositories

**Drizzle Config (drizzle.config.ts):**
Configure for SQLite with schema pointing to schema.ts file.

**Create .env.local:**

```
DATABASE_PATH=./data/portfolio.db
STORAGE_PATH=./storage
REDIS_URL=redis://localhost:6379
```

Delete .gitkeep files from directories that now have content.
</action>
<verify>
Run `npm run dev` - Server starts (validates env loading works).
Run `npx drizzle-kit push --force` - Creates database tables.
Run `ls data/` - portfolio.db exists.
Run `npx tsc --noEmit` - No TypeScript errors.
</verify>
<done>
Drizzle schema defines photos, albums, photoAlbums tables with proper types and relationships. Database client connects successfully. Environment validation catches missing variables at startup.
</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - No TypeScript errors
2. `npm run dev` - Server starts without env validation errors
3. `npx drizzle-kit push --force` - Database created successfully
4. `grep -r "import.*drizzle" src/domain/` - Returns nothing (domain isolation preserved)
5. Import test: Create temporary file that imports from @/domain/entities - resolves correctly
</verification>

<success_criteria>

- Photo and Album domain entities defined with all required fields
- PhotoRepository and AlbumRepository interfaces define standard CRUD operations
- Domain layer has zero external dependencies (no drizzle, no framework imports)
- Drizzle schema creates photos, albums, photo_albums tables with proper relationships
- Many-to-many relationship implemented via photoAlbums junction table
- Database client initializes with validated environment variables
- Environment validation fails fast with clear error messages on missing variables
- TypeScript compiles without errors
  </success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
