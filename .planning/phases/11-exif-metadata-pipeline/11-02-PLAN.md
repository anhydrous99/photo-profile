---
phase: 11-exif-metadata-pipeline
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/presentation/components/ExifPanel.tsx
  - src/presentation/components/PhotoLightbox.tsx
  - src/presentation/components/HomepageClient.tsx
  - src/presentation/components/AlbumGalleryClient.tsx
  - src/app/page.tsx
  - src/app/albums/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Opening a photo in the lightbox shows an info icon in the toolbar"
    - "Clicking the info icon reveals EXIF metadata in a slide-up panel"
    - "EXIF panel shows camera, lens, settings in a non-intrusive format"
    - "Panel stays open when navigating between photos (per discretion recommendation)"
    - "Photos without EXIF data show no info icon or an empty-state message"
  artifacts:
    - path: "src/presentation/components/ExifPanel.tsx"
      provides: "Expandable EXIF metadata display component"
      contains: "ExifPanel"
    - path: "src/presentation/components/PhotoLightbox.tsx"
      provides: "Toolbar info button + EXIF panel integration"
      contains: "ExifPanel"
    - path: "src/app/page.tsx"
      provides: "exifData passed to HomepageClient"
      contains: "exifData"
    - path: "src/app/albums/[id]/page.tsx"
      provides: "exifData passed to AlbumGalleryClient"
      contains: "exifData"
  key_links:
    - from: "src/app/page.tsx"
      to: "src/presentation/components/HomepageClient.tsx"
      via: "exifData in photo prop objects"
      pattern: "exifData"
    - from: "src/app/albums/[id]/page.tsx"
      to: "src/presentation/components/AlbumGalleryClient.tsx"
      via: "exifData in photo prop objects"
      pattern: "exifData"
    - from: "src/presentation/components/PhotoLightbox.tsx"
      to: "src/presentation/components/ExifPanel.tsx"
      via: "ExifPanel rendered conditionally"
      pattern: "ExifPanel"
    - from: "src/presentation/components/HomepageClient.tsx"
      to: "src/presentation/components/PhotoLightbox.tsx"
      via: "photos prop with exifData"
      pattern: "exifData"
---

<objective>
Display EXIF metadata in the lightbox via an expandable info panel triggered by a toolbar icon.

Purpose: Visitors can see camera and shooting details for any photo without leaving the lightbox. The panel is hidden by default (per user decision), revealed via an info icon tap/click, and slides up over the photo. This is the user-facing feature that makes EXIF data visible.

Output: ExifPanel component, updated PhotoLightbox with toolbar button, data flow from server pages through client components to the lightbox.
</objective>

<execution_context>
@/Users/arxherre/.claude/get-shit-done/workflows/execute-plan.md
@/Users/arxherre/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-exif-metadata-pipeline/11-CONTEXT.md
@.planning/phases/11-exif-metadata-pipeline/11-RESEARCH.md
@.planning/phases/11-exif-metadata-pipeline/11-01-SUMMARY.md
@src/presentation/components/PhotoLightbox.tsx
@src/presentation/components/HomepageClient.tsx
@src/presentation/components/AlbumGalleryClient.tsx
@src/app/page.tsx
@src/app/albums/[id]/page.tsx
@src/domain/entities/Photo.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ExifPanel component and integrate into PhotoLightbox</name>
  <files>
    src/presentation/components/ExifPanel.tsx
    src/presentation/components/PhotoLightbox.tsx
  </files>
  <action>
1. Create `src/presentation/components/ExifPanel.tsx`:
   - "use client" directive
   - Import ExifData from `@/domain/entities/Photo`
   - Props: `{ exifData: ExifData | null; visible: boolean }`
   - If not visible, render nothing (return null)
   - If visible but exifData is null, show a subtle "No camera data available" message
   - Render as an absolutely-positioned panel at the bottom of the lightbox viewport:
     - Position: `fixed bottom-0 left-0 right-0` with `z-50` (above YARL's z-index)
     - Background: semi-transparent dark gradient (`bg-gradient-to-t from-black/90 via-black/70 to-transparent`)
     - Padding: `px-6 py-4 pt-12` (extra top padding for gradient fade)
     - Transition: slide up animation via CSS transition on transform (`translate-y-0` when visible, `translate-y-full` when hidden, `transition-transform duration-300 ease-out`)
     - Actually, always render the panel DOM but toggle visibility via transform so the animation works both ways
   - Content layout: horizontal flex-wrap grid of EXIF fields
     - Each field is a small block: icon/label on top (text-xs text-gray-400), value below (text-sm text-white font-medium)
     - Only render fields that have non-null values
     - Display fields in this order:
       1. Camera: combine cameraMake + cameraModel (e.g. "Canon EOS R5"). If cameraModel already includes the make (starts with cameraMake), just show cameraModel. Raw EXIF string per user decision.
       2. Lens: raw string per user decision (e.g. "EF70-200mm f/2.8L IS III USM")
       3. Focal Length: append "mm" (e.g. "70mm")
       4. Aperture: prepend "f/" (e.g. "f/2.8")
       5. Shutter Speed: already formatted string from backend (e.g. "1/250")
       6. ISO: prepend "ISO " (e.g. "ISO 400")
       7. White Balance: string as-is
       8. Metering: string as-is
       9. Flash: string as-is
       10. Date: format dateTaken ISO string to human-readable (e.g. "Jan 15, 2024") using `new Date(dateTaken).toLocaleDateString("en-US", { year: "numeric", month: "short", day: "numeric" })`
   - Use a compact flex-wrap layout: `flex flex-wrap gap-x-6 gap-y-2`
   - No close button needed on the panel itself (the toolbar icon toggles it)

2. Update `src/presentation/components/PhotoLightbox.tsx`:
   - Import ExifData from `@/domain/entities/Photo`
   - Import ExifPanel from `./ExifPanel`
   - Add `exifData` to the `PhotoData` interface:
     ```typescript
     export interface PhotoData {
       id: string;
       title: string | null;
       description: string | null;
       originalFilename: string;
       exifData?: ExifData | null; // NEW - optional for backward compat
     }
     ```
   - Add state: `const [exifOpen, setExifOpen] = useState(false);`
   - Determine current photo's EXIF: `const currentExif = photos[index]?.exifData ?? null;`
   - Add a custom toolbar button to YARL for toggling EXIF panel. Use YARL's `toolbar.buttons` prop:
     ```typescript
     toolbar={{
       buttons: [
         <button
           key="exif-info"
           type="button"
           className="yarl__button"
           onClick={() => setExifOpen((prev) => !prev)}
           aria-label="Toggle photo information"
           style={{ filter: exifOpen ? "none" : "brightness(0.8)" }}
         >
           {/* Info icon - simple "i" in a circle, SVG */}
           <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width={24} height={24} fill="none" stroke="currentColor" strokeWidth={2} strokeLinecap="round" strokeLinejoin="round">
             <circle cx={12} cy={12} r={10} />
             <line x1={12} y1={16} x2={12} y2={12} />
             <line x1={12} y1={8} x2={12.01} y2={8} />
           </svg>
         </button>,
         "close",
       ]
     }}
     ```
     This places the info icon before the close button in the toolbar (per discretion recommendation: toolbar placement).
   - Render ExifPanel OUTSIDE the Lightbox component but inside the PhotoLightbox wrapper div, as a sibling:
     ```tsx
     return (
       <>
         <Lightbox ... />
         <ExifPanel exifData={currentExif} visible={exifOpen} />
       </>
     );
     ```
   - Per discretion recommendation: panel stays open when navigating between photos (exifOpen state persists across slide changes). The currentExif updates automatically via the index.
     </action>
     <verify>
     `npm run typecheck` passes. `npm run build` succeeds. ExifPanel.tsx exists and exports ExifPanel. PhotoLightbox.tsx imports and renders ExifPanel with toolbar button.
     </verify>
     <done>ExifPanel displays EXIF metadata in a slide-up overlay at the bottom of the lightbox. An info icon in the YARL toolbar toggles the panel. Panel stays open during photo navigation. Only non-null fields are displayed. Camera body and lens shown as raw EXIF strings per user decision.</done>
     </task>

<task type="auto">
  <name>Task 2: Thread exifData through server pages and client components</name>
  <files>
    src/presentation/components/HomepageClient.tsx
    src/presentation/components/AlbumGalleryClient.tsx
    src/app/page.tsx
    src/app/albums/[id]/page.tsx
  </files>
  <action>
1. In `src/presentation/components/HomepageClient.tsx`:
   - Import ExifData from `@/domain/entities/Photo`
   - Add `exifData` to the local `PhotoData` interface:
     ```typescript
     export interface PhotoData {
       id: string;
       title: string | null;
       description: string | null;
       originalFilename: string;
       blurDataUrl: string | null;
       exifData?: ExifData | null;  // ADD
     }
     ```
   - The PhotoLightbox already receives `photos` which includes all fields -- no other changes needed since PhotoLightbox's PhotoData now includes exifData.

2. In `src/presentation/components/AlbumGalleryClient.tsx`:
   - Same change: add `exifData?: ExifData | null` to the local PhotoData interface.
   - Import ExifData from `@/domain/entities/Photo`.

3. In `src/app/page.tsx`:
   - Add `exifData` to the photo mapping passed to HomepageClient:
     ```typescript
     photos={photos.map((p) => ({
       id: p.id,
       title: p.title,
       description: p.description,
       originalFilename: p.originalFilename,
       blurDataUrl: p.blurDataUrl,
       exifData: p.exifData,  // ADD
     }))}
     ```

4. In `src/app/albums/[id]/page.tsx`:
   - Same change: add `exifData: p.exifData` to the photo mapping passed to AlbumGalleryClient.
     </action>
     <verify>
     `npm run typecheck` passes. `npm run build` succeeds. Start `npm run dev`, navigate to homepage and an album page -- pages render without errors. Open lightbox, confirm info icon appears in toolbar. (EXIF panel will show "No camera data available" for existing photos until backfill runs -- this is expected.)
     </verify>
     <done>ExifData flows from database through server components (page.tsx, albums/[id]/page.tsx) to client components (HomepageClient, AlbumGalleryClient) and into the PhotoLightbox. The full data pipeline is connected end-to-end. Existing photos without EXIF data gracefully show empty state.</done>
     </task>

</tasks>

<verification>
1. `npm run typecheck` -- no type errors
2. `npm run build` -- successful build
3. `npm run dev` -- pages render, lightbox opens
4. Info icon visible in lightbox toolbar (before close button)
5. Clicking info icon toggles ExifPanel visibility
6. Panel slides up from bottom with gradient background
7. Photos without EXIF show appropriate empty state
8. Panel content updates when navigating between photos
9. Panel stays open when navigating (per discretion)
</verification>

<success_criteria>

- ExifPanel component renders EXIF metadata in a slide-up panel at bottom of lightbox
- Info icon in YARL toolbar toggles panel (hidden by default per user decision)
- Camera body and lens displayed as raw EXIF strings (per user decision)
- Only non-null fields rendered
- exifData flows from server pages through client components to lightbox
- Existing photos without EXIF data handled gracefully
  </success_criteria>

<output>
After completion, create `.planning/phases/11-exif-metadata-pipeline/11-02-SUMMARY.md`
</output>
