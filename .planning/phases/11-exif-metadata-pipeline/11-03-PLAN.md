---
phase: 11-exif-metadata-pipeline
plan: 03
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - scripts/backfill-exif.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Running npm run exif:backfill populates EXIF data for all existing photos with originals on disk"
    - "Script is idempotent -- only processes photos with no existing EXIF data"
    - "Script prints summary with processed, skipped, and failed counts"
    - "Missing original files are reported as failures, not silent skips"
  artifacts:
    - path: "scripts/backfill-exif.ts"
      provides: "CLI backfill script for EXIF metadata"
      contains: "extractExifData"
    - path: "package.json"
      provides: "npm run exif:backfill script"
      contains: "exif:backfill"
  key_links:
    - from: "scripts/backfill-exif.ts"
      to: "src/infrastructure/services/exifService.ts"
      via: "import extractExifData"
      pattern: "extractExifData"
    - from: "scripts/backfill-exif.ts"
      to: "src/infrastructure/database/client.ts"
      via: "import db for direct queries"
      pattern: "db"
    - from: "package.json"
      to: "scripts/backfill-exif.ts"
      via: "npm script"
      pattern: "backfill-exif"
---

<objective>
Create a CLI script to backfill EXIF metadata for all existing photos that have originals on disk.

Purpose: Photos uploaded before Phase 11 have no EXIF data. This idempotent script reads originals from storage, extracts EXIF via the same service used during upload, and stores the results in the database. Meets requirement EXIF-04.

Output: `scripts/backfill-exif.ts` and `npm run exif:backfill` script in package.json.
</objective>

<execution_context>
@/Users/arxherre/.claude/get-shit-done/workflows/execute-plan.md
@/Users/arxherre/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-exif-metadata-pipeline/11-CONTEXT.md
@.planning/phases/11-exif-metadata-pipeline/11-RESEARCH.md
@.planning/phases/11-exif-metadata-pipeline/11-01-SUMMARY.md
@scripts/backfill-blur-placeholders.ts
@src/infrastructure/services/exifService.ts
@src/infrastructure/database/client.ts
@src/infrastructure/database/schema.ts
@src/domain/entities/Photo.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create backfill-exif script and add npm script</name>
  <files>
    scripts/backfill-exif.ts
    package.json
  </files>
  <action>
1. Create `scripts/backfill-exif.ts` following the pattern established by `scripts/backfill-blur-placeholders.ts`:

```typescript
/**
 * Backfill EXIF metadata for existing photos
 *
 * Usage: npm run exif:backfill
 *
 * Finds all photos with null exif_data and extracts EXIF metadata
 * from the original image file on disk. Idempotent -- safe to re-run.
 */
```

- Import: path, fs/promises, eq, isNull from drizzle-orm, db from client, photos from schema, extractExifData from exifService, env from config/env
- Query: Find all photos where `exif_data IS NULL` (use `isNull(photos.exifData)`)
  - Select: id, originalFilename
- If none found, log "All photos already have EXIF data." and return
- Log: "Found {N} photos without EXIF data."
- Track counters: processed = 0, skipped = 0, failed = 0
- For each photo:
  - Try to find original file:
    - Look in `{STORAGE_PATH}/originals/{photo.id}/` directory
    - List files, find one starting with "original." (e.g., original.jpg, original.png)
    - If directory doesn't exist or no original.\* file found:
      - Log to stderr: `[Backfill] Original not found for photo ${photo.id}, counting as failed`
      - Increment failed counter (per discretion: report with count, not skip silently)
      - continue
  - Call `extractExifData(originalPath)`
  - If result is null:
    - Log: `[Backfill] No EXIF data in photo ${photo.id}, skipping`
    - Increment skipped counter
    - continue
  - Update database: `db.update(photos).set({ exifData: JSON.stringify(result) }).where(eq(photos.id, photo.id))`
  - Increment processed counter
  - Log progress: `[Backfill] ${processed + skipped + failed}/${total} - Photo ${photo.id} (${result.cameraModel || "unknown camera"})`
- Wrap each photo in try/catch:
  - On error: increment failed, log error message to stderr
- Print summary at the end:
  ```
  [Backfill] Complete.
    Processed: {processed} (EXIF extracted and stored)
    Skipped:   {skipped} (no EXIF data in image)
    Failed:    {failed} (missing file or error)
    Total:     {total}
  ```

2. In `package.json`, add the npm script in the "scripts" section:
   ```json
   "exif:backfill": "npx tsx scripts/backfill-exif.ts"
   ```
   Place it after the existing `db:studio` script.
   </action>
   <verify>
   `npm run typecheck` passes. `npm run exif:backfill` runs without errors (will show "All photos already have EXIF data" or process existing photos depending on database state). Script output includes summary line with processed/skipped/failed counts.
   </verify>
   <done>Running `npm run exif:backfill` processes all photos missing EXIF data. Script is idempotent (only processes photos with null exif_data). Missing originals are reported to stderr and counted as failures. Summary output shows processed, skipped, and failed totals per user decision.</done>
   </task>

</tasks>

<verification>
1. `npm run typecheck` -- no type errors
2. `npm run exif:backfill` -- executes without crash
3. Script finds photos with null exif_data
4. Script reads originals from storage/originals/{id}/
5. Script calls extractExifData (reuses same service as worker)
6. Script is idempotent (running twice shows "All photos already have EXIF data" second time)
7. Summary shows processed, skipped, failed counts
8. Missing files logged to stderr and counted as failed
</verification>

<success_criteria>

- `npm run exif:backfill` exists and runs the backfill script
- Script only processes photos with null exif_data (idempotent per user decision)
- Script outputs summary with processed, skipped, and failed counts (per user decision)
- Missing original files are reported (not silently skipped, per discretion recommendation)
- Script reuses extractExifData from exifService (no duplicate EXIF logic)
  </success_criteria>

<output>
After completion, create `.planning/phases/11-exif-metadata-pipeline/11-03-SUMMARY.md`
</output>
