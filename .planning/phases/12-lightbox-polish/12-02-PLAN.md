---
phase: 12-lightbox-polish
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/presentation/components/PhotoLightbox.tsx
  - src/presentation/components/ExifPanel.tsx
  - scripts/backfill-dimensions.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Lightbox loads the image derivative closest to the viewer's screen width via srcSet"
    - "Swiping down on a photo in the lightbox closes it on mobile"
    - "Pinch-to-zoom and double-tap-to-zoom magnify the photo in the lightbox"
    - "A fullscreen button appears in the lightbox toolbar (absent on unsupported browsers)"
    - "EXIF panel hides when the user is zoomed in"
    - "Backfill script populates width/height for existing photos"
  artifacts:
    - path: "src/presentation/components/PhotoLightbox.tsx"
      provides: "Lightbox with Zoom, Fullscreen plugins, srcSet, closeOnPullDown"
      contains: "Zoom"
    - path: "src/presentation/components/ExifPanel.tsx"
      provides: "ExifPanel unchanged (zoom-aware visibility controlled by parent)"
    - path: "scripts/backfill-dimensions.ts"
      provides: "CLI script to backfill width/height for existing photos"
      contains: "backfill"
  key_links:
    - from: "src/presentation/components/PhotoLightbox.tsx"
      to: "yet-another-react-lightbox/plugins/zoom"
      via: "import Zoom and include in plugins array"
      pattern: "plugins.*Zoom"
    - from: "src/presentation/components/PhotoLightbox.tsx"
      to: "yet-another-react-lightbox/plugins/fullscreen"
      via: "import Fullscreen and include in plugins array"
      pattern: "plugins.*Fullscreen"
    - from: "src/presentation/components/PhotoLightbox.tsx"
      to: "/api/images"
      via: "srcSet entries with derivative URLs"
      pattern: "srcSet"
---

<objective>
Enable responsive image loading, touch gestures, zoom, and fullscreen in the YARL lightbox.

Purpose: This is the core of Phase 12 — making the lightbox feel native across devices. Photos load at the right size for the screen (not always 2400w), pinch/double-tap zoom works on mobile, swiping down closes the lightbox, and fullscreen hides browser chrome.

Output: PhotoLightbox.tsx with Zoom + Fullscreen plugins, srcSet configuration, controller settings. Backfill script for existing photo dimensions.
</objective>

<execution_context>
@/Users/arxherre/.claude/get-shit-done/workflows/execute-plan.md
@/Users/arxherre/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-lightbox-polish/12-RESEARCH.md
@.planning/phases/12-lightbox-polish/12-01-SUMMARY.md
@src/presentation/components/PhotoLightbox.tsx
@src/presentation/components/ExifPanel.tsx
@src/infrastructure/services/imageService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance PhotoLightbox with Zoom, Fullscreen, srcSet, and gesture support</name>
  <files>src/presentation/components/PhotoLightbox.tsx</files>
  <action>
    Rewrite the PhotoLightbox component to add all four LBOX capabilities. The research file has the complete verified configuration.

    **Imports — add:**
    ```typescript
    import Zoom from "yet-another-react-lightbox/plugins/zoom";
    import Fullscreen from "yet-another-react-lightbox/plugins/fullscreen";
    ```

    **Add state for zoom tracking:**
    ```typescript
    const [currentZoom, setCurrentZoom] = useState(1);
    ```

    **EXIF visibility — hide when zoomed:**
    ```typescript
    const effectiveExifVisible = exifOpen && currentZoom <= 1;
    ```
    Pass `effectiveExifVisible` to `ExifPanel` instead of `exifOpen`.

    **Build srcSet for slides:**

    Define a constant and helper function:
    ```typescript
    const DERIVATIVE_WIDTHS = [300, 600, 1200, 2400] as const;

    function buildSrcSet(photoId: string, width: number, height: number) {
      const aspectRatio = height / width;
      return DERIVATIVE_WIDTHS.map((w) => ({
        src: `/api/images/${photoId}/${w}w.webp`,
        width: w,
        height: Math.round(w * aspectRatio),
      }));
    }
    ```

    **Transform slides — add srcSet when width/height available:**
    ```typescript
    const slides = photos.map((photo) => ({
      src: `/api/images/${photo.id}/600w.webp`,
      alt: photo.title || photo.originalFilename,
      // Only include width/height and srcSet if dimensions are known
      ...(photo.width && photo.height
        ? {
            width: photo.width,
            height: photo.height,
            srcSet: buildSrcSet(photo.id, photo.width, photo.height),
          }
        : {}),
      title: photo.title || undefined,
      description: photo.description || undefined,
    }));
    ```
    This gracefully handles photos without dimensions (NULL from DB) — they get 600w.webp without srcSet, same as current behavior.

    **Update plugins array:**
    ```typescript
    plugins={[Zoom, Fullscreen, Captions]}
    ```
    Order matters: Zoom must come before Fullscreen so the Zoom plugin can intercept pointer events during pan.

    **Update controller — enable pull-down close (LBOX-02):**
    ```typescript
    controller={{
      closeOnPullDown: true,
      closeOnPullUp: false,
      closeOnBackdropClick: false,
    }}
    ```

    **Add zoom configuration (LBOX-03):**
    ```typescript
    zoom={{
      maxZoomPixelRatio: 1,
      doubleClickMaxStops: 2,
      scrollToZoom: false,
      pinchZoomV4: true,
    }}
    ```
    - `maxZoomPixelRatio: 1` — zoom up to 1:1 pixel density (ideal for photography — shows sharpest detail without blurry upscaling)
    - `doubleClickMaxStops: 2` — double-tap cycles: 1x → ~2x → max → 1x (progressive zoom for composition then pixel-peeping)
    - `scrollToZoom: false` — scroll navigates, doesn't zoom (desktop UX)
    - `pinchZoomV4: true` — natural proportional pinch feel (like iOS Photos)

    **Add fullscreen configuration (LBOX-04):**
    ```typescript
    fullscreen={{
      auto: false,
    }}
    ```
    `auto: false` means user-initiated only. The Fullscreen plugin auto-detects unsupported browsers (iPhone Safari) and hides the button — no custom code needed.

    **Add zoom animation timing:**
    Update the animation object to include zoom:
    ```typescript
    animation={{
      fade: 200,
      swipe: 300,
      zoom: 300,
    }}
    ```

    **Update toolbar buttons — add zoom and fullscreen:**
    ```typescript
    toolbar={{
      buttons: [
        "zoom",
        "fullscreen",
        <button key="exif-info" ...existing EXIF button JSX...>,
        "close",
      ],
    }}
    ```
    The `"zoom"` string places YARL's built-in zoom in/out controls. The `"fullscreen"` string places the fullscreen toggle. The EXIF info button stays before close. This gives the toolbar order: [zoom controls] [fullscreen] [info] [close].

    **Update on callbacks — add zoom tracking:**
    ```typescript
    on={{
      view: ({ index: newIndex }) => {
        onIndexChange?.(newIndex);
        setCurrentZoom(1); // Reset zoom tracking on slide change
      },
      zoom: ({ zoom }) => setCurrentZoom(zoom),
    }}
    ```
    Reset currentZoom on slide change because YARL resets zoom to 1 when changing slides.

    **ExifPanel — use effectiveExifVisible:**
    ```tsx
    <ExifPanel exifData={currentExif} visible={effectiveExifVisible} />
    ```

  </action>
  <verify>
    1. `npm run typecheck` passes
    2. `npm run lint` passes
    3. Verify imports include Zoom and Fullscreen plugins
    4. Verify slides include srcSet when width/height are available
    5. Verify controller has closeOnPullDown: true
    6. Verify zoom config has pinchZoomV4: true
    7. Verify fullscreen config has auto: false
    8. Verify toolbar buttons include "zoom", "fullscreen", EXIF button, "close"
  </verify>
  <done>PhotoLightbox renders with Zoom, Fullscreen, and Captions plugins. srcSet provides responsive derivative loading when dimensions available. Pull-down close enabled. Pinch and double-tap zoom work. Fullscreen button appears (or gracefully absent). EXIF panel hides during zoom.</done>
</task>

<task type="auto">
  <name>Task 2: Create backfill script for photo dimensions</name>
  <files>
    scripts/backfill-dimensions.ts
    package.json
  </files>
  <action>
    Create a backfill script following the established pattern from `scripts/backfill-exif.ts`.

    **Create `scripts/backfill-dimensions.ts`:**

    ```typescript
    /**
     * Backfill width/height dimensions for existing photos
     *
     * Usage: npm run dimensions:backfill
     *
     * Finds all photos with null width/height and extracts post-rotation
     * dimensions from the original image file on disk using Sharp.
     * Idempotent — safe to re-run.
     *
     * Environment: Loaded via dotenv/config (--require flag in npm script)
     */
    import path from "path";
    import fs from "fs/promises";
    import sharp from "sharp";
    import { eq, isNull } from "drizzle-orm";
    import { db } from "@/infrastructure/database/client";
    import { photos } from "@/infrastructure/database/schema";
    import { env } from "@/infrastructure/config/env";

    async function backfill() {
      // Find all photos where width is NULL
      const photosToUpdate = await db
        .select({ id: photos.id, originalFilename: photos.originalFilename })
        .from(photos)
        .where(isNull(photos.width));

      if (photosToUpdate.length === 0) {
        console.log("[Backfill] All photos already have dimensions.");
        return;
      }

      const total = photosToUpdate.length;
      console.log(`[Backfill] Found ${total} photos without dimensions.`);

      let processed = 0;
      let failed = 0;

      for (const photo of photosToUpdate) {
        try {
          // Look for original file in storage/originals/{id}/
          const originalsDir = path.join(env.STORAGE_PATH, "originals", photo.id);

          let originalPath: string | null = null;
          try {
            const files = await fs.readdir(originalsDir);
            const originalFile = files.find((f) => f.startsWith("original."));
            if (originalFile) {
              originalPath = path.join(originalsDir, originalFile);
            }
          } catch {
            // Directory doesn't exist
          }

          if (!originalPath) {
            console.error(
              `[Backfill] Original not found for photo ${photo.id}, counting as failed`,
            );
            failed++;
            continue;
          }

          // Get post-rotation dimensions (matches what the worker does)
          const metadata = await sharp(originalPath).rotate().metadata();
          const width = metadata.width;
          const height = metadata.height;

          if (!width || !height) {
            console.error(
              `[Backfill] Could not read dimensions for photo ${photo.id}`,
            );
            failed++;
            continue;
          }

          // Store dimensions
          await db
            .update(photos)
            .set({ width, height })
            .where(eq(photos.id, photo.id));

          processed++;
          console.log(
            `[Backfill] ${processed + failed}/${total} - Photo ${photo.id} (${width}x${height})`,
          );
        } catch (error) {
          failed++;
          console.error(
            `[Backfill] Failed for photo ${photo.id}:`,
            error instanceof Error ? error.message : error,
          );
        }
      }

      console.log(`[Backfill] Complete.`);
      console.log(`  Processed: ${processed} (dimensions stored)`);
      console.log(`  Failed:    ${failed} (missing file or error)`);
      console.log(`  Total:     ${total}`);
    }

    backfill().catch((err) => {
      console.error("[Backfill] Fatal error:", err);
      process.exit(1);
    });
    ```

    **Add npm script to `package.json`:**
    Add to the "scripts" section (follow the pattern of existing backfill scripts):
    ```json
    "dimensions:backfill": "npx tsx --require dotenv/config scripts/backfill-dimensions.ts"
    ```
    Use `--require dotenv/config` per project decision (solves ESM hoisting issue for standalone CLI scripts).

  </action>
  <verify>
    1. `npm run typecheck` passes
    2. Verify the script exists at `scripts/backfill-dimensions.ts`
    3. Verify `package.json` has the `dimensions:backfill` script
    4. The script pattern matches `backfill-exif.ts` (same file lookup, same error handling, same output format)
  </verify>
  <done>Backfill script exists and can be run via `npm run dimensions:backfill`. It reads originals, extracts post-rotation dimensions via Sharp, and updates the width/height columns. Idempotent — only processes photos with NULL width.</done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes with zero errors
2. `npm run lint` passes
3. PhotoLightbox imports and uses Zoom + Fullscreen plugins
4. srcSet is built from DERIVATIVE_WIDTHS when photo has width/height
5. controller.closeOnPullDown is true
6. zoom config uses pinchZoomV4: true, maxZoomPixelRatio: 1
7. fullscreen config uses auto: false
8. ExifPanel visibility is tied to zoom level (hidden when zoomed)
9. Toolbar order: zoom, fullscreen, info, close
10. Backfill script exists and follows established patterns
</verification>

<success_criteria>

- LBOX-01: Lightbox slides include srcSet with [300, 600, 1200, 2400]w.webp derivatives; YARL Zoom plugin's ResponsiveImage handles selection based on viewport + devicePixelRatio + zoom level
- LBOX-02: controller.closeOnPullDown = true enables iOS-style drag-to-dismiss
- LBOX-03: Zoom plugin with pinchZoomV4: true enables natural pinch-to-zoom; doubleClickMaxStops: 2 enables progressive double-tap zoom
- LBOX-04: Fullscreen plugin auto-hides button on unsupported browsers; auto: false means user-initiated only
- EXIF panel hides when zoom > 1
- Backfill script ready for existing photo dimension population
  </success_criteria>

<output>
After completion, create `.planning/phases/12-lightbox-polish/12-02-SUMMARY.md`
</output>
