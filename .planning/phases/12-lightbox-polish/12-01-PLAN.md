---
phase: 12-lightbox-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/domain/entities/Photo.ts
  - src/infrastructure/database/schema.ts
  - src/infrastructure/database/repositories/SQLitePhotoRepository.ts
  - src/infrastructure/jobs/queues.ts
  - src/infrastructure/jobs/workers/imageProcessor.ts
  - src/app/page.tsx
  - src/app/albums/[id]/page.tsx
  - src/presentation/components/HomepageClient.tsx
  - src/presentation/components/AlbumGalleryClient.tsx
  - src/presentation/components/PhotoLightbox.tsx
autonomous: true

must_haves:
  truths:
    - "Photo entity includes width and height fields"
    - "Database photos table has width and height integer columns"
    - "Image worker extracts and stores post-rotation width/height during processing"
    - "Width and height flow from server pages through client components to PhotoLightbox"
  artifacts:
    - path: "src/domain/entities/Photo.ts"
      provides: "Photo interface with width, height fields"
      contains: "width: number | null"
    - path: "src/infrastructure/database/schema.ts"
      provides: "width and height columns in photos table"
      contains: "width"
    - path: "src/infrastructure/jobs/workers/imageProcessor.ts"
      provides: "Width/height extraction from Sharp metadata"
      contains: "rotatedMeta"
  key_links:
    - from: "src/infrastructure/jobs/workers/imageProcessor.ts"
      to: "src/infrastructure/database/repositories/SQLitePhotoRepository.ts"
      via: "photo.width = width; photo.height = height in completed handler"
      pattern: "photo\\.width"
    - from: "src/app/page.tsx"
      to: "src/presentation/components/HomepageClient.tsx"
      via: "width and height passed in photo data"
      pattern: "width:"
---

<objective>
Add image width/height to the data model and pipeline so YARL can serve responsive derivatives.

Purpose: YARL's Zoom plugin ResponsiveImage component needs width/height on each slide to calculate which srcSet derivative to load. Without these values, it falls back to loading the largest image every time.

Output: Photo entity, DB schema, worker, repository, and data flow all include width/height. New photos get dimensions stored during processing. Existing photos have NULL (handled gracefully in Plan 02).
</objective>

<execution_context>
@/Users/arxherre/.claude/get-shit-done/workflows/execute-plan.md
@/Users/arxherre/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-lightbox-polish/12-RESEARCH.md
@src/domain/entities/Photo.ts
@src/infrastructure/database/schema.ts
@src/infrastructure/database/repositories/SQLitePhotoRepository.ts
@src/infrastructure/jobs/queues.ts
@src/infrastructure/jobs/workers/imageProcessor.ts
@src/app/page.tsx
@src/app/albums/[id]/page.tsx
@src/presentation/components/HomepageClient.tsx
@src/presentation/components/AlbumGalleryClient.tsx
@src/presentation/components/PhotoLightbox.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add width/height to domain, schema, repository, and worker</name>
  <files>
    src/domain/entities/Photo.ts
    src/infrastructure/database/schema.ts
    src/infrastructure/database/repositories/SQLitePhotoRepository.ts
    src/infrastructure/jobs/queues.ts
    src/infrastructure/jobs/workers/imageProcessor.ts
  </files>
  <action>
    1. **Photo entity** (`src/domain/entities/Photo.ts`): Add `width: number | null` and `height: number | null` fields to the `Photo` interface after the `exifData` field.

    2. **DB schema** (`src/infrastructure/database/schema.ts`): Add `width` and `height` integer columns to the `photos` table definition. Place them after `exifData`:
       ```
       width: integer("width"),
       height: integer("height"),
       ```
       No `.notNull()` — existing rows will have NULL.

    3. **Schema migration**: Run `ALTER TABLE photos ADD COLUMN width INTEGER; ALTER TABLE photos ADD COLUMN height INTEGER;` directly against the SQLite database using the project's database client. Follow the established pattern from Phase 11 — use ALTER TABLE, never db:push (per project memory: "Always use ALTER TABLE directly, never db:push").

       Create a one-time migration by adding SQL execution at the top of a temporary script or inline in the worker. Actually, the simplest approach: create the migration inline in the schema file as a comment, then run the ALTER TABLE commands via the db client. The cleanest approach: run the ALTER TABLE statements via `npx tsx -e` one-liner:
       ```bash
       npx tsx -e "
         import { db } from './src/infrastructure/database/client';
         import { sql } from 'drizzle-orm';
         try { db.run(sql\`ALTER TABLE photos ADD COLUMN width INTEGER\`); } catch(e) { console.log('width column may already exist'); }
         try { db.run(sql\`ALTER TABLE photos ADD COLUMN height INTEGER\`); } catch(e) { console.log('height column may already exist'); }
         console.log('Migration complete');
       "
       ```
       Note: The db client uses better-sqlite3 which is synchronous, but Drizzle wraps it. Use `db.run()` for raw SQL.

    4. **Repository mapping** (`src/infrastructure/database/repositories/SQLitePhotoRepository.ts`):
       - In `toDomain()`: add `width: row.width ?? null` and `height: row.height ?? null`
       - In `toDatabase()`: add `width: photo.width` and `height: photo.height`

    5. **Job result** (`src/infrastructure/jobs/queues.ts`): Add `width: number` and `height: number` to the `ImageJobResult` interface.

    6. **Image worker** (`src/infrastructure/jobs/workers/imageProcessor.ts`):
       - In the processor function, AFTER generating derivatives and BEFORE extracting EXIF, add width/height extraction. Use Sharp's `.rotate()` to get post-rotation dimensions (important for portrait photos):
         ```typescript
         // Get post-rotation dimensions for accurate srcSet
         const rotatedMeta = await sharp(originalPath).rotate().metadata();
         const width = rotatedMeta.width!;
         const height = rotatedMeta.height!;
         ```
       - Include `width` and `height` in the return object.
       - In the `completed` handler, add `photo.width = result.width;` and `photo.height = result.height;` before `repository.save(photo)`.

  </action>
  <verify>
    Run `npm run typecheck` — no TypeScript errors. The Photo interface, schema, repository, and worker should all align on the new fields.
  </verify>
  <done>Photo entity has width/height fields. Schema has columns. Repository maps them. Worker extracts post-rotation dimensions and stores them on completion. Type check passes.</done>
</task>

<task type="auto">
  <name>Task 2: Pass width/height through server pages and client components to PhotoLightbox</name>
  <files>
    src/app/page.tsx
    src/app/albums/[id]/page.tsx
    src/presentation/components/HomepageClient.tsx
    src/presentation/components/AlbumGalleryClient.tsx
    src/presentation/components/PhotoLightbox.tsx
  </files>
  <action>
    1. **PhotoData interface in PhotoLightbox.tsx**: Add `width: number | null` and `height: number | null` to the `PhotoData` interface.

    2. **PhotoData interface in HomepageClient.tsx**: Add `width: number | null` and `height: number | null` to the `PhotoData` interface (it's duplicated there).

    3. **PhotoData interface in AlbumGalleryClient.tsx**: Add `width: number | null` and `height: number | null` to the `PhotoData` interface (also duplicated).

    4. **Homepage server page** (`src/app/page.tsx`): Add `width: p.width` and `height: p.height` to the photo mapping in the `HomepageClient` props.

    5. **Album page** (`src/app/albums/[id]/page.tsx`): Add `width: p.width` and `height: p.height` to the photo mapping in the `AlbumGalleryClient` props.

    Note: The lightbox won't use width/height yet (that's Plan 02). This task just ensures the data flows through so Plan 02 can consume it.

  </action>
  <verify>
    Run `npm run typecheck` — still no errors. Verify the data flows from server to client by checking that PhotoData includes width/height in all three locations (PhotoLightbox, HomepageClient, AlbumGalleryClient).
  </verify>
  <done>Width and height flow from server pages through client components to PhotoLightbox. TypeScript compiles cleanly.</done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes with zero errors
2. `npm run lint` passes
3. Photo entity, schema, repository, worker, job result, and all client interfaces include width/height
4. The ALTER TABLE migration has been applied (columns exist in DB)
</verification>

<success_criteria>

- Photo entity includes `width: number | null` and `height: number | null`
- photos table has `width INTEGER` and `height INTEGER` columns
- Worker extracts post-rotation dimensions via `sharp(path).rotate().metadata()` and stores them
- Width/height are passed through server pages → client components → PhotoLightbox
- `npm run typecheck` passes
  </success_criteria>

<output>
After completion, create `.planning/phases/12-lightbox-polish/12-01-SUMMARY.md`
</output>
