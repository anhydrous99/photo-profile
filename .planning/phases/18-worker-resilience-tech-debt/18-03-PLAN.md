---
phase: 18-worker-resilience-tech-debt
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/infrastructure/database/client.ts
  - src/__tests__/helpers/test-db.ts
autonomous: true

must_haves:
  truths:
    - "Initial CREATE TABLE for albums in client.ts includes ON DELETE SET NULL on cover_photo_id FK"
    - "Initial CREATE TABLE for albums in client.ts includes tags TEXT column"
    - "test-db.ts step 2 albums CREATE includes tags TEXT column matching client.ts"
    - "Misleading comment on client.ts line 127 is corrected to explain that SQLite does NOT update FK references"
    - "Phase 13 FK migration still runs correctly as a no-op for new databases"
  artifacts:
    - path: "src/infrastructure/database/client.ts"
      provides: "Corrected initial schema with SET NULL FK and accurate comments"
      contains: "ON DELETE SET NULL"
    - path: "src/__tests__/helpers/test-db.ts"
      provides: "Test DB schema matching client.ts initial CREATE (tags in step 2)"
      contains: "tags TEXT"
  key_links:
    - from: "src/__tests__/helpers/test-db.ts"
      to: "src/infrastructure/database/client.ts"
      via: "Schema parity between test and production initialization"
      pattern: "CREATE TABLE.*albums"
---

<objective>
Fix schema drift between client.ts and test-db.ts, add ON DELETE SET NULL to the initial albums CREATE TABLE so new databases don't need an unnecessary migration, and fix the misleading SQLite FK comment.

Purpose: DEBT-01 (FK constraint), DEBT-02 (schema drift), and DEBT-03 (stale comments) are tracked issues that create confusion for future maintenance. Putting SET NULL and tags in the initial CREATE makes new database initialization cleaner. Fixing the comment prevents incorrect assumptions about SQLite FK behavior.

Output: Aligned schemas in client.ts and test-db.ts, correct comments.
</objective>

<execution_context>
@/Users/arxherre/.claude/get-shit-done/workflows/execute-plan.md
@/Users/arxherre/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-worker-resilience-tech-debt/18-RESEARCH.md

@src/infrastructure/database/client.ts
@src/**tests**/helpers/test-db.ts
@src/infrastructure/database/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix client.ts initial CREATE and misleading comment</name>
  <files>src/infrastructure/database/client.ts</files>
  <action>
Make three targeted changes to `client.ts`:

**Change 1: Add ON DELETE SET NULL to initial albums CREATE TABLE (line 43)**

Current line 43:

```sql
cover_photo_id TEXT REFERENCES photos(id),
```

Change to:

```sql
cover_photo_id TEXT REFERENCES photos(id) ON DELETE SET NULL,
```

This means new databases will have the correct FK behavior from the start. The Phase 13 migration will detect this via `PRAGMA foreign_key_list(albums)` and see `on_delete === "SET NULL"`, making it a no-op. Existing databases already have the migration applied.

**Change 2: Fix misleading comment on line 126-127**

Current comment (line 126-127):

```typescript
        -- Rebuild photo_albums to fix stale FK reference to _albums_old
        -- (SQLite updates FK references in other tables during ALTER TABLE RENAME)
```

This is WRONG. The truth is the OPPOSITE: SQLite does NOT update FK references when foreign_keys is OFF. That's precisely WHY the rebuild is needed. Fix to:

```typescript
        -- Rebuild photo_albums to fix stale FK reference to _albums_old
        -- (SQLite does NOT update FK references in other tables during
        --  ALTER TABLE RENAME when foreign_keys is OFF, so rebuild is required)
```

**Change 3: Verify no other stale comments**

The research confirmed imageProcessor.ts JPEG reference is already fixed (line 52 says "WebP + AVIF"). No other stale comments found. No action needed here -- just verify during review.
</action>
<verify>
`npm run typecheck` passes. Verify:

1. Initial albums CREATE has `ON DELETE SET NULL` on cover_photo_id
2. Comment accurately describes that SQLite does NOT update FK references
3. Phase 13 migration logic is unchanged (it will be a no-op for new DBs since FK is already correct)
   </verify>
   <done>
   Initial albums CREATE includes ON DELETE SET NULL. Misleading FK comment is corrected. Phase 13 migration is preserved as a backward-compatible no-op for new databases.
   </done>
   </task>

<task type="auto">
  <name>Task 2: Align test-db.ts schema with client.ts and fix its comment</name>
  <files>src/__tests__/helpers/test-db.ts</files>
  <action>
Fix schema drift in `test-db.ts` so its initial albums CREATE matches client.ts:

**Change 1: Add `tags TEXT` to step 2 albums CREATE**

Current step 2 (lines 37-47):

```sql
CREATE TABLE IF NOT EXISTS albums (
  id TEXT PRIMARY KEY,
  title TEXT NOT NULL,
  description TEXT,
  cover_photo_id TEXT REFERENCES photos(id),
  sort_order INTEGER NOT NULL DEFAULT 0,
  is_published INTEGER NOT NULL DEFAULT 0,
  created_at INTEGER NOT NULL DEFAULT (unixepoch() * 1000)
)
```

Change to (add `tags TEXT` after `description TEXT`, and add `ON DELETE SET NULL` to cover_photo_id):

```sql
CREATE TABLE IF NOT EXISTS albums (
  id TEXT PRIMARY KEY,
  title TEXT NOT NULL,
  description TEXT,
  tags TEXT,
  cover_photo_id TEXT REFERENCES photos(id) ON DELETE SET NULL,
  sort_order INTEGER NOT NULL DEFAULT 0,
  is_published INTEGER NOT NULL DEFAULT 0,
  created_at INTEGER NOT NULL DEFAULT (unixepoch() * 1000)
)
```

**Change 2: Simplify step 7 migration**

Since the initial CREATE now has both `tags TEXT` and `ON DELETE SET NULL`, step 7 (the FK rebuild migration) becomes a no-op in test-db.ts. However, to keep the test-db faithfully replaying the migration chain (since it tests that migrations work), KEEP the migration code but update the comment:

Current comment at step 7 (line 74):

```typescript
// 7. Migration: Fix coverPhotoId FK constraint + add tags column (Phase 13)
//    Rebuild albums table with ON DELETE SET NULL and tags TEXT column
```

Update to:

```typescript
// 7. Migration: Fix coverPhotoId FK constraint (Phase 13)
//    In production, this migrates old DBs without SET NULL or tags.
//    Here it runs as a no-op since step 2 already has both.
//    Kept to verify migration chain doesn't break on already-correct schemas.
```

Actually, the migration is NOT a no-op -- it still does ALTER TABLE RENAME and rebuilds. For test-db.ts it's better to keep the migration as-is to prove backward compatibility. But since the initial CREATE now includes `tags TEXT`, the INSERT INTO needs adjustment.

Current step 7 INSERT (line 89):

```sql
INSERT INTO albums SELECT id, title, description, NULL, cover_photo_id, sort_order, is_published, created_at FROM _albums_old;
```

The `NULL` was for the `tags` column that didn't exist in the old table. Since the old table now HAS `tags`, change to:

```sql
INSERT INTO albums SELECT id, title, description, tags, cover_photo_id, sort_order, is_published, created_at FROM _albums_old;
```

**Change 3: Fix the existing correct comment in test-db.ts**

The comment at lines 93-95 is already correct:

```typescript
// 8. Rebuild photo_albums to fix stale FK reference to _albums_old
//    (SQLite does not update FK references in other tables when
//     foreign_keys is OFF during ALTER TABLE RENAME)
```

This is fine -- no change needed. This is the CORRECT version that client.ts should match.
</action>
<verify>
`npm run typecheck` passes. Run `npx vitest run` to verify existing tests still pass with the schema changes (the test-db is used by repository and other integration tests).

Verify:

1. test-db.ts step 2 albums CREATE includes `tags TEXT` and `ON DELETE SET NULL`
2. Step 7 INSERT uses `tags` column (not NULL placeholder)
3. Existing tests pass
   </verify>
   <done>
   test-db.ts initial albums CREATE matches client.ts (has tags TEXT and ON DELETE SET NULL). Migration step 7 INSERT references tags column correctly. All existing tests pass.
   </done>
   </task>

</tasks>

<verification>
1. `npm run typecheck` passes
2. `npm run lint` passes
3. `npx vitest run` -- all existing tests pass
4. client.ts initial CREATE has ON DELETE SET NULL and tags TEXT
5. test-db.ts initial CREATE matches (has ON DELETE SET NULL and tags TEXT)
6. Misleading FK comment in client.ts is corrected
7. Phase 13 migration in client.ts is preserved (backward compatible)
</verification>

<success_criteria>

- FK constraint on albums.coverPhotoId has ON DELETE SET NULL in initial CREATE (DEBT-01)
- Schema drift reconciled between client.ts and test-db.ts (DEBT-02)
- Misleading FK comment corrected (DEBT-03)
- No regressions in existing tests
  </success_criteria>

<output>
After completion, create `.planning/phases/18-worker-resilience-tech-debt/18-03-SUMMARY.md`
</output>
