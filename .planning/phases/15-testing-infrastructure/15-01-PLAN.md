---
phase: 15-testing-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vitest.config.ts
  - src/__tests__/setup.ts
  - src/__tests__/helpers/test-db.ts
autonomous: true

must_haves:
  truths:
    - "Importing server-only, next/headers, next/navigation, next/cache, ioredis in a test file does not crash or hang"
    - "createTestDb() returns a Drizzle ORM instance backed by in-memory SQLite with all production columns and constraints"
    - "Environment variables are set before any module loads so env.ts validation passes"
  artifacts:
    - path: "vitest.config.ts"
      provides: "Test configuration with env vars, setup file path, path aliases"
      contains: "setupFiles"
    - path: "src/__tests__/setup.ts"
      provides: "Global mocks for server-only, next/headers, next/navigation, next/cache, ioredis, react.cache, bullmq"
      contains: "vi.mock"
    - path: "src/__tests__/helpers/test-db.ts"
      provides: "createTestDb() factory returning Drizzle ORM + raw sqlite handle on :memory: database"
      exports: ["createTestDb"]
  key_links:
    - from: "vitest.config.ts"
      to: "src/__tests__/setup.ts"
      via: "setupFiles config option"
      pattern: "setupFiles.*setup\\.ts"
    - from: "src/__tests__/helpers/test-db.ts"
      to: "src/infrastructure/database/schema.ts"
      via: "import schema for drizzle()"
      pattern: "import.*schema"
---

<objective>
Set up the Vitest test infrastructure: global mocks that prevent module-level crashes and hangs, environment variable configuration, and an in-memory test database helper that mirrors the production schema.

Purpose: This is the foundation that all future test files (Phases 15-02, 17, 18) depend on. Without these mocks, importing any infrastructure module crashes or hangs the test runner.

Output: Updated `vitest.config.ts`, new `src/__tests__/setup.ts` with global mocks, and `src/__tests__/helpers/test-db.ts` with `createTestDb()` factory.
</objective>

<execution_context>
@/Users/arxherre/.claude/get-shit-done/workflows/execute-plan.md
@/Users/arxherre/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-testing-infrastructure/15-RESEARCH.md
@vitest.config.ts
@src/infrastructure/database/client.ts
@src/infrastructure/database/schema.ts
@src/infrastructure/config/env.ts
@src/infrastructure/auth/session.ts
@src/infrastructure/auth/dal.ts
@src/infrastructure/jobs/queues.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update vitest.config.ts with env vars, setup file, and coverage provider</name>
  <files>vitest.config.ts</files>
  <action>
Update the existing `vitest.config.ts` to add:

1. **test.env** — Set all required environment variables BEFORE any module loads. This prevents `env.ts` Zod validation from crashing:
   - `DATABASE_PATH`: `":memory:"`
   - `STORAGE_PATH`: `"/tmp/test-storage"`
   - `AUTH_SECRET`: `"test-secret-key-must-be-at-least-32-chars-long!!"` (must be 32+ chars)
   - `ADMIN_PASSWORD_HASH`: `"$2b$10$abcdefghijklmnopqrstuuABCDEFGHIJKLMNOPQRSTUVW"` (placeholder bcrypt-shaped string)
   - `NODE_ENV`: `"test"`
   - `REDIS_URL`: `"redis://localhost:6379"`

2. **test.setupFiles** — Point to `["./src/__tests__/setup.ts"]`

3. Keep existing config (globals: true, environment: "node", resolve.alias).

Do NOT add coverage config yet — that is in Plan 02.

The final config should look like the research example minus the coverage section.
</action>
<verify>Run `npx vitest run --passWithNoTests` and confirm it exits cleanly (no env validation crash, no hang). The existing `src/__tests__/theme-tokens.test.ts` should still pass.</verify>
<done>vitest.config.ts has env vars and setupFiles configured; `npx vitest run` does not crash on environment variable validation</done>
</task>

<task type="auto">
  <name>Task 2: Create setup.ts global mocks and test-db.ts helper</name>
  <files>src/__tests__/setup.ts, src/__tests__/helpers/test-db.ts</files>
  <action>
**File 1: `src/__tests__/setup.ts`** — Global mock file loaded before every test.

Must contain ONLY `vi.mock()` calls. Do NOT import the mocked modules in this file (Vitest known issue: mocks fail if the setup file itself imports the mocked module).

Mock these modules with factory functions:

1. `server-only` — Return empty object `{}`. Prevents "cannot import from Client Component" crash.

2. `next/headers` — Return `{ cookies: vi.fn(() => ({ get: vi.fn(), set: vi.fn(), delete: vi.fn() })), headers: vi.fn(() => new Map()) }`. The `cookies()` function must return an object (not a promise) for synchronous mock access, but note that real Next.js cookies() is async — tests that need async behavior can override per-test.

3. `next/navigation` — Return `{ redirect: vi.fn(), notFound: vi.fn(), useRouter: vi.fn(() => ({ push: vi.fn(), replace: vi.fn(), refresh: vi.fn(), back: vi.fn() })), usePathname: vi.fn(() => "/"), useSearchParams: vi.fn(() => new URLSearchParams()) }`.

4. `next/cache` — Return `{ revalidatePath: vi.fn(), revalidateTag: vi.fn(), unstable_cache: vi.fn((fn) => fn) }`.

5. `ioredis` — Return `{ default: vi.fn(() => ({ connect: vi.fn(), disconnect: vi.fn(), quit: vi.fn(), on: vi.fn(), get: vi.fn(), set: vi.fn(), del: vi.fn(), status: "ready" })) }`. The default export must be a constructor function (called with `new IORedis()`).

6. `react` — Use `vi.importActual('react')` to preserve all real React exports, but override `cache` with `vi.fn((fn) => fn)` (pass-through). This is needed because `dal.ts` uses `import { cache } from "react"`. Pattern:

   ```
   vi.mock('react', async (importOriginal) => {
     const actual = await importOriginal();
     return { ...actual, cache: vi.fn((fn) => fn) };
   });
   ```

7. `bullmq` — Mock the Queue and Worker constructors to prevent them from attempting Redis operations even with mocked IORedis. Return `{ Queue: vi.fn(() => ({ add: vi.fn(), close: vi.fn(), on: vi.fn() })), Worker: vi.fn(() => ({ on: vi.fn(), close: vi.fn() })) }`.

**File 2: `src/__tests__/helpers/test-db.ts`** — In-memory database factory.

Create a `createTestDb()` function that:

1. Creates `new Database(":memory:")` from `better-sqlite3`
2. Creates `drizzle({ client: sqlite, schema })` importing `* as schema from "@/infrastructure/database/schema"`
3. Runs the EXACT migration chain from `client.ts` `initializeDatabase()`:
   - CREATE TABLE photos (base columns: id, title, description, original_filename, blur_data_url, status, created_at, updated_at)
   - CREATE TABLE albums (base columns: id, title, description, cover_photo_id referencing photos(id), sort_order, is_published, created_at)
   - CREATE TABLE photo_albums (junction: photo_id, album_id, sort_order, PRIMARY KEY (photo_id, album_id), ON DELETE CASCADE on both FKs)
   - CREATE INDEX photo_albums_photo_idx ON photo_albums(photo_id)
   - CREATE INDEX photo_albums_album_idx ON photo_albums(album_id)
   - ALTER TABLE photos ADD COLUMN exif_data TEXT (Phase 11)
   - ALTER TABLE photos ADD COLUMN width INTEGER (Phase 12)
   - ALTER TABLE photos ADD COLUMN height INTEGER (Phase 12)
   - Rebuild albums table for FK fix + tags column (Phase 13): RENAME TO \_albums_old, CREATE new albums table with tags TEXT column and cover_photo_id REFERENCES photos(id) ON DELETE SET NULL, INSERT from \_albums_old using NULL for tags, DROP \_albums_old
   - PRAGMA foreign_keys = ON
4. Returns `{ db, sqlite }` — db is the Drizzle instance, sqlite is the raw better-sqlite3 handle (for cleanup via `sqlite.close()`)

Run all migrations unconditionally (no conditional checks needed — fresh in-memory DB is always empty).

Export: `export function createTestDb()`.
</action>
<verify>Run `npx vitest run` — the existing theme-tokens test should still pass. Create a temporary inline test or verify no import errors by checking vitest output for setup file loading.</verify>
<done>Setup file mocks all 7 module categories; test-db.ts exports createTestDb() with full migration chain matching production</done>
</task>

</tasks>

<verification>
1. `npx vitest run` completes without hanging (no IORedis TCP connection attempt)
2. `npx vitest run` completes without crashing (no server-only, env.ts, or next/headers errors)
3. Existing `src/__tests__/theme-tokens.test.ts` still passes
4. `src/__tests__/setup.ts` contains vi.mock calls for all 7 module categories
5. `src/__tests__/helpers/test-db.ts` exists and exports createTestDb
</verification>

<success_criteria>

- vitest.config.ts has test.env with all required environment variables
- vitest.config.ts has setupFiles pointing to src/**tests**/setup.ts
- Setup file mocks: server-only, next/headers, next/navigation, next/cache, ioredis, react (cache), bullmq
- test-db.ts createTestDb() mirrors the exact migration chain from client.ts initializeDatabase()
- `npx vitest run` exits 0 with no hangs
  </success_criteria>

<output>
After completion, create `.planning/phases/15-testing-infrastructure/15-01-SUMMARY.md`
</output>
