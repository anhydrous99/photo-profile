---
phase: 05-photo-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/admin/photos/[id]/route.ts
  - src/infrastructure/storage/fileStorage.ts
  - src/infrastructure/storage/index.ts
autonomous: true

must_haves:
  truths:
    - "Admin can update a photo's description via API"
    - "Admin can delete a photo via API"
    - "Deleting a photo removes all associated files"
  artifacts:
    - path: "src/app/api/admin/photos/[id]/route.ts"
      provides: "Photo PATCH and DELETE endpoints"
      exports: ["PATCH", "DELETE"]
    - path: "src/infrastructure/storage/fileStorage.ts"
      provides: "File deletion function"
      contains: "deletePhotoFiles"
  key_links:
    - from: "src/app/api/admin/photos/[id]/route.ts"
      to: "photoRepository.save"
      via: "PATCH handler saves updated photo"
      pattern: "photoRepository\\.save"
    - from: "src/app/api/admin/photos/[id]/route.ts"
      to: "deletePhotoFiles"
      via: "DELETE handler removes files before DB delete"
      pattern: "deletePhotoFiles.*photoRepository\\.delete"
---

<objective>
Create API endpoints for updating photo descriptions and deleting photos with complete file cleanup.

Purpose: Enable photo metadata editing and safe deletion (with file cleanup) - foundation for admin management UI.
Output: PATCH and DELETE routes for /api/admin/photos/[id], file deletion utility.
</objective>

<execution_context>
@/Users/arxherre/.claude/get-shit-done/workflows/execute-plan.md
@/Users/arxherre/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-photo-management/05-CONTEXT.md

@src/app/api/admin/upload/route.ts
@src/infrastructure/storage/fileStorage.ts
@src/infrastructure/database/repositories/SQLitePhotoRepository.ts
@src/domain/entities/Photo.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create file deletion utility</name>
  <files>
    src/infrastructure/storage/fileStorage.ts
    src/infrastructure/storage/index.ts
  </files>
  <action>
Add a `deletePhotoFiles` function to fileStorage.ts that removes all files for a given photoId:

1. Delete the entire `storage/originals/{photoId}/` directory (recursive)
2. Delete the entire `storage/processed/{photoId}/` directory (recursive)
3. Use `rm` with recursive and force options (fs/promises)
4. Handle case where directories don't exist (no error)
5. Export from index.ts

Function signature:

```typescript
export async function deletePhotoFiles(photoId: string): Promise<void>;
```

Use `rm(path, { recursive: true, force: true })` which won't throw if directory doesn't exist.
</action>
<verify>
TypeScript compiles: `npx tsc --noEmit`
</verify>
<done>
`deletePhotoFiles` function exists and is exported, handles non-existent directories gracefully.
</done>
</task>

<task type="auto">
  <name>Task 2: Create photo API routes</name>
  <files>src/app/api/admin/photos/[id]/route.ts</files>
  <action>
Create Next.js route handler at `src/app/api/admin/photos/[id]/route.ts`:

**PATCH handler (update description):**

1. Verify admin session (use verifySession from @/infrastructure/auth)
2. Parse JSON body expecting `{ description: string | null }`
3. Fetch photo by ID from repository
4. If not found, return 404
5. Update description and updatedAt
6. Save via repository
7. Return updated photo as JSON

**DELETE handler:**

1. Verify admin session
2. Fetch photo by ID
3. If not found, return 404
4. Call `deletePhotoFiles(id)` to remove all files
5. Delete photo from database via repository
6. Return 204 No Content

Follow patterns from existing upload route:

- Use SQLitePhotoRepository
- Return proper HTTP status codes
- Include meaningful error messages
  </action>
  <verify>

1. `npm run lint` passes
2. `npm run build` completes (Redis warnings OK)
3. Manual test: Start dev server, use curl to test PATCH endpoint
   ```bash
   curl -X PATCH http://localhost:3000/api/admin/photos/test-id \
     -H "Content-Type: application/json" \
     -d '{"description": "Test"}' \
     -b "session=..."
   ```
   Should return 401 without valid session, 404 for non-existent photo.
   </verify>
   <done>
   PATCH returns updated photo on success, 404 for missing photo, 401 for unauthorized.
   DELETE removes files and database record, returns 204 on success.
   </done>
   </task>

</tasks>

<verification>
- [ ] `npm run lint` passes
- [ ] `npm run build` completes
- [ ] TypeScript compiles without errors
- [ ] Both PATCH and DELETE handlers verify session
- [ ] DELETE properly cleans up files before database deletion
</verification>

<success_criteria>

1. PATCH /api/admin/photos/[id] updates description and returns updated photo
2. DELETE /api/admin/photos/[id] removes files from storage/originals and storage/processed
3. DELETE removes photo record from database
4. Both endpoints return 401 for unauthenticated requests
5. Both endpoints return 404 for non-existent photos
   </success_criteria>

<output>
After completion, create `.planning/phases/05-photo-management/05-01-SUMMARY.md`
</output>
