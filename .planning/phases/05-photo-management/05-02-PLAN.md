---
phase: 05-photo-management
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/admin/photos/[id]/albums/route.ts
  - src/infrastructure/database/repositories/SQLitePhotoRepository.ts
  - src/domain/repositories/PhotoRepository.ts
autonomous: true

must_haves:
  truths:
    - "Admin can add a photo to an album via API"
    - "Admin can remove a photo from an album via API"
    - "Admin can retrieve albums a photo belongs to"
  artifacts:
    - path: "src/app/api/admin/photos/[id]/albums/route.ts"
      provides: "Album assignment endpoints"
      exports: ["GET", "POST", "DELETE"]
    - path: "src/infrastructure/database/repositories/SQLitePhotoRepository.ts"
      provides: "Album membership methods"
      contains: "addToAlbum"
    - path: "src/domain/repositories/PhotoRepository.ts"
      provides: "Repository interface with album methods"
      contains: "getAlbumIds"
  key_links:
    - from: "src/app/api/admin/photos/[id]/albums/route.ts"
      to: "photoRepository.addToAlbum"
      via: "POST handler adds photo to album"
      pattern: "photoRepository\\.addToAlbum"
    - from: "src/app/api/admin/photos/[id]/albums/route.ts"
      to: "photoRepository.removeFromAlbum"
      via: "DELETE handler removes photo from album"
      pattern: "photoRepository\\.removeFromAlbum"
---

<objective>
Create API endpoints for managing photo-album relationships (many-to-many).

Purpose: Enable assigning photos to multiple albums - required for album-based organization.
Output: GET/POST/DELETE routes for /api/admin/photos/[id]/albums, repository methods for album membership.
</objective>

<execution_context>
@/Users/arxherre/.claude/get-shit-done/workflows/execute-plan.md
@/Users/arxherre/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-photo-management/05-CONTEXT.md

@src/infrastructure/database/schema.ts
@src/infrastructure/database/repositories/SQLitePhotoRepository.ts
@src/domain/repositories/PhotoRepository.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend PhotoRepository with album methods</name>
  <files>
    src/domain/repositories/PhotoRepository.ts
    src/infrastructure/database/repositories/SQLitePhotoRepository.ts
  </files>
  <action>
**Update PhotoRepository interface** with album membership methods:
```typescript
getAlbumIds(photoId: string): Promise<string[]>;
addToAlbum(photoId: string, albumId: string): Promise<void>;
removeFromAlbum(photoId: string, albumId: string): Promise<void>;
```

**Implement in SQLitePhotoRepository:**

`getAlbumIds(photoId)`:

- Query photoAlbums table for all albumIds where photoId matches
- Return array of album IDs

`addToAlbum(photoId, albumId)`:

- Insert into photoAlbums table
- Use onConflictDoNothing (idempotent - adding twice doesn't error)
- Default sortOrder to 0

`removeFromAlbum(photoId, albumId)`:

- Delete from photoAlbums where both photoId and albumId match

Import photoAlbums from schema.ts (already imported for findByAlbumId).
</action>
<verify>
`npx tsc --noEmit` - TypeScript compiles
</verify>
<done>
PhotoRepository interface has album methods, SQLitePhotoRepository implements them using photoAlbums join table.
</done>
</task>

<task type="auto">
  <name>Task 2: Create album assignment API routes</name>
  <files>src/app/api/admin/photos/[id]/albums/route.ts</files>
  <action>
Create Next.js route handler at `src/app/api/admin/photos/[id]/albums/route.ts`:

**GET handler (list albums for photo):**

1. Verify admin session
2. Get photoId from params
3. Call `photoRepository.getAlbumIds(photoId)`
4. Return `{ albumIds: string[] }`

**POST handler (add photo to album):**

1. Verify admin session
2. Get photoId from params
3. Parse JSON body expecting `{ albumId: string }`
4. Verify photo exists (return 404 if not)
5. Call `photoRepository.addToAlbum(photoId, albumId)`
6. Return 201 with `{ success: true }`

**DELETE handler (remove photo from album):**

1. Verify admin session
2. Get photoId from params
3. Parse JSON body expecting `{ albumId: string }`
4. Call `photoRepository.removeFromAlbum(photoId, albumId)`
5. Return 204 No Content

Note: DELETE uses request body for albumId (not URL param) to keep route structure simple.
All handlers return 401 for unauthenticated requests.
</action>
<verify>

1. `npm run lint` passes
2. `npm run build` completes
3. Manual test with curl (after creating test data):

   ```bash
   # Get albums for photo
   curl http://localhost:3000/api/admin/photos/test-id/albums -b "session=..."

   # Add photo to album
   curl -X POST http://localhost:3000/api/admin/photos/test-id/albums \
     -H "Content-Type: application/json" \
     -d '{"albumId": "album-1"}' \
     -b "session=..."
   ```

     </verify>
     <done>
   GET returns albumIds array, POST adds photo-album link (idempotent), DELETE removes link.
   All endpoints verify session and return proper status codes.
     </done>
   </task>

</tasks>

<verification>
- [ ] `npm run lint` passes
- [ ] `npm run build` completes
- [ ] PhotoRepository interface updated with album methods
- [ ] SQLitePhotoRepository implements album methods using photoAlbums table
- [ ] All three handlers (GET, POST, DELETE) verify session
</verification>

<success_criteria>

1. GET /api/admin/photos/[id]/albums returns list of album IDs
2. POST /api/admin/photos/[id]/albums adds photo to specified album
3. DELETE /api/admin/photos/[id]/albums removes photo from specified album
4. Adding photo to same album twice does not error (idempotent)
5. All endpoints return 401 for unauthenticated requests
   </success_criteria>

<output>
After completion, create `.planning/phases/05-photo-management/05-02-SUMMARY.md`
</output>
