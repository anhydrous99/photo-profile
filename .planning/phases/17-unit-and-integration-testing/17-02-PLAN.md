---
phase: 17-unit-and-integration-testing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/infrastructure/services/__tests__/imageService.test.ts
  - src/infrastructure/services/__tests__/exifService.test.ts
  - src/infrastructure/auth/__tests__/auth.test.ts
autonomous: true

must_haves:
  truths:
    - "Image service generates WebP and AVIF derivatives at correct sizes for images larger than the smallest thumbnail tier"
    - "Image service skips derivative generation for images smaller than all thumbnail tiers (no upscaling)"
    - "Blur placeholder generation produces a valid base64 data URL"
    - "EXIF extraction returns correct camera/lens/exposure data from fixture images with EXIF"
    - "EXIF extraction returns null for images without EXIF data"
    - "JWT encrypt produces a valid 3-part token, decrypt verifies it, tampered tokens are rejected"
    - "Password hashing produces bcrypt format, verification accepts correct password and rejects wrong password"
  artifacts:
    - path: "src/infrastructure/services/__tests__/imageService.test.ts"
      provides: "Image service derivative generation and blur placeholder tests"
      min_lines: 80
    - path: "src/infrastructure/services/__tests__/exifService.test.ts"
      provides: "EXIF extraction tests with fixture images"
      min_lines: 40
    - path: "src/infrastructure/auth/__tests__/auth.test.ts"
      provides: "JWT session and password auth tests"
      min_lines: 80
  key_links:
    - from: "src/infrastructure/services/__tests__/imageService.test.ts"
      to: "src/infrastructure/services/imageService.ts"
      via: "direct import of generateDerivatives, generateBlurPlaceholder"
      pattern: "import.*generateDerivatives"
    - from: "src/infrastructure/auth/__tests__/auth.test.ts"
      to: "src/infrastructure/auth/session.ts"
      via: "direct import of encrypt, decrypt"
      pattern: "import.*encrypt.*decrypt"
---

<objective>
Write unit tests for image services (derivative generation, blur placeholders, EXIF extraction) and auth utilities (JWT encrypt/decrypt, password hash/verify).

Purpose: Satisfies UNIT-03 (image service tests) and UNIT-04 (auth tests) from the phase requirements. Image tests use fixture images and runtime-generated larger images. Auth tests exercise pure functions with the test AUTH_SECRET from vitest.config.ts.

Output: Three test files covering image pipeline and auth lifecycle with all assertions passing.
</objective>

<execution_context>
@/Users/arxherre/.claude/get-shit-done/workflows/execute-plan.md
@/Users/arxherre/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-testing-infrastructure/15-02-SUMMARY.md
@.planning/phases/17-unit-and-integration-testing/17-RESEARCH.md

# Source files to test

@src/infrastructure/services/imageService.ts
@src/infrastructure/services/exifService.ts
@src/infrastructure/auth/session.ts
@src/infrastructure/auth/password.ts

# Test infrastructure

@src/**tests**/fixtures/generate-fixtures.ts
@vitest.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write image service and EXIF service tests</name>
  <files>
    src/infrastructure/services/__tests__/imageService.test.ts
    src/infrastructure/services/__tests__/exifService.test.ts
  </files>
  <action>
**imageService.test.ts:**

Import `generateDerivatives`, `generateBlurPlaceholder`, `getImageMetadata`, and `THUMBNAIL_SIZES` from `@/infrastructure/services/imageService`.

Use `fs/promises` (mkdtemp, readdir, rm) and `os` (tmpdir) for temp directory management. Use `sharp` to create a runtime test image.

**Setup:**

- In `beforeAll`: Create a 400x300 JPEG image using `sharp({ create: { width: 400, height: 300, channels: 3, background: { r: 128, g: 128, b: 128 } } }).jpeg({ quality: 80 }).toFile(largeFixturePath)`. Store in a temp directory.
- In `afterAll`: Clean up the temp directory containing the large fixture.
- Define `fixturesDir` as `path.join(process.cwd(), "src/__tests__/fixtures")` for the existing tiny fixtures.

**Test cases:**

1. **getImageMetadata:**
   - Returns correct width/height for tiny-landscape.jpg (8x6)
   - Returns correct format ("jpeg") for tiny-landscape.jpg

2. **generateDerivatives with tiny fixture (8px wide):**
   - Returns empty array (all THUMBNAIL_SIZES exceed 8px, no upscaling)
   - Output directory exists but is empty (no files written)

3. **generateDerivatives with 400px-wide image:**
   - Returns 2 paths (300w.webp + 300w.avif -- only 300 fits under 400)
   - Output directory contains exactly "300w.webp" and "300w.avif"
   - Each output file is a valid image (readable by sharp.metadata())
   - WebP file has format "webp", AVIF file has format "heif" (Sharp reports AVIF as heif)
   - Output image width is 300 (resize worked)

4. **generateBlurPlaceholder:**
   - Returns a string starting with "data:image/webp;base64,"
   - Result is under 500 bytes (tiny LQIP)
   - Works with tiny-landscape.jpg fixture

5. **THUMBNAIL_SIZES export:**
   - Equals `[300, 600, 1200, 2400]`

Use `beforeEach`/`afterEach` for per-test output directories (mkdtemp/rm).

**exifService.test.ts:**

Import `extractExifData` from `@/infrastructure/services/exifService`.

**Test cases:**

1. **EXIF extraction from tiny-landscape.jpg:**
   - Returns non-null ExifData
   - `cameraMake` is "TestCamera" (set by generate-fixtures.ts)
   - `cameraModel` is "TestModel X100" (set by generate-fixtures.ts)
   - All 11 ExifData fields are present as keys (some may be null)

2. **EXIF extraction from tiny-portrait.jpg:**
   - Returns non-null ExifData
   - `cameraMake` is "AnotherBrand"
   - `cameraModel` is "Pro 50"

3. **No EXIF from tiny-no-exif.png:**
   - Returns null

4. **Non-existent file:**
   - Returns null (error is caught gracefully, not thrown)
     </action>
     <verify>

```bash
npx vitest run src/infrastructure/services/__tests__/imageService.test.ts
npx vitest run src/infrastructure/services/__tests__/exifService.test.ts
```

Both pass with no failures.
</verify>
<done>
Image service tests verify derivative generation for both undersized (no output) and adequately sized (WebP+AVIF at 300w) images. Blur placeholder produces valid base64 data URL. EXIF extraction returns correct Make/Model from fixture JPEG files and null from PNG without EXIF.
</done>
</task>

<task type="auto">
  <name>Task 2: Write auth session and password tests</name>
  <files>src/infrastructure/auth/__tests__/auth.test.ts</files>
  <action>
Create `src/infrastructure/auth/__tests__/auth.test.ts`.

Import `encrypt`, `decrypt` from `@/infrastructure/auth/session`.
Import `hashPassword`, `verifyPassword` from `@/infrastructure/auth/password`.

Note: `session.ts` imports `server-only` which is mocked globally by setup.ts. The `env.AUTH_SECRET` is set by vitest.config.ts to `"test-secret-key-must-be-at-least-32-chars-long!!"`. These tests exercise pure async functions.

**JWT Session tests (`describe("Session")`)**:

1. **encrypt returns JWT format:**
   - Call `encrypt({ isAdmin: true, expiresAt: new Date(Date.now() + 3600000) })`
   - Result starts with "eyJ" (base64-encoded JSON header)
   - Result has exactly 3 dot-separated parts (header.payload.signature)

2. **decrypt verifies valid token:**
   - Encrypt a payload, then decrypt it
   - Result is not null
   - Result has `isAdmin` equal to `true`

3. **decrypt returns null for tampered token:**
   - Encrypt a valid token, change last 5 chars to "XXXXX"
   - `decrypt(tampered)` returns null

4. **decrypt returns null for completely invalid string:**
   - `decrypt("not-a-jwt")` returns null

5. **decrypt returns null for expired token:**
   - Use `jose` directly to create a token with the SAME secret key (`test-secret-key-must-be-at-least-32-chars-long!!`) but `setExpirationTime("0s")` (already expired)
   - `decrypt(expiredToken)` returns null
   - IMPORTANT: Must use the same key as `session.ts` uses (from `env.AUTH_SECRET`), otherwise the signature won't match and you'd be testing wrong-key rejection, not expiry rejection

6. **encrypt/decrypt round-trip preserves expiresAt as ISO string:**
   - Encrypt with known expiresAt Date, decrypt, verify the expiresAt field exists in result (jose serializes Date to ISO string in JWT payload)

**Password tests (`describe("Password")`)**:

7. **hashPassword returns bcrypt format:**
   - `hashPassword("test-password")` returns string starting with "$2b$10$"
   - Result has length 60 (standard bcrypt hash length)

8. **verifyPassword accepts correct password:**
   - Hash "test-password" using `hashPassword`, then set `process.env.ADMIN_PASSWORD_HASH` to the hash
   - Call `verifyPassword("test-password")` -- returns true
   - NOTE: `verifyPassword` reads `env.ADMIN_PASSWORD_HASH`. The vitest.config has a placeholder hash. For this test, override the env var with a real hash. Use the approach: hash first, then mock env inline, or call bcrypt.compare directly.
   - SIMPLEST approach: don't test `verifyPassword` against env (it's a thin wrapper). Instead test `hashPassword` + direct `bcrypt.compare`:
     ```typescript
     const hash = await hashPassword("my-password");
     const isValid = await bcrypt.compare("my-password", hash);
     expect(isValid).toBe(true);
     ```

9. **verifyPassword rejects wrong password:**
   - Hash "correct-password", compare with "wrong-password" via bcrypt.compare, returns false

10. **hashPassword generates unique hashes for same input (salt):**
    - Hash the same password twice, the two hashes should differ (bcrypt uses random salt)
      </action>
      <verify>

```bash
npx vitest run src/infrastructure/auth/__tests__/auth.test.ts
```

All tests pass with no failures.
</verify>
<done>
JWT tests verify encrypt produces valid format, decrypt accepts valid tokens and rejects tampered/expired/invalid tokens. Password tests verify bcrypt hashing format, correct password acceptance, wrong password rejection, and salt uniqueness.
</done>
</task>

</tasks>

<verification>
```bash
# Run all three test files from this plan
npx vitest run src/infrastructure/services/__tests__/ src/infrastructure/auth/__tests__/

# Run full test suite to ensure no regressions

npx vitest run

```
</verification>

<success_criteria>
1. Image service tests pass: derivative generation produces correct files for 400px image, skips for 8px image, blur placeholder returns valid data URL
2. EXIF service tests pass: correct extraction from JPEG fixtures, null from PNG, null from missing file
3. Auth tests pass: JWT encrypt/decrypt lifecycle, tampered/expired rejection, bcrypt hash/verify
4. Full test suite passes with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/17-unit-and-integration-testing/17-02-SUMMARY.md`
</output>
```
