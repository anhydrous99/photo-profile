---
phase: 17-unit-and-integration-testing
plan: 03
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - src/app/api/__tests__/admin-photos.test.ts
  - src/app/api/__tests__/admin-albums.test.ts
autonomous: true

must_haves:
  truths:
    - "Admin photo API endpoints return 401 when verifySession returns null"
    - "Admin album API endpoints return 401 when verifySession returns null"
    - "API endpoints return 400 with { error: 'Validation failed' } for invalid request bodies"
    - "Photo PATCH returns 404 for non-existent photo ID"
    - "Album POST returns 201 with created album for valid input"
    - "Album DELETE returns 204 on success"
  artifacts:
    - path: "src/app/api/__tests__/admin-photos.test.ts"
      provides: "Photo API route integration tests (auth, validation, CRUD responses)"
      min_lines: 100
    - path: "src/app/api/__tests__/admin-albums.test.ts"
      provides: "Album API route integration tests (auth, validation, CRUD responses)"
      min_lines: 100
  key_links:
    - from: "src/app/api/__tests__/admin-photos.test.ts"
      to: "@/infrastructure/auth"
      via: "vi.mock with mockable verifySession"
      pattern: "vi\\.mock.*infrastructure/auth"
    - from: "src/app/api/__tests__/admin-albums.test.ts"
      to: "@/infrastructure/auth"
      via: "vi.mock with mockable verifySession"
      pattern: "vi\\.mock.*infrastructure/auth"
    - from: "src/app/api/__tests__/admin-photos.test.ts"
      to: "@/infrastructure/database/client"
      via: "vi.mock with lazy getter for test DB"
      pattern: "vi\\.mock.*database/client"
---

<objective>
Write API route integration tests for the admin photo and album endpoints, verifying authentication checks, input validation (Zod), error responses, and successful CRUD operations with real database backing.

Purpose: Satisfies UNIT-05 (API route tests verify invalid input returns 400, unauthenticated requests return 401, valid requests return expected data). Tests call route handler functions directly with constructed NextRequest objects -- no HTTP server needed.

Output: Two test files covering the admin photo and album API routes with all assertions passing.
</objective>

<execution_context>
@/Users/arxherre/.claude/get-shit-done/workflows/execute-plan.md
@/Users/arxherre/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-unit-and-integration-testing/17-01-SUMMARY.md
@.planning/phases/17-unit-and-integration-testing/17-RESEARCH.md

# Route handlers to test

@src/app/api/admin/photos/[id]/route.ts
@src/app/api/admin/photos/[id]/albums/route.ts
@src/app/api/admin/albums/route.ts
@src/app/api/admin/albums/[id]/route.ts
@src/app/api/admin/upload/route.ts

# Auth mock target

@src/infrastructure/auth/index.ts
@src/infrastructure/auth/dal.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write admin photo API route tests</name>
  <files>src/app/api/__tests__/admin-photos.test.ts</files>
  <action>
Create `src/app/api/__tests__/admin-photos.test.ts`.

**Mock setup (top of file, before route imports):**

1. Mock `@/infrastructure/auth` to make `verifySession` controllable:

```typescript
vi.mock("@/infrastructure/auth", async (importOriginal) => {
  const actual = await importOriginal<typeof import("@/infrastructure/auth")>();
  return { ...actual, verifySession: vi.fn() };
});
```

2. Mock `@/infrastructure/database/client` with lazy getter (same pattern as 17-01) to inject test DB for route handlers that instantiate repositories at module level.

3. Mock `@/infrastructure/storage` to prevent filesystem operations:

```typescript
vi.mock("@/infrastructure/storage", () => ({
  deletePhotoFiles: vi.fn().mockResolvedValue(undefined),
  saveOriginalFile: vi.fn().mockResolvedValue("/tmp/test/original.jpg"),
}));
```

4. Mock `@/infrastructure/jobs` to prevent Redis operations:

```typescript
vi.mock("@/infrastructure/jobs", () => ({
  enqueueImageProcessing: vi.fn().mockResolvedValue("mock-job-id"),
}));
```

**After mocks, import:**

- `verifySession` from `@/infrastructure/auth`
- Route handlers: `PATCH`, `DELETE` from `@/app/api/admin/photos/[id]/route`
- Route handlers: `GET`, `POST`, `DELETE` as album route handlers from `@/app/api/admin/photos/[id]/albums/route`
- `NextRequest` from `next/server`
- `createTestDb` from `@/__tests__/helpers/test-db`
- Schema from `@/infrastructure/database/schema`

**Helper function:**

```typescript
function makeJsonRequest(
  url: string,
  method: string,
  body?: unknown,
): NextRequest {
  return new NextRequest(url, {
    method,
    ...(body
      ? {
          body: JSON.stringify(body),
          headers: { "Content-Type": "application/json" },
        }
      : {}),
  });
}
```

**Remember: `params` must be `Promise.resolve({ id: "..." })`** for Next.js 16 route handlers.

In `beforeEach`: create fresh testDb/testSqlite, set `vi.mocked(verifySession).mockResolvedValue({ isAuth: true })` as default (authenticated).
In `afterEach`: `testSqlite.close()`, `vi.restoreAllMocks()`.

**Test cases for PATCH /api/admin/photos/[id]:**

1. Returns 401 when unauthenticated (verifySession returns null)
2. Returns 404 for non-existent photo ID
3. Returns 400 for invalid body (missing required "description" field -- send `{ invalid: "field" }`)
   - Response body has `error: "Validation failed"`
4. Returns 200 with updated photo for valid request
   - First insert a photo into testDb using Drizzle (or via the photo repo)
   - Send PATCH with `{ description: "Updated desc" }`
   - Verify response status 200 and response body has description "Updated desc"

**Test cases for DELETE /api/admin/photos/[id]:**

5. Returns 401 when unauthenticated
6. Returns 404 for non-existent photo ID
7. Returns 204 on successful delete
   - Insert a photo first, then delete it

**Test cases for GET /api/admin/photos/[id]/albums:**

8. Returns 401 when unauthenticated
9. Returns 200 with albumIds array

**Test cases for POST /api/admin/photos/[id]/albums:**

10. Returns 401 when unauthenticated
11. Returns 400 for invalid body (missing albumId)
    - Response has `error: "Validation failed"`
12. Returns 404 for non-existent photo ID
13. Returns 201 on success (insert photo and album first, then add photo to album)
    </action>
    <verify>

```bash
npx vitest run src/app/api/__tests__/admin-photos.test.ts
```

All tests pass with no failures.
</verify>
<done>
Admin photo API routes tested: PATCH returns 401/404/400/200 correctly, DELETE returns 401/404/204 correctly, album association endpoints return proper status codes with correct auth and validation behavior.
</done>
</task>

<task type="auto">
  <name>Task 2: Write admin album API route tests</name>
  <files>src/app/api/__tests__/admin-albums.test.ts</files>
  <action>
Create `src/app/api/__tests__/admin-albums.test.ts`.

**Mock setup (same pattern as Task 1):**

- Mock `@/infrastructure/auth` with controllable `verifySession`
- Mock `@/infrastructure/database/client` with lazy getter for testDb
- Mock `@/infrastructure/storage` (deletePhotoFiles needed for album DELETE with photos)
- Mock `next/cache` already handled globally (revalidatePath used in album DELETE)

**Import after mocks:**

- `GET`, `POST` from `@/app/api/admin/albums/route`
- `PATCH`, `DELETE` from `@/app/api/admin/albums/[id]/route`
- `verifySession` from `@/infrastructure/auth`
- `NextRequest` from `next/server`
- createTestDb, schema

Same `makeJsonRequest` helper. Same beforeEach/afterEach pattern.

**Test cases for GET /api/admin/albums:**

1. Returns 401 when unauthenticated
2. Returns 200 with empty array when no albums exist
3. Returns 200 with albums including photoCount field
   - Insert 2 albums and some photos with junction entries
   - Verify response array has correct album data and photoCount values

**Test cases for POST /api/admin/albums:**

4. Returns 401 when unauthenticated
5. Returns 400 for invalid body (empty title: `{ title: "" }` -- min(1) fails)
   - Response has `error: "Validation failed"`
6. Returns 400 for missing title (send `{}`)
7. Returns 201 with created album for valid input
   - Send `{ title: "New Album" }`
   - Verify response has title "New Album", id exists, sortOrder is 1, isPublished is false
8. Returns 201 and assigns incrementing sortOrder
   - Create two albums sequentially, second should have sortOrder 2

**Test cases for PATCH /api/admin/albums/[id]:**

9. Returns 401 when unauthenticated
10. Returns 404 for non-existent album ID
11. Returns 400 for invalid body (title too long -- string of 101 chars)
12. Returns 200 with updated album for valid partial update
    - Insert album, PATCH with `{ title: "Updated" }`, verify title changed but description unchanged

**Test cases for DELETE /api/admin/albums/[id]:**

13. Returns 401 when unauthenticated
14. Returns 404 for non-existent album ID
15. Returns 204 on successful delete (album-only, no photo deletion)
    - Insert album, DELETE with `{ deletePhotos: false }` or empty body
16. Returns 204 when deleting with photos
    - Insert album with photos, DELETE with `{ deletePhotos: true }`
      </action>
      <verify>

```bash
npx vitest run src/app/api/__tests__/admin-albums.test.ts
```

All tests pass with no failures.
</verify>
<done>
Admin album API routes tested: GET returns 401/200 correctly with photoCount, POST validates input and returns 400/201, PATCH validates and returns 401/404/400/200, DELETE handles both modes and returns 401/404/204. All responses match the expected { error: string } pattern on failures.
</done>
</task>

</tasks>

<verification>
```bash
# Run both API test files
npx vitest run src/app/api/__tests__/

# Run full test suite to ensure no regressions

npx vitest run

# Verify test count increased

npx vitest run 2>&1 | tail -5

```
</verification>

<success_criteria>
1. All admin photo API route tests pass (auth, validation, CRUD operations)
2. All admin album API route tests pass (auth, validation, CRUD operations)
3. Every admin endpoint returns 401 when verifySession is null
4. Every endpoint with Zod validation returns 400 with `{ error: "Validation failed" }` for invalid input
5. Full test suite passes with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/17-unit-and-integration-testing/17-03-SUMMARY.md`
</output>
```
