---
phase: 16-error-boundaries-api-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/admin/photos/[id]/route.ts
  - src/app/api/admin/photos/[id]/albums/route.ts
  - src/app/api/admin/albums/route.ts
  - src/app/api/admin/albums/[id]/route.ts
  - src/app/api/admin/albums/reorder/route.ts
  - src/app/api/admin/albums/[id]/photos/reorder/route.ts
  - src/app/api/admin/upload/route.ts
  - src/app/api/images/[photoId]/[filename]/route.ts
  - src/infrastructure/config/env.ts
autonomous: true

must_haves:
  truths:
    - "Every API route validates input with Zod and returns consistent { error: string } JSON on failure"
    - "No API route exposes raw stack traces or internal error messages to clients"
    - "All API routes have top-level try/catch returning 500 with generic message on unexpected errors"
    - "Routes previously using .flatten() now use z.flattenError()"
    - "Upload route rejects files over 25MB before reading into memory"
    - "Upload route logs Redis/queue failures with photoId instead of silently swallowing"
  artifacts:
    - path: "src/app/api/admin/photos/[id]/route.ts"
      provides: "Zod-validated PATCH + try/catch wrapped PATCH and DELETE"
      contains: "z.object"
    - path: "src/app/api/admin/photos/[id]/albums/route.ts"
      provides: "Zod-validated POST/DELETE + try/catch wrapped GET/POST/DELETE"
      contains: "z.object"
    - path: "src/app/api/admin/albums/route.ts"
      provides: "try/catch on GET/POST + flattenError migration"
      contains: "z.flattenError"
    - path: "src/app/api/admin/albums/[id]/route.ts"
      provides: "try/catch on PATCH/DELETE + flattenError migration"
      contains: "z.flattenError"
    - path: "src/app/api/admin/albums/reorder/route.ts"
      provides: "try/catch on POST + flattenError migration"
      contains: "z.flattenError"
    - path: "src/app/api/admin/albums/[id]/photos/reorder/route.ts"
      provides: "try/catch on POST + flattenError migration"
      contains: "z.flattenError"
    - path: "src/app/api/admin/upload/route.ts"
      provides: "Content-Length + file.size checks, queue failure logging"
      contains: "MAX_FILE_SIZE"
    - path: "src/app/api/images/[photoId]/[filename]/route.ts"
      provides: "Top-level try/catch catching re-thrown errors"
      contains: "console.error"
    - path: "src/infrastructure/config/env.ts"
      provides: "flattenError migration for env validation"
      contains: "z.flattenError"
  key_links:
    - from: "src/app/api/admin/photos/[id]/route.ts"
      to: "zod"
      via: "safeParse for PATCH body"
      pattern: "safeParse"
    - from: "src/app/api/admin/upload/route.ts"
      to: "content-length header"
      via: "early reject before formData()"
      pattern: "content-length"
    - from: "src/app/api/admin/upload/route.ts"
      to: "console.error"
      via: "queue failure logging with photoId"
      pattern: "console\\.error.*enqueue"
---

<objective>
Add Zod validation to the 3 routes using raw type assertions, wrap all 14 API handlers in try/catch with consistent error responses, migrate deprecated .flatten() calls to z.flattenError(), and add upload safeguards (file size limit + queue failure logging).

Purpose: Every API failure returns a consistent, safe JSON error response. No stack traces leak. Uploads are protected against oversized files and silent queue failures.
Output: 9 modified API route files covering ERR-08, ERR-09, ERR-10, ERR-11.
</objective>

<execution_context>
@/Users/arxherre/.claude/get-shit-done/workflows/execute-plan.md
@/Users/arxherre/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-error-boundaries-api-hardening/16-RESEARCH.md
@src/app/api/admin/photos/[id]/route.ts
@src/app/api/admin/photos/[id]/albums/route.ts
@src/app/api/admin/albums/route.ts
@src/app/api/admin/albums/[id]/route.ts
@src/app/api/admin/albums/reorder/route.ts
@src/app/api/admin/albums/[id]/photos/reorder/route.ts
@src/app/api/admin/upload/route.ts
@src/app/api/images/[photoId]/[filename]/route.ts
@src/infrastructure/config/env.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Zod schemas and try/catch to photo routes + upload safeguards</name>
  <files>
    src/app/api/admin/photos/[id]/route.ts
    src/app/api/admin/photos/[id]/albums/route.ts
    src/app/api/admin/upload/route.ts
  </files>
  <action>
**Consistent error response pattern for ALL handlers in this task:**
- Validation failures: `{ error: "Validation failed", details: flat.fieldErrors }` with status 400
- Not found: `{ error: "Photo not found" }` with status 404
- Unauthorized: `{ error: "Unauthorized" }` with status 401 (already present, keep as-is)
- Server errors: `{ error: "Internal server error" }` with status 500
- Log format: `console.error("[API] METHOD /api/route-path:", error)`

**src/app/api/admin/photos/[id]/route.ts** (ERR-08, ERR-09):

1. Add `import { z } from "zod"` at the top
2. Add schema above handlers:
   ```
   const updatePhotoSchema = z.object({
     description: z.string().nullable(),
   });
   ```
3. PATCH handler: Replace `const { description } = body as { description: string | null }` with:
   - `const body = await request.json()`
   - `const result = updatePhotoSchema.safeParse(body)`
   - If `!result.success`: return 400 with `{ error: "Validation failed", details: z.flattenError(result.error).fieldErrors }`
   - Use `result.data.description` instead of `body.description`
4. Wrap BOTH PATCH and DELETE handlers' entire bodies in try/catch:
   - catch: `console.error("[API] PATCH /api/admin/photos/[id]:", error)` (or DELETE), return 500

**src/app/api/admin/photos/[id]/albums/route.ts** (ERR-08, ERR-09):

1. Add `import { z } from "zod"` at the top
2. Add schema:
   ```
   const albumIdSchema = z.object({
     albumId: z.string().min(1),
   });
   ```
3. POST handler: Replace the raw `as { albumId?: string }` + manual check with:
   - `const body = await request.json()`
   - `const result = albumIdSchema.safeParse(body)`
   - If `!result.success`: return 400 with flattenError details
   - Use `result.data.albumId`
4. DELETE handler: Same Zod replacement as POST
5. Wrap ALL THREE handlers (GET, POST, DELETE) in try/catch with appropriate logging

**src/app/api/admin/upload/route.ts** (ERR-09, ERR-10, ERR-11):

1. Add file size constant at top: `const MAX_FILE_SIZE = 25 * 1024 * 1024; // 25MB`
2. Add multipart overhead constant: `const MULTIPART_OVERHEAD = 1 * 1024 * 1024; // 1MB`
3. ERR-10: BEFORE `request.formData()`, add Content-Length early reject:
   ```
   const contentLength = parseInt(request.headers.get("content-length") || "0", 10);
   if (contentLength > MAX_FILE_SIZE + MULTIPART_OVERHEAD) {
     return NextResponse.json(
       { error: "File exceeds 25MB limit" },
       { status: 413 }
     );
   }
   ```
4. ERR-10: AFTER formData parsing and getting the file, add exact size check:
   ```
   if (file.size > MAX_FILE_SIZE) {
     return NextResponse.json(
       { error: "File exceeds 25MB limit" },
       { status: 413 }
     );
   }
   ```
5. ERR-11: Replace the empty catch block around enqueue with logged version:
   ```
   catch (error) {
     console.error(
       `[Upload] Failed to enqueue processing for photo ${photoId}:`,
       error instanceof Error ? error.message : error
     );
     // Photo saved with "processing" status - will need manual requeue when Redis is available
   }
   ```
6. ERR-09: Wrap the entire POST handler body in a top-level try/catch (the enqueue try/catch is nested inside):
   - catch: `console.error("[API] POST /api/admin/upload:", error)`, return 500
     </action>
     <verify>
     Run `npm run typecheck` -- no TypeScript errors.
     Run `npm run lint` -- no ESLint errors.
     Verify Zod imports: `grep -n "from \"zod\"" src/app/api/admin/photos/\[id\]/route.ts src/app/api/admin/photos/\[id\]/albums/route.ts`
     Verify no raw type assertions remain: `grep -n "body as {" src/app/api/admin/photos/\[id\]/route.ts src/app/api/admin/photos/\[id\]/albums/route.ts` should return nothing.
     Verify upload size check: `grep -n "MAX_FILE_SIZE" src/app/api/admin/upload/route.ts`
     Verify queue logging: `grep -n "Failed to enqueue" src/app/api/admin/upload/route.ts`
     </verify>
     <done>
     Photos PATCH uses Zod instead of type assertion. Photos/albums POST and DELETE use Zod instead of manual checks. Upload rejects files >25MB via Content-Length pre-check and file.size validation. Queue failures are logged with photoId. All 3 route files have top-level try/catch on every handler.
     </done>
     </task>

<task type="auto">
  <name>Task 2: Add try/catch to album routes, migrate flattenError, and harden image route</name>
  <files>
    src/app/api/admin/albums/route.ts
    src/app/api/admin/albums/[id]/route.ts
    src/app/api/admin/albums/reorder/route.ts
    src/app/api/admin/albums/[id]/photos/reorder/route.ts
    src/app/api/images/[photoId]/[filename]/route.ts
    src/infrastructure/config/env.ts
  </files>
  <action>
**For ALL 4 album route files**, apply the same pattern:

1. **Migrate .flatten() to z.flattenError()**: In every route that has `result.error.flatten()`, replace with `z.flattenError(result.error)` and use `.fieldErrors` from the result. Specifically:
   - `src/app/api/admin/albums/route.ts` POST: change `result.error.flatten()` to `z.flattenError(result.error).fieldErrors`
   - `src/app/api/admin/albums/[id]/route.ts` PATCH: same migration
   - `src/app/api/admin/albums/reorder/route.ts` POST: same migration
   - `src/app/api/admin/albums/[id]/photos/reorder/route.ts` POST: same migration
     Also update the error response shape to be consistent: `{ error: "Validation failed", details: flat.fieldErrors }` (change "Invalid data" to "Validation failed" for consistency across all routes)

2. **Wrap every handler in try/catch**: For each exported handler function (GET, POST, PATCH, DELETE), wrap the entire body in try/catch:
   ```
   try {
     // existing handler code
   } catch (error) {
     console.error("[API] METHOD /api/route-path:", error);
     return NextResponse.json(
       { error: "Internal server error" },
       { status: 500 }
     );
   }
   ```
   Specific handlers to wrap:
   - `/api/admin/albums/route.ts`: GET and POST
   - `/api/admin/albums/[id]/route.ts`: PATCH and DELETE
   - `/api/admin/albums/reorder/route.ts`: POST
   - `/api/admin/albums/[id]/photos/reorder/route.ts`: POST

**src/app/api/images/[photoId]/[filename]/route.ts** (ERR-09):

- The current GET handler has a partial try/catch that re-throws unexpected errors (`throw error` at line 118). Replace this pattern: instead of re-throwing, catch ALL errors at the top level.
- Wrap the entire handler in a single try/catch. Inside, keep the ENOENT-specific fallback logic, but remove the final `throw error` -- instead, log and return a 500 plain text response.
- Keep plain text error responses for this route (not JSON) since consumers are `<img>` tags, not JavaScript clients.
- Log unexpected errors: `console.error("[API] GET /api/images/[photoId]/[filename]:", error)`
- Return: `new NextResponse("Internal server error", { status: 500 })` for non-ENOENT errors

**src/infrastructure/config/env.ts**:

- Change `parsed.error.flatten().fieldErrors` to `z.flattenError(parsed.error).fieldErrors`
- This is the 5th call site for the flatten migration
  </action>
  <verify>
  Run `npm run typecheck` -- no TypeScript errors.
  Run `npm run lint` -- no ESLint errors.
  Verify no deprecated flatten calls remain: `grep -rn "\.error\.flatten()" src/` should return nothing.
  Verify all routes have try/catch: `grep -rn "Internal server error" src/app/api/` should show all 8 route files.
  Verify image route no longer re-throws: `grep -n "throw error" src/app/api/images/\[photoId\]/\[filename\]/route.ts` should return nothing.
  Run `npm run build` -- successful build.
  </verify>
  <done>
  All 4 album routes have try/catch on every handler. All deprecated .flatten() calls migrated to z.flattenError() across 5 files. Image route catches all errors without re-throwing. Every API route in the project now has consistent error handling: Zod validation returns 400, auth returns 401, not-found returns 404, unexpected errors return 500 with logged details.
  </done>
  </task>

</tasks>

<verification>
- `npm run typecheck` passes
- `npm run lint` passes
- `npm run build` succeeds
- `grep -rn "body as {" src/app/api/` returns zero matches (no raw type assertions)
- `grep -rn "\.error\.flatten()" src/` returns zero matches (all migrated)
- `grep -rn "Internal server error" src/app/api/` returns matches in all 8 route files
- `grep -n "MAX_FILE_SIZE" src/app/api/admin/upload/route.ts` confirms size limit
- `grep -n "Failed to enqueue" src/app/api/admin/upload/route.ts` confirms queue logging
- Image route returns plain text errors (not JSON)
</verification>

<success_criteria>

- 3 routes converted from raw type assertions to Zod validation (ERR-08)
- All 14 API handlers wrapped in try/catch with consistent error responses (ERR-09)
- 5 deprecated .flatten() calls migrated to z.flattenError()
- Upload rejects >25MB files via Content-Length pre-check and file.size post-check (ERR-10)
- Upload logs queue failures with photoId context (ERR-11)
- No stack traces or internal error messages in any API response
- Image route keeps plain text errors for img tag consumers
  </success_criteria>

<output>
After completion, create `.planning/phases/16-error-boundaries-api-hardening/16-02-SUMMARY.md`
</output>
