---
phase: 16-error-boundaries-api-hardening
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/infrastructure/database/repositories/SQLitePhotoRepository.ts
  - src/presentation/components/DropZone.tsx
  - src/app/admin/(protected)/upload/page.tsx
autonomous: true

must_haves:
  truths:
    - "JSON.parse in toDomain() never crashes on corrupt exifData -- returns null instead"
    - "DropZone client-side limit is 25MB, matching server limit"
    - "Files exceeding 25MB are rejected client-side with a toast notification showing the reason"
    - "Multi-file uploads with partial rejections upload valid files and show what failed"
  artifacts:
    - path: "src/infrastructure/database/repositories/SQLitePhotoRepository.ts"
      provides: "Safe JSON.parse wrapper in toDomain()"
      contains: "safeParseJson"
    - path: "src/presentation/components/DropZone.tsx"
      provides: "25MB default maxSize"
      contains: "25 * 1024 * 1024"
    - path: "src/app/admin/(protected)/upload/page.tsx"
      provides: "onFilesRejected handler with toast-style notification"
      contains: "onFilesRejected"
  key_links:
    - from: "src/infrastructure/database/repositories/SQLitePhotoRepository.ts"
      to: "JSON.parse"
      via: "try/catch wrapper in toDomain()"
      pattern: "safeParseJson|try.*JSON\\.parse"
    - from: "src/presentation/components/DropZone.tsx"
      to: "maxSize"
      via: "Default parameter value"
      pattern: "25 \\* 1024 \\* 1024"
    - from: "src/app/admin/(protected)/upload/page.tsx"
      to: "DropZone"
      via: "onFilesRejected prop handling"
      pattern: "onFilesRejected"
---

<objective>
Wrap JSON.parse in repository toDomain() with try/catch, update DropZone to 25MB default, and add file rejection handling to the upload page with toast-style notifications.

Purpose: Corrupt database data doesn't crash page renders. Client-side upload limit matches server-side 25MB limit. Users see clear feedback when files are rejected, with valid files still uploading (per user decision on partial failures).
Output: 3 modified files covering ERR-07 and the locked upload UX decisions.
</objective>

<execution_context>
@/Users/arxherre/.claude/get-shit-done/workflows/execute-plan.md
@/Users/arxherre/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-error-boundaries-api-hardening/16-RESEARCH.md
@src/infrastructure/database/repositories/SQLitePhotoRepository.ts
@src/presentation/components/DropZone.tsx
@src/app/admin/(protected)/upload/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Safe JSON.parse in toDomain()</name>
  <files>
    src/infrastructure/database/repositories/SQLitePhotoRepository.ts
  </files>
  <action>
**ERR-07**: Wrap the JSON.parse call in toDomain() to handle corrupt data gracefully.

In `SQLitePhotoRepository`, add a private helper method:

```typescript
private safeParseExifJson(json: string): Record<string, unknown> | null {
  try {
    return JSON.parse(json) as Record<string, unknown>;
  } catch {
    console.error("[SQLitePhotoRepository] Failed to parse exifData JSON");
    return null;
  }
}
```

Then in the `toDomain()` method, change line 125 from:

```
exifData: row.exifData ? JSON.parse(row.exifData) : null,
```

to:

```
exifData: row.exifData ? this.safeParseExifJson(row.exifData) : null,
```

This ensures a single corrupted row doesn't crash the entire page render (e.g., the homepage that calls findRandomFromPublishedAlbums and maps all results through toDomain).
</action>
<verify>
Run `npm run typecheck` -- no TypeScript errors.
Run `npm run lint` -- no ESLint errors.
Verify no unwrapped JSON.parse in repositories: `grep -n "JSON.parse" src/infrastructure/database/repositories/` should only show the call inside safeParseExifJson's try block.
</verify>
<done>
JSON.parse in toDomain() is wrapped in try/catch. Corrupt exifData returns null instead of crashing. Error is logged with context for debugging.
</done>
</task>

<task type="auto">
  <name>Task 2: DropZone 25MB limit and upload rejection handling</name>
  <files>
    src/presentation/components/DropZone.tsx
    src/app/admin/(protected)/upload/page.tsx
  </files>
  <action>
**Locked user decisions to implement:**
- Oversized file rejection: show a toast notification with the rejection reason (e.g., "File exceeds 25MB limit"), upload area resets
- Multi-file uploads with partial failures: upload the valid files, show a summary of what failed and why (don't reject the entire batch)

**src/presentation/components/DropZone.tsx**:

1. Change default `maxSize` from `100 * 1024 * 1024` to `25 * 1024 * 1024` (25MB)
2. Update the help text at the bottom from "JPEG, PNG, WebP, HEIC up to 100MB each" to "JPEG, PNG, WebP, HEIC up to 25MB each"
3. No other changes needed -- the component already accepts `onFilesRejected` prop and calls it correctly. The DropZone already handles partial rejections correctly: `onDrop` receives both `acceptedFiles` and `rejections` separately, calls `onFilesAccepted` with accepted files and `onFilesRejected` with rejected ones.

**src/app/admin/(protected)/upload/page.tsx**:

1. Add a state for rejection messages: `const [rejections, setRejections] = useState<string[]>([]);`
2. Add a `handleFilesRejected` callback that:
   - Maps each `FileRejection` to a human-readable message. For each rejection, extract `rejection.file.name` and `rejection.errors[0].message` (react-dropzone provides error messages like "File is too large"). Build message like: `"${file.name}: ${error.message}"` but clean up the message -- if the error code is "file-too-large", use "exceeds 25MB limit" instead of the raw message.
   - Sets the rejections state with these messages
   - Auto-clears after 8 seconds with a setTimeout (toast-like behavior)
3. Pass `onFilesRejected={handleFilesRejected}` to the `<DropZone>` component (it already supports this prop but the upload page doesn't pass it currently)
4. Render a rejection notification area BETWEEN the DropZone and UploadQueue:
   ```tsx
   {
     rejections.length > 0 && (
       <div className="mt-4 rounded-lg border border-status-error-bg bg-status-error-surface p-4">
         <div className="flex items-start justify-between">
           <div>
             <p className="text-sm font-medium text-status-error-surface-text">
               {rejections.length === 1
                 ? "File rejected"
                 : `${rejections.length} files rejected`}
             </p>
             <ul className="mt-1 text-sm text-status-error-text">
               {rejections.map((msg, i) => (
                 <li key={i}>{msg}</li>
               ))}
             </ul>
           </div>
           <button
             onClick={() => setRejections([])}
             className="ml-4 text-status-error-text hover:text-status-error-surface-text"
             aria-label="Dismiss"
           >
             &times;
           </button>
         </div>
       </div>
     );
   }
   ```
5. Import `FileRejection` type from react-dropzone at the top: `import type { FileRejection } from "react-dropzone";`

Note: The existing behavior already handles partial acceptance correctly. When a user drops 5 files and 2 are too large, react-dropzone calls `onDrop` with 3 accepted and 2 rejected. The DropZone component already passes accepted files to `onFilesAccepted` and rejected to `onFilesRejected` separately. So valid files upload normally while rejected files trigger the notification.
</action>
<verify>
Run `npm run typecheck` -- no TypeScript errors.
Run `npm run lint` -- no ESLint errors.
Verify DropZone 25MB default: `grep -n "25 \* 1024 \* 1024" src/presentation/components/DropZone.tsx`
Verify help text updated: `grep -n "25MB" src/presentation/components/DropZone.tsx`
Verify rejection handler wired: `grep -n "onFilesRejected" src/app/admin/\(protected\)/upload/page.tsx`
Run `npm run build` -- successful build.
</verify>
<done>
DropZone defaults to 25MB (matching server limit). Help text updated to reflect 25MB. Upload page handles file rejections with a dismissible notification showing which files were rejected and why. Valid files in a mixed batch still upload successfully. Notification auto-clears after 8 seconds.
</done>
</task>

</tasks>

<verification>
- `npm run typecheck` passes
- `npm run lint` passes
- `npm run build` succeeds
- No unwrapped JSON.parse in repository toDomain()
- DropZone defaults to 25MB client-side
- Upload page shows rejection notifications for oversized files
- Partial batch uploads work: valid files upload, rejected files show notification
</verification>

<success_criteria>

- JSON.parse in toDomain() wrapped in try/catch, returns null on corrupt data (ERR-07)
- DropZone maxSize aligned to 25MB matching server limit
- File rejection toast notification shows filename and reason
- Multi-file partial failures handled: valid files upload, rejected files notified (locked decision)
- Build succeeds with all changes
  </success_criteria>

<output>
After completion, create `.planning/phases/16-error-boundaries-api-hardening/16-03-SUMMARY.md`
</output>
