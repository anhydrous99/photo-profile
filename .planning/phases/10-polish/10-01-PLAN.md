---
phase: 10-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/domain/entities/Photo.ts
  - src/domain/repositories/PhotoRepository.ts
  - src/infrastructure/database/schema.ts
  - src/infrastructure/database/repositories/SQLitePhotoRepository.ts
  - src/infrastructure/services/imageService.ts
  - src/infrastructure/jobs/workers/imageProcessor.ts
  - scripts/backfill-blur-placeholders.ts
autonomous: true

must_haves:
  truths:
    - "Every newly uploaded photo gets a blurDataUrl generated during processing"
    - "Existing photos in the database have blurDataUrl populated via backfill"
    - "blurDataUrl is a tiny base64 data URL (~100-200 bytes) suitable for inline HTML"
  artifacts:
    - path: "src/domain/entities/Photo.ts"
      provides: "Photo entity with blurDataUrl field"
      contains: "blurDataUrl"
    - path: "src/infrastructure/database/schema.ts"
      provides: "photos table with blur_data_url column"
      contains: "blur_data_url"
    - path: "src/infrastructure/services/imageService.ts"
      provides: "generateBlurPlaceholder function"
      exports: ["generateBlurPlaceholder"]
    - path: "src/infrastructure/jobs/workers/imageProcessor.ts"
      provides: "Worker generates blur placeholder and saves to DB"
      contains: "generateBlurPlaceholder"
    - path: "scripts/backfill-blur-placeholders.ts"
      provides: "One-time script to populate existing photos"
      contains: "backfill"
  key_links:
    - from: "src/infrastructure/jobs/workers/imageProcessor.ts"
      to: "src/infrastructure/services/imageService.ts"
      via: "import generateBlurPlaceholder"
      pattern: "generateBlurPlaceholder"
    - from: "src/infrastructure/jobs/workers/imageProcessor.ts"
      to: "src/infrastructure/database/repositories/SQLitePhotoRepository.ts"
      via: "save photo with blurDataUrl"
      pattern: "photo\\.blurDataUrl"
    - from: "scripts/backfill-blur-placeholders.ts"
      to: "src/infrastructure/services/imageService.ts"
      via: "import generateBlurPlaceholder"
      pattern: "generateBlurPlaceholder"
---

<objective>
Add blur placeholder generation to the image processing pipeline and backfill existing photos.

Purpose: Enable smooth image loading UX by generating tiny base64 LQIP (Low Quality Image Placeholder) images that render instantly in HTML before full images load. This is the data foundation for the frontend fade-in experience.

Output: Updated Photo entity with blurDataUrl field, schema migration, imageService with generateBlurPlaceholder function, worker pipeline integration, and backfill script for existing photos.
</objective>

<execution_context>
@/Users/arxherre/.claude/get-shit-done/workflows/execute-plan.md
@/Users/arxherre/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/domain/entities/Photo.ts
@src/domain/repositories/PhotoRepository.ts
@src/infrastructure/database/schema.ts
@src/infrastructure/database/repositories/SQLitePhotoRepository.ts
@src/infrastructure/services/imageService.ts
@src/infrastructure/jobs/workers/imageProcessor.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add blurDataUrl to schema, entity, and repository</name>
  <files>
    src/domain/entities/Photo.ts
    src/infrastructure/database/schema.ts
    src/infrastructure/database/repositories/SQLitePhotoRepository.ts
  </files>
  <action>
1. Add `blurDataUrl: string | null` to the Photo interface in `src/domain/entities/Photo.ts`.

2. Add `blurDataUrl` column to the photos table in `src/infrastructure/database/schema.ts`:

   ```
   blurDataUrl: text("blur_data_url"),
   ```

3. IMPORTANT: Do NOT use `db:push` to update the database. Per STATE.md lesson about schema migration, run a direct ALTER TABLE statement instead. Create and run the migration:

   ```sql
   ALTER TABLE photos ADD COLUMN blur_data_url TEXT;
   ```

   Execute this via the drizzle client or a small inline script.

4. Update `SQLitePhotoRepository.ts`:
   - Add `blurDataUrl` to the `toDomain` method mapping
   - Add `blurDataUrl` to the `toDatabase` method mapping
   - Both `findRandomFromPublishedAlbums` and `findByAlbumId` already return full Photo objects, so blurDataUrl will be included automatically.

Note: The domain repository interface (`PhotoRepository.ts`) does NOT need changes because it already uses the `Photo` type which will now include `blurDataUrl`.
</action>
<verify>
Run `npm run typecheck` to confirm all types are consistent. Run `npm run build` to verify no build errors. Verify the column exists by checking the database schema.
</verify>
<done>
Photo entity has blurDataUrl field. Database schema has blur_data_url column. Repository maps blurDataUrl in both directions. Existing photos have null blurDataUrl (expected, backfill comes later).
</done>
</task>

<task type="auto">
  <name>Task 2: Add blur placeholder generation to image service and worker pipeline</name>
  <files>
    src/infrastructure/services/imageService.ts
    src/infrastructure/jobs/workers/imageProcessor.ts
    scripts/backfill-blur-placeholders.ts
  </files>
  <action>
1. Add `generateBlurPlaceholder` function to `src/infrastructure/services/imageService.ts`:
   ```typescript
   export async function generateBlurPlaceholder(inputPath: string): Promise<string> {
     const buffer = await sharp(inputPath)
       .rotate()
       .resize(10, null, { fit: "inside" })
       .webp({ quality: 20 })
       .toBuffer();
     return `data:image/webp;base64,${buffer.toString("base64")}`;
   }
   ```
   This creates a ~100-200 byte base64 data URL from a 10px-wide thumbnail.

2. Update the worker in `src/infrastructure/jobs/workers/imageProcessor.ts`:
   - After `generateDerivatives` completes successfully, call `generateBlurPlaceholder` using the original image path (from `job.data.originalPath`).
   - In the `completed` event handler, after setting `photo.status = "ready"`, also set `photo.blurDataUrl = blurDataUrl`.
   - The blur placeholder generation should happen INSIDE the worker job processor (not in the completed handler) so it's part of the job and benefits from retry logic. Pass the blurDataUrl in the job result alongside derivatives.
   - Update the `ImageJobResult` type to include `blurDataUrl: string`.
   - Import `generateBlurPlaceholder` from imageService.

3. Create `scripts/backfill-blur-placeholders.ts` for existing photos:
   - Import db client, photos schema, generateBlurPlaceholder, and env config.
   - Query all photos where blurDataUrl IS NULL.
   - For each photo, use the 300w.webp derivative as source (faster than original): `path.join(env.STORAGE_PATH, "processed", photo.id, "300w.webp")`.
   - Generate blur placeholder and update the database row directly via drizzle `db.update(photos).set({ blurDataUrl }).where(eq(photos.id, photo.id))`.
   - Log progress for each photo.
   - Handle errors gracefully (log and continue to next photo).
   - Run with: `npx tsx scripts/backfill-blur-placeholders.ts`

4. Also update the `ImageJobResult` type in the queue definition file (likely `src/infrastructure/jobs/queues.ts` or similar) to include `blurDataUrl: string`.
   </action>
   <verify>
   Run `npm run typecheck` to confirm types are consistent. Run `npx tsx scripts/backfill-blur-placeholders.ts` to verify the backfill script works (if photos exist in the database, they should get blurDataUrl populated). Check the database to confirm blurDataUrl values are populated and are small base64 strings starting with `data:image/webp;base64,`.
   </verify>
   <done>
   imageService exports generateBlurPlaceholder. Worker generates blur placeholder during image processing and saves it to the photo record. Backfill script successfully populates blurDataUrl for all existing photos. All blurDataUrl values are tiny (~100-200 byte) base64 data URLs.
   </done>
   </task>

</tasks>

<verification>
1. `npm run typecheck` passes
2. `npm run build` passes
3. Photo entity has blurDataUrl: string | null
4. Database photos table has blur_data_url column
5. Backfill script runs and populates existing photos
6. blurDataUrl values start with "data:image/webp;base64," and are under 500 bytes
</verification>

<success_criteria>

- Photo entity and schema include blurDataUrl
- Worker pipeline generates blur placeholder for new uploads
- Backfill script populates existing photos
- All blurDataUrl values are tiny base64 strings suitable for inline HTML
  </success_criteria>

<output>
After completion, create `.planning/phases/10-polish/10-01-SUMMARY.md`
</output>
