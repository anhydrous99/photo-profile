---
phase: 10-polish
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/presentation/components/FadeImage.tsx
  - src/lib/imageLoader.ts
  - next.config.ts
  - src/presentation/components/HomepageClient.tsx
  - src/presentation/components/AlbumGalleryClient.tsx
  - src/app/albums/page.tsx
  - src/app/page.tsx
  - src/app/albums/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Blur placeholder shown while full images load on homepage, album grid, and albums listing"
    - "Smooth ~300ms fade-in transition from placeholder to loaded image (no instant swap)"
    - "No visual layout shift when images load (aspect ratios preserved)"
    - "Images served via custom loader skip Next.js double-optimization"
    - "Hero image uses preload (not deprecated priority prop)"
  artifacts:
    - path: "src/presentation/components/FadeImage.tsx"
      provides: "Shared image component with blur placeholder and fade-in"
      contains: "onLoad"
      min_lines: 20
    - path: "src/lib/imageLoader.ts"
      provides: "Custom next/image loader mapping to existing API route derivatives"
      exports: ["default"]
    - path: "next.config.ts"
      provides: "Custom loader config and standalone output"
      contains: "loaderFile"
  key_links:
    - from: "src/presentation/components/FadeImage.tsx"
      to: "src/lib/imageLoader.ts"
      via: "next/image uses custom loader from next.config.ts"
      pattern: "loader.*custom"
    - from: "src/presentation/components/HomepageClient.tsx"
      to: "src/presentation/components/FadeImage.tsx"
      via: "import FadeImage"
      pattern: "FadeImage"
    - from: "src/presentation/components/AlbumGalleryClient.tsx"
      to: "src/presentation/components/FadeImage.tsx"
      via: "import FadeImage"
      pattern: "FadeImage"
    - from: "src/app/page.tsx"
      to: "blurDataUrl"
      via: "passes blurDataUrl from repository to HomepageClient"
      pattern: "blurDataUrl"
    - from: "src/app/albums/[id]/page.tsx"
      to: "blurDataUrl"
      via: "passes blurDataUrl from repository to AlbumGalleryClient"
      pattern: "blurDataUrl"
---

<objective>
Create the FadeImage component with blur placeholder display and ~300ms fade-in, configure custom image loader to skip double-optimization, and update all public-facing pages to use blur placeholders.

Purpose: Deliver the smooth image loading experience the user wants -- blur placeholders visible instantly, full images fade in over ~300ms. Also configures performance optimizations: custom loader bypasses Next.js image optimizer (images are already pre-processed by Sharp), standalone output for Docker, and preload instead of deprecated priority prop.

Output: FadeImage component, custom image loader, updated next.config.ts, and all public pages passing blurDataUrl to their client components.
</objective>

<execution_context>
@/Users/arxherre/.claude/get-shit-done/workflows/execute-plan.md
@/Users/arxherre/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-polish/10-01-SUMMARY.md
@src/presentation/components/HomepageClient.tsx
@src/presentation/components/AlbumGalleryClient.tsx
@src/presentation/components/PhotoLightbox.tsx
@src/app/page.tsx
@src/app/albums/page.tsx
@src/app/albums/[id]/page.tsx
@next.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create custom image loader, FadeImage component, and update next.config.ts</name>
  <files>
    src/lib/imageLoader.ts
    src/presentation/components/FadeImage.tsx
    next.config.ts
  </files>
  <action>
1. Create `src/lib/imageLoader.ts` - Custom loader that maps next/image width requests to existing pre-processed derivatives:
   ```typescript
   const AVAILABLE_WIDTHS = [300, 600, 1200, 2400];
   export default function imageLoader({ src, width }: { src: string; width: number; quality?: number }): string {
     const bestWidth = AVAILABLE_WIDTHS.find((w) => w >= width) ?? AVAILABLE_WIDTHS[AVAILABLE_WIDTHS.length - 1];
     return `${src}/${bestWidth}w.webp`;
   }
   ```
   The `src` prop will be `/api/images/{photoId}` and the loader appends the best derivative filename.

2. Create `src/presentation/components/FadeImage.tsx` - A "use client" component that:
   - Accepts props: `photoId: string`, `alt: string`, `blurDataUrl?: string | null`, `sizes: string`, `preload?: boolean`, `className?: string`
   - Uses `useState` to track loaded state
   - Renders a relative container with `overflow-hidden`
   - If blurDataUrl exists, renders a tiny `<img>` as blur background with `absolute inset-0`, `scale-110`, `blur-lg`, `object-cover` classes, `aria-hidden="true"`
   - Renders `next/image` with `fill`, `sizes`, the custom loader (via next.config, not explicitly), `object-cover`, and a CSS transition: `transition-opacity duration-300`, starting at `opacity-0` and switching to `opacity-100` on load via `onLoad` callback
   - Uses `preload` prop (not `priority` -- deprecated in Next.js 16) when preload is true
   - The `src` should be `/api/images/${photoId}` (the custom loader will append the width derivative)

3. Update `next.config.ts`:
   ```typescript
   import type { NextConfig } from "next";
   const nextConfig: NextConfig = {
     output: "standalone",
     images: {
       loader: "custom",
       loaderFile: "./src/lib/imageLoader.ts",
     },
   };
   export default nextConfig;
   ```
   The `output: "standalone"` is needed for Docker (Plan 03). The custom loader prevents double-optimization of already-processed Sharp images.
   </action>
   <verify>
   Run `npm run typecheck` to verify types. Run `npm run build` to verify next.config changes work and the custom loader is picked up. Verify no warnings about deprecated `priority` prop.
   </verify>
   <done>
   Custom image loader maps width requests to pre-processed derivatives. FadeImage component renders blur placeholder with ~300ms fade-in transition. next.config.ts configures custom loader and standalone output.
   </done>
   </task>

<task type="auto">
  <name>Task 2: Update all public pages to pass blurDataUrl and use FadeImage</name>
  <files>
    src/app/page.tsx
    src/app/albums/[id]/page.tsx
    src/app/albums/page.tsx
    src/presentation/components/HomepageClient.tsx
    src/presentation/components/AlbumGalleryClient.tsx
  </files>
  <action>
1. Update `src/app/page.tsx` (Homepage server component):
   - Include `blurDataUrl` in the photo data passed to HomepageClient:
     ```typescript
     photos={photos.map((p) => ({
       id: p.id,
       title: p.title,
       description: p.description,
       originalFilename: p.originalFilename,
       blurDataUrl: p.blurDataUrl,
     }))}
     ```

2. Update `src/presentation/components/HomepageClient.tsx`:
   - Add `blurDataUrl: string | null` to the PhotoData interface
   - Replace all `<Image>` tags with `<FadeImage>` component
   - Hero photo: `<FadeImage photoId={heroPhoto.id} alt={...} blurDataUrl={heroPhoto.blurDataUrl} sizes="(max-width: 1280px) 100vw, 1152px" preload />`
   - Grid photos: `<FadeImage photoId={photo.id} alt={...} blurDataUrl={photo.blurDataUrl} sizes="(max-width: 768px) 50vw, 33vw" />`
   - Remove the `priority` import/usage (replaced by `preload` in FadeImage)
   - Remove `import Image from "next/image"` (no longer directly used)

3. Update `src/app/albums/[id]/page.tsx` (Album detail server component):
   - Include `blurDataUrl` in the photo data passed to AlbumGalleryClient:
     ```typescript
     photos={photos.map((p) => ({
       id: p.id,
       title: p.title,
       description: p.description,
       originalFilename: p.originalFilename,
       blurDataUrl: p.blurDataUrl,
     }))}
     ```

4. Update `src/presentation/components/AlbumGalleryClient.tsx`:
   - Add `blurDataUrl: string | null` to the PhotoData interface
   - Replace all `<Image>` tags with `<FadeImage>` component
   - Grid photos: `<FadeImage photoId={photo.id} alt={...} blurDataUrl={photo.blurDataUrl} sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw" />`
   - Keep the `group-hover:scale-105` transition on the BUTTON container (not on FadeImage -- the hover zoom is a separate concern)
   - Remove `import Image from "next/image"` (no longer directly used)

5. Update `src/app/albums/page.tsx` (Albums listing server component):
   - This page uses small 80px thumbnails for album covers. These are small enough that blur placeholders would barely be visible. Keep using `<Image>` directly here BUT update the `src` format from hardcoded `/api/images/${coverPhotoId}/300w.webp` to `/api/images/${coverPhotoId}` (the custom loader will pick the right size based on `sizes="80px"`).
   - Actually, since these are tiny thumbnails, the custom loader will map 80px to the 300w derivative (smallest available), which is the same as before. This change ensures consistency with the custom loader.

6. The PhotoLightbox component does NOT need changes -- it uses YARL which manages its own image loading. The lightbox already uses direct `/api/images/${photo.id}/600w.webp` URLs which bypass next/image entirely.
   </action>
   <verify>
   Run `npm run typecheck` and `npm run build` to verify everything compiles. Run `npm run dev` and visually verify:

- Homepage: blur placeholders visible briefly before images fade in
- Album grid: blur placeholders visible on each grid item
- Albums listing: thumbnails still load correctly
- No layout shift when images load (aspect ratios preserved)
- Hero image loads first (preload)
  </verify>
  <done>
  All public-facing pages pass blurDataUrl to client components. HomepageClient and AlbumGalleryClient use FadeImage with blur placeholders and ~300ms fade-in. Albums listing page works with custom loader. No deprecated `priority` prop usage. No visual layout shift.
  </done>
  </task>

</tasks>

<verification>
1. `npm run typecheck` passes
2. `npm run build` passes with no warnings about deprecated props
3. Homepage shows blur placeholders that fade to full images over ~300ms
4. Album grid shows blur placeholders that fade to full images
5. Albums listing thumbnails load correctly via custom loader
6. No layout shift (CLS) when images load
7. Hero image has `preload` (not `priority`)
8. Browser dev tools show images served from `/api/images/{id}/{width}w.webp` (custom loader working)
</verification>

<success_criteria>

- Blur placeholders visible on homepage and album grids while images load
- Smooth ~300ms fade-in transition from placeholder to loaded image
- No layout shift when images load
- Custom loader prevents double-optimization
- preload used instead of deprecated priority
- Production build succeeds with standalone output
  </success_criteria>

<output>
After completion, create `.planning/phases/10-polish/10-02-SUMMARY.md`
</output>
