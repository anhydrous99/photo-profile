---
phase: 02-image-pipeline
plan: 04
type: execute
wave: 4
depends_on: ["02-03"]
files_modified:
  - src/infrastructure/services/imageService.ts
  - scripts/test-image-pipeline.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "AVIF format generated alongside WebP"
    - "JPEG format not generated (removed)"
  artifacts:
    - path: "src/infrastructure/services/imageService.ts"
      provides: "Image processing with WebP and AVIF formats"
      exports: ["generateDerivatives", "getImageMetadata", "THUMBNAIL_SIZES"]
  key_links:
    - from: "src/infrastructure/services/imageService.ts"
      to: "sharp"
      via: ".avif() pipeline"
      pattern: "\\.avif\\("
---

<objective>
Switch image format generation from JPEG to AVIF to match UPLD-05 requirement (WebP/AVIF).

Purpose: Align implementation with requirements specification.
Output: generateDerivatives produces WebP + AVIF for each thumbnail size (8 files total).
</objective>

<execution_context>
@/Users/arxherre/.claude/get-shit-done/workflows/execute-plan.md
@/Users/arxherre/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-image-pipeline/02-VERIFICATION.md
@src/infrastructure/services/imageService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace JPEG with AVIF in image service</name>
  <files>src/infrastructure/services/imageService.ts</files>
  <action>
Update generateDerivatives function in imageService.ts:

1. Replace JPEG_QUALITY constant with AVIF_QUALITY:
   - Remove: `const JPEG_QUALITY = 85`
   - Add: `const AVIF_QUALITY = 80` (AVIF is more efficient than JPEG)

2. In the size processing loop, replace JPEG generation with AVIF:
   - Remove the JPEG clone pipeline (`.jpeg({ quality: JPEG_QUALITY, mozjpeg: true, chromaSubsampling: '4:4:4' })`)
   - Add AVIF clone pipeline:
     ```typescript
     // Clone for AVIF
     const avifPath = path.join(outputDir, `${width}w.avif`);
     await pipeline
       .clone()
       .avif({ quality: AVIF_QUALITY, effort: 4 })
       .toFile(avifPath);
     generatedFiles.push(avifPath);
     ```

3. Update file path tracking to use .avif extension instead of .jpg

Sharp's AVIF encoder settings:

- quality: 80 (lower than JPEG 85 because AVIF is more efficient)
- effort: 4 (balance between speed and compression, same as WebP)

Note: AVIF support requires Sharp 0.29+ (already installed in 02-01).
</action>
<verify>

- `npm run typecheck` passes
- `npm run lint` passes
- generateDerivatives generates .avif files instead of .jpg files
- No references to JPEG_QUALITY remain in imageService.ts
  </verify>
  <done>
  Image service now generates WebP + AVIF for each size (8 files per image).
  </done>
  </task>

<task type="auto">
  <name>Task 2: Update test script for AVIF format</name>
  <files>scripts/test-image-pipeline.ts</files>
  <action>
Update test-image-pipeline.ts to expect AVIF files:

1. Verify EXPECTED_FILES is still 8 (4 sizes x 2 formats)
2. Update success message to reflect WebP + AVIF (if it mentions specific formats)
3. No functional changes needed - script just counts files, doesn't care about extensions

The test will automatically verify the correct number of derivatives are generated.
</action>
<verify>

- EXPECTED_FILES constant is still 8
- Test script runs without errors
  </verify>
  <done>
  Test script compatible with AVIF format output.
  </done>
  </task>

</tasks>

<verification>
- TypeScript compiles: `npm run typecheck`
- Linting passes: `npm run lint`
- imageService generates .avif files instead of .jpg
- AVIF_QUALITY constant defined and used
- Test script expects correct file count
</verification>

<success_criteria>

1. src/infrastructure/services/imageService.ts generates AVIF instead of JPEG
2. AVIF quality set to 80 with effort 4
3. generateDerivatives returns 8 files (4 sizes x 2 formats: WebP + AVIF)
4. No JPEG generation code remains
5. Test script compatible with new format
6. No type or lint errors
   </success_criteria>

<output>
After completion, create `.planning/phases/02-image-pipeline/02-04-SUMMARY.md`
</output>
