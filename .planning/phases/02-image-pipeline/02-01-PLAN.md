---
phase: 02-image-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/infrastructure/jobs/queues.ts
  - src/infrastructure/jobs/index.ts
autonomous: true

must_haves:
  truths:
    - "BullMQ queue accepts image processing jobs"
    - "Redis connection configured via environment"
    - "Jobs have retry logic with exponential backoff"
  artifacts:
    - path: "src/infrastructure/jobs/queues.ts"
      provides: "Image processing queue and enqueue helper"
      exports: ["imageQueue", "enqueueImageProcessing"]
    - path: "src/infrastructure/jobs/index.ts"
      provides: "Re-exports for clean imports"
  key_links:
    - from: "src/infrastructure/jobs/queues.ts"
      to: "ioredis connection"
      via: "REDIS_URL environment variable"
      pattern: "IORedis.*REDIS_URL"
---

<objective>
Install image processing dependencies (Sharp, BullMQ, ioredis) and create the job queue configuration for async image processing.

Purpose: Establish the infrastructure for decoupled image processing - uploads create jobs, workers process them asynchronously.
Output: Dependencies installed, queue ready to accept jobs with retry logic.
</objective>

<execution_context>
@/Users/arxherre/.claude/get-shit-done/workflows/execute-plan.md
@/Users/arxherre/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-image-pipeline/02-RESEARCH.md

# Existing infrastructure

@src/infrastructure/config/env.ts
@src/infrastructure/database/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install image processing dependencies</name>
  <files>package.json</files>
  <action>
Install production dependencies:
- sharp (image processing)
- bullmq (job queue)
- ioredis (Redis client for BullMQ)

Install dev dependencies:

- @types/ioredis (if needed, check if ioredis has built-in types)

Run: `npm install sharp bullmq ioredis`

Note: Sharp requires native bindings - installation may take a moment. If any platform-specific issues occur, refer to Sharp installation docs.

REDIS_URL is already configured in env.ts with a default value, so no env changes needed.
</action>
<verify>

- `npm ls sharp bullmq ioredis` shows all three installed
- `npm run typecheck` passes (no type errors from new deps)
  </verify>
  <done>
  Sharp, BullMQ, and ioredis installed and TypeScript recognizes their types.
  </done>
  </task>

<task type="auto">
  <name>Task 2: Create BullMQ queue configuration</name>
  <files>
src/infrastructure/jobs/queues.ts
src/infrastructure/jobs/index.ts
  </files>
  <action>
Create `src/infrastructure/jobs/queues.ts`:

1. Import IORedis and Queue from their packages
2. Create Redis connection with settings from 02-RESEARCH.md:
   - `maxRetriesPerRequest: null` (required by BullMQ)
   - `enableOfflineQueue: false` (fail fast if Redis unavailable)
   - Connect to `env.REDIS_URL` (import from @/infrastructure/config/env)

3. Create `imageQueue` with name "image-processing" and options:
   - `attempts: 3` (retry failed jobs 3 times)
   - `backoff: { type: 'exponential', delay: 2000 }` (2s, 4s, 8s)
   - `removeOnComplete: { count: 100 }` (keep last 100 for visibility)
   - `removeOnFail: { count: 500 }` (keep more failures for debugging)

4. Create and export `enqueueImageProcessing(photoId: string, originalPath: string): Promise<string>` helper:
   - Adds job with name "process-image"
   - Passes `{ photoId, originalPath }` as data
   - Uses `jobId: \`photo-\${photoId}\`` to prevent duplicate jobs for same photo
   - Returns the job ID

5. Define and export TypeScript interfaces:
   - `ImageJobData { photoId: string; originalPath: string }`
   - `ImageJobResult { photoId: string; derivatives: string[] }`

Create `src/infrastructure/jobs/index.ts`:

- Re-export queue, helper function, and types from queues.ts
  </action>
  <verify>
- `npm run typecheck` passes
- `npm run lint` passes
- File exists at src/infrastructure/jobs/queues.ts
- File exports imageQueue, enqueueImageProcessing, ImageJobData, ImageJobResult
  </verify>
  <done>
  Queue configuration ready with retry logic, connection to Redis via env var, and typed helper for adding jobs.
  </done>
  </task>

</tasks>

<verification>
- All dependencies installed: `npm ls sharp bullmq ioredis`
- TypeScript compiles: `npm run typecheck`
- Linting passes: `npm run lint`
- Queue module exports correct items
</verification>

<success_criteria>

1. Sharp, BullMQ, ioredis appear in package.json dependencies
2. src/infrastructure/jobs/queues.ts exports imageQueue and enqueueImageProcessing
3. Queue configured with exponential backoff retry (3 attempts)
4. TypeScript types defined for job data and result
5. No type or lint errors
   </success_criteria>

<output>
After completion, create `.planning/phases/02-image-pipeline/02-01-SUMMARY.md`
</output>
