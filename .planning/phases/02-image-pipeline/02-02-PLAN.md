---
phase: 02-image-pipeline
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/infrastructure/services/imageService.ts
  - src/infrastructure/services/index.ts
autonomous: true

must_haves:
  truths:
    - "Images resized to 4 sizes: 300px, 600px, 1200px, 2400px"
    - "WebP and JPEG formats generated for each size"
    - "EXIF orientation auto-corrected"
    - "Color profiles preserved (sRGB conversion)"
    - "Images smaller than target size not upscaled"
  artifacts:
    - path: "src/infrastructure/services/imageService.ts"
      provides: "Image processing operations with Sharp"
      exports: ["generateDerivatives", "getImageMetadata", "THUMBNAIL_SIZES"]
    - path: "src/infrastructure/services/index.ts"
      provides: "Re-exports for clean imports"
  key_links:
    - from: "src/infrastructure/services/imageService.ts"
      to: "sharp"
      via: "sharp() pipeline"
      pattern: "sharp\\(.*\\)\\.rotate\\(\\)"
---

<objective>
Create the image processing service using Sharp to generate multiple thumbnail sizes in WebP and JPEG formats.

Purpose: Handle all Sharp operations for resizing, format conversion, and color management in a reusable service.
Output: imageService.ts with generateDerivatives function that produces 8 derivative files (4 sizes x 2 formats).
</objective>

<execution_context>
@/Users/arxherre/.claude/get-shit-done/workflows/execute-plan.md
@/Users/arxherre/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-image-pipeline/02-RESEARCH.md
@.planning/phases/02-image-pipeline/02-01-SUMMARY.md

# Project structure reference

@src/infrastructure/config/env.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create image processing service</name>
  <files>
src/infrastructure/services/imageService.ts
src/infrastructure/services/index.ts
  </files>
  <action>
Create `src/infrastructure/services/imageService.ts`:

1. Import sharp and fs/promises, path

2. Define constants:
   - `THUMBNAIL_SIZES = [300, 600, 1200, 2400] as const`
   - `JPEG_QUALITY = 85`
   - `WEBP_QUALITY = 82`

3. Create `getImageMetadata(inputPath: string): Promise<sharp.Metadata>`:
   - Returns metadata from sharp(inputPath).metadata()
   - Used to check original dimensions before processing

4. Create `generateDerivatives(inputPath: string, outputDir: string): Promise<string[]>`:
   - Ensure output directory exists with fs.mkdir(outputDir, { recursive: true })
   - Get original metadata to check dimensions
   - For each size in THUMBNAIL_SIZES:
     - Skip if original width is smaller than target (don't upscale)
     - Create Sharp pipeline with:
       - `.rotate()` - auto-orient from EXIF (CRITICAL - prevents rotated thumbnails)
       - `.resize(width, null, { fit: 'inside', withoutEnlargement: true, kernel: 'lanczos3' })`
       - `.withMetadata()` - preserve sRGB ICC profile (CRITICAL - prevents color shift)
     - Clone pipeline for WebP output:
       - `.webp({ quality: WEBP_QUALITY, effort: 4 })` (effort 4 balances speed/size)
       - Save to `${outputDir}/${width}w.webp`
     - Clone pipeline for JPEG output:
       - `.jpeg({ quality: JPEG_QUALITY, mozjpeg: true, chromaSubsampling: '4:4:4' })`
       - (mozjpeg for better compression, 4:4:4 for photography quality)
       - Save to `${outputDir}/${width}w.jpg`
     - Track generated file paths in array
   - Return array of all generated file paths

5. Export THUMBNAIL_SIZES, generateDerivatives, getImageMetadata

Create `src/infrastructure/services/index.ts`:

- Re-export everything from imageService.ts

Key implementation details from research:

- Always call .rotate() BEFORE resize to handle EXIF orientation
- Use withMetadata() to preserve/convert ICC profile to sRGB
- Skip sizes larger than original (withoutEnlargement: true + explicit check)
- Use lanczos3 kernel for high-quality downscaling
  </action>
  <verify>
- `npm run typecheck` passes
- `npm run lint` passes
- File exists at src/infrastructure/services/imageService.ts
- THUMBNAIL_SIZES exported as readonly tuple [300, 600, 1200, 2400]
- generateDerivatives function signature matches: (inputPath: string, outputDir: string) => Promise<string[]>
  </verify>
  <done>
  Image service ready with Sharp operations for generating 4 sizes in 2 formats each, proper EXIF handling, and color management.
  </done>
  </task>

</tasks>

<verification>
- TypeScript compiles: `npm run typecheck`
- Linting passes: `npm run lint`
- imageService exports THUMBNAIL_SIZES, generateDerivatives, getImageMetadata
- Sharp operations chain correctly (.rotate(), .resize(), .withMetadata())
</verification>

<success_criteria>

1. src/infrastructure/services/imageService.ts exists with generateDerivatives
2. Function handles 4 thumbnail sizes (300, 600, 1200, 2400)
3. Generates both WebP and JPEG for each size
4. Uses .rotate() for EXIF auto-orientation
5. Uses .withMetadata() for sRGB color preservation
6. Skips sizes larger than original image
7. No type or lint errors
   </success_criteria>

<output>
After completion, create `.planning/phases/02-image-pipeline/02-02-SUMMARY.md`
</output>
