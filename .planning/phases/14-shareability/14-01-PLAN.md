---
phase: 14-shareability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/domain/repositories/PhotoRepository.ts
  - src/infrastructure/database/repositories/SQLitePhotoRepository.ts
  - src/presentation/components/AlbumGalleryClient.tsx
  - src/presentation/components/HomepageClient.tsx
  - .env.example
autonomous: true

must_haves:
  truths:
    - "Opening a photo in the album lightbox updates the browser URL to /albums/{albumId}/photo/{slug}"
    - "Opening a photo in the homepage lightbox updates the browser URL to /photo/{slug}"
    - "Navigating between photos in the lightbox updates the URL without adding history entries"
    - "Closing the lightbox restores the original page URL"
    - "A photo can be looked up by the first 8 characters of its UUID"
  artifacts:
    - path: "src/domain/repositories/PhotoRepository.ts"
      provides: "findBySlugPrefix method signature"
      contains: "findBySlugPrefix"
    - path: "src/infrastructure/database/repositories/SQLitePhotoRepository.ts"
      provides: "findBySlugPrefix SQL implementation"
      contains: "findBySlugPrefix"
    - path: "src/presentation/components/AlbumGalleryClient.tsx"
      provides: "URL sync on lightbox navigation + initialPhotoSlug prop"
      contains: "replaceState"
    - path: "src/presentation/components/HomepageClient.tsx"
      provides: "URL sync on lightbox navigation + initialPhotoSlug prop"
      contains: "replaceState"
  key_links:
    - from: "src/presentation/components/AlbumGalleryClient.tsx"
      to: "window.history.replaceState"
      via: "lightbox on.view callback"
      pattern: "replaceState.*albums.*photo"
    - from: "src/presentation/components/HomepageClient.tsx"
      to: "window.history.replaceState"
      via: "lightbox on.view callback"
      pattern: "replaceState.*/photo/"
    - from: "src/infrastructure/database/repositories/SQLitePhotoRepository.ts"
      to: "photos table"
      via: "LIKE query on id column"
      pattern: "like.*%"
---

<objective>
Add URL synchronization to the lightbox and create the slug-based photo lookup infrastructure.

Purpose: When users browse photos in the lightbox, the browser URL reflects which photo they're viewing. This is the foundation for shareable photo links (SHAR-01). Also adds the repository method to look up photos by their 8-character slug prefix (needed by deep link pages in Plan 02).

Output: Modified client components with replaceState URL sync, new findBySlugPrefix repository method, updated .env.example with NEXT_PUBLIC_SITE_URL.
</objective>

<execution_context>
@/Users/arxherre/.claude/get-shit-done/workflows/execute-plan.md
@/Users/arxherre/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-shareability/14-CONTEXT.md
@.planning/phases/14-shareability/14-RESEARCH.md
@src/domain/repositories/PhotoRepository.ts
@src/infrastructure/database/repositories/SQLitePhotoRepository.ts
@src/presentation/components/AlbumGalleryClient.tsx
@src/presentation/components/HomepageClient.tsx
@src/presentation/components/PhotoLightbox.tsx
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add findBySlugPrefix to PhotoRepository and SQLite implementation</name>
  <files>
    src/domain/repositories/PhotoRepository.ts
    src/infrastructure/database/repositories/SQLitePhotoRepository.ts
    .env.example
  </files>
  <action>
  1. In `src/domain/repositories/PhotoRepository.ts`, add a new method to the PhotoRepository interface:
     ```typescript
     findBySlugPrefix(slug: string): Promise<Photo | null>;
     ```
     This takes an 8-character slug (first 8 chars of UUID) and returns the matching photo.

2. In `src/infrastructure/database/repositories/SQLitePhotoRepository.ts`, implement `findBySlugPrefix`:
   - Use Drizzle's `like` operator: `like(photos.id, `${slug}%`)`
   - Import `like` from `drizzle-orm`
   - Return the first match via `.limit(1)`, mapped through `toDomain()`
   - Return `null` if no match

3. In `.env.example`, add a new env var:
   ```
   # Site URL (used for OpenGraph meta tags - absolute URLs required)
   NEXT_PUBLIC_SITE_URL=http://localhost:3000
   ```
   Add it after the ADMIN_PASSWORD_HASH entry.

Note: The slug is the first 8 characters of the UUID (per user decision). UUID collision in first 8 chars is negligible for a personal portfolio.
</action>
<verify>Run `npm run typecheck` to confirm the interface and implementation are in sync with no type errors.</verify>
<done>PhotoRepository interface has findBySlugPrefix method. SQLitePhotoRepository implements it with a LIKE query. .env.example includes NEXT_PUBLIC_SITE_URL.</done>
</task>

<task type="auto">
  <name>Task 2: Add URL sync to AlbumGalleryClient and HomepageClient lightboxes</name>
  <files>
    src/presentation/components/AlbumGalleryClient.tsx
    src/presentation/components/HomepageClient.tsx
  </files>
  <action>
  **AlbumGalleryClient.tsx modifications:**

1. Add a new optional prop `initialPhotoSlug?: string` to the `AlbumGalleryClientProps` interface.

2. On mount, if `initialPhotoSlug` is provided:
   - Find the photo index where `photo.id.startsWith(initialPhotoSlug)`
   - If found, set `lightboxIndex` to that index and `lightboxOpen` to `true`
   - If not found, do nothing (the deep link page in Plan 02 will handle 404)
   - Use `useState` initializer functions (not useEffect) to avoid flash: `useState(() => initialPhotoSlug ? findIndex... : 0)` for index and `useState(() => !!initialPhotoSlug && foundIndex >= 0)` for open state.

3. In the lightbox `onIndexChange` callback (currently just `setLightboxIndex`), also call `window.history.replaceState`:
   - Compute slug: `photos[newIndex].id.slice(0, 8)`
   - Update URL: `window.history.replaceState(null, "", `/albums/${album.id}/photo/${slug}`)`

4. In `handleLightboxClose`, restore the album URL:
   - `window.history.replaceState(null, "", `/albums/${album.id}`)`
   - Then call `setLightboxOpen(false)`

5. When lightbox first opens via photo click (not deep link), also update URL via replaceState in `handlePhotoClick`.

**HomepageClient.tsx modifications:**

1. Add a new optional prop `initialPhotoSlug?: string` to the `HomepageClientProps` interface.

2. On mount, if `initialPhotoSlug` is provided:
   - Find the photo index where `photo.id.startsWith(initialPhotoSlug)`
   - If found, initialize lightbox open at that index (use useState initializer functions, same pattern as album)

3. When lightbox opens or user navigates between photos, update URL:
   - Compute slug: `photos[currentIndex].id.slice(0, 8)`
   - `window.history.replaceState(null, "", `/photo/${slug}`)`

4. On lightbox close, restore homepage URL:
   - `window.history.replaceState(null, "", "/")`

5. When lightbox opens via click, also update URL.

**Important implementation notes:**

- Use `window.history.replaceState` (NOT `router.replace` -- that triggers re-renders)
- The `onIndexChange` callback on PhotoLightbox already fires on every slide change via the `on.view` YARL callback -- wire replaceState into the parent's handler that receives the new index
- Do NOT import useRouter or usePathname -- replaceState is direct DOM API
- Keep the existing PhotoLightbox component unchanged -- all URL logic lives in the parent gallery components
  </action>
  <verify>
  Run `npm run typecheck` to confirm no type errors.
  Run `npm run lint` to confirm no lint errors.
  Run `npm run build` to confirm the app builds successfully.
  </verify>
  <done>
- AlbumGalleryClient updates browser URL to `/albums/{albumId}/photo/{slug}` on every lightbox slide change and restores `/albums/{albumId}` on close
- HomepageClient updates browser URL to `/photo/{slug}` on every lightbox slide change and restores `/` on close
- Both components accept optional `initialPhotoSlug` prop to open lightbox at a specific photo on mount
- No history entries are added (replaceState only)
  </done>
  </task>

</tasks>

<verification>
1. `npm run typecheck` passes with no errors
2. `npm run lint` passes
3. `npm run build` succeeds
4. Manual: Open dev server, click a photo in an album -> URL bar shows `/albums/{id}/photo/{8chars}`
5. Manual: Navigate photos -> URL updates without Back button growing history
6. Manual: Close lightbox -> URL reverts to `/albums/{id}`
7. Manual: Same behavior on homepage with `/photo/{8chars}`
</verification>

<success_criteria>

- PhotoRepository interface and SQLite implementation include findBySlugPrefix
- AlbumGalleryClient updates URL on lightbox navigation using replaceState
- HomepageClient updates URL on lightbox navigation using replaceState
- Both components accept initialPhotoSlug for deep link landing
- Closing lightbox restores the original page URL
- No additional history entries created during photo browsing
- .env.example includes NEXT_PUBLIC_SITE_URL
  </success_criteria>

<output>
After completion, create `.planning/phases/14-shareability/14-01-SUMMARY.md`
</output>
