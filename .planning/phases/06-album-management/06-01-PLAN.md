---
phase: 06-album-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/infrastructure/database/schema.ts
  - src/domain/entities/Album.ts
  - src/domain/repositories/AlbumRepository.ts
  - src/infrastructure/database/repositories/SQLiteAlbumRepository.ts
  - src/app/api/admin/albums/route.ts
  - src/app/api/admin/albums/[id]/route.ts
  - src/app/api/admin/albums/reorder/route.ts
autonomous: true

must_haves:
  truths:
    - "POST /api/admin/albums creates new album with title, description, tags"
    - "PATCH /api/admin/albums/[id] updates album title, description, tags, coverPhotoId"
    - "DELETE /api/admin/albums/[id] removes album with mode selection (album-only or album+photos)"
    - "POST /api/admin/albums/reorder updates sortOrder for all albums"
    - "GET /api/admin/albums returns all albums with photo counts"
  artifacts:
    - path: "src/app/api/admin/albums/route.ts"
      provides: "GET all albums, POST create album"
      exports: ["GET", "POST"]
    - path: "src/app/api/admin/albums/[id]/route.ts"
      provides: "PATCH update, DELETE album"
      exports: ["PATCH", "DELETE"]
    - path: "src/app/api/admin/albums/reorder/route.ts"
      provides: "POST reorder albums"
      exports: ["POST"]
    - path: "src/infrastructure/database/repositories/SQLiteAlbumRepository.ts"
      provides: "Album repository with photo counts and reorder"
      contains: "getPhotoCounts"
  key_links:
    - from: "src/app/api/admin/albums/route.ts"
      to: "SQLiteAlbumRepository"
      via: "repository.save()"
      pattern: "albumRepository\\.save"
    - from: "src/app/api/admin/albums/[id]/route.ts"
      to: "deletePhotoFiles"
      via: "file cleanup on cascade delete"
      pattern: "deletePhotoFiles"
---

<objective>
Album API infrastructure: CRUD endpoints with photo counts, reorder support, and cascade delete.

Purpose: Enable album management from admin UI by providing complete REST API for albums with proper deletion modes (album-only vs album+photos).

Output: Album API routes and extended repository methods ready for UI integration.
</objective>

<execution_context>
@/Users/arxherre/.claude/get-shit-done/workflows/execute-plan.md
@/Users/arxherre/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-album-management/06-CONTEXT.md
@.planning/phases/06-album-management/06-RESEARCH.md
@src/infrastructure/database/schema.ts
@src/infrastructure/database/repositories/SQLiteAlbumRepository.ts
@src/domain/repositories/AlbumRepository.ts
@src/domain/entities/Album.ts
@src/app/api/admin/photos/[id]/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend schema and repository for album management</name>
  <files>
    src/infrastructure/database/schema.ts
    src/domain/entities/Album.ts
    src/domain/repositories/AlbumRepository.ts
    src/infrastructure/database/repositories/SQLiteAlbumRepository.ts
  </files>
  <action>
    1. Add `tags` column to albums table in schema.ts:
       ```typescript
       tags: text("tags"), // comma-separated, e.g. "landscape,nature,2024"
       ```

    2. Update Album entity in src/domain/entities/Album.ts to include tags:
       ```typescript
       tags: string | null;
       ```

    3. Extend AlbumRepository interface with new methods:
       ```typescript
       getPhotoCounts(): Promise<Map<string, number>>;
       updateSortOrders(albumIds: string[]): Promise<void>;
       deleteWithPhotos(albumId: string, deletePhotos: boolean): Promise<{ deletedPhotoIds: string[] }>;
       ```

    4. Implement methods in SQLiteAlbumRepository:
       - getPhotoCounts(): SELECT albumId, count(*) FROM photoAlbums GROUP BY albumId
       - updateSortOrders(albumIds): Transaction updating sortOrder = array index
       - deleteWithPhotos(albumId, deletePhotos): If deletePhotos, get photoIds first, then delete album (CASCADE removes junction entries), return photoIds for file cleanup

    5. Update toDomain/toDatabase mappers to include tags field

    Use existing patterns from SQLitePhotoRepository for transactions.
    Use drizzle-orm sql template for count aggregation.

  </action>
  <verify>
    Run `npm run lint && npm run build` - no errors
    Check schema.ts includes tags column
    Check SQLiteAlbumRepository has all three new methods
  </verify>
  <done>
    Album entity and repository extended with tags field, photo counts, reorder, and cascade delete methods
  </done>
</task>

<task type="auto">
  <name>Task 2: Create album API routes</name>
  <files>
    src/app/api/admin/albums/route.ts
    src/app/api/admin/albums/[id]/route.ts
    src/app/api/admin/albums/reorder/route.ts
  </files>
  <action>
    1. Create src/app/api/admin/albums/route.ts with:
       - GET: Return all albums sorted by sortOrder, include photo counts
         - Fetch albums with albumRepository.findAll()
         - Fetch photo counts with albumRepository.getPhotoCounts()
         - Merge counts into response: albums.map(a => ({ ...a, photoCount: counts.get(a.id) ?? 0 }))
       - POST: Create new album
         - Validate with Zod: { title: string (required, 1-100 chars), description?: string, tags?: string }
         - Generate ID with crypto.randomUUID()
         - Set sortOrder to max existing + 1
         - Return created album with 201 status

    2. Create src/app/api/admin/albums/[id]/route.ts with:
       - PATCH: Update album
         - Validate with Zod: { title?: string, description?: string, tags?: string, coverPhotoId?: string | null }
         - Fetch existing album, return 404 if not found
         - Update only provided fields
         - Return updated album
       - DELETE: Delete album with mode selection
         - Parse { deletePhotos?: boolean } from request body
         - Call albumRepository.deleteWithPhotos(id, deletePhotos)
         - If deletePhotos, loop through deletedPhotoIds:
           - Call deletePhotoFiles(photoId)
           - Call photoRepository.delete(photoId)
         - revalidatePath('/admin/albums')
         - Return 204

    3. Create src/app/api/admin/albums/reorder/route.ts with:
       - POST: Reorder albums
         - Validate with Zod: { albumIds: string[] }
         - Call albumRepository.updateSortOrders(albumIds)
         - Return { success: true }

    All routes must:
    - Verify admin session with verifySession(), return 401 if not authenticated
    - Use proper error handling with try/catch
    - Import from @/infrastructure paths

    Reference existing patterns from src/app/api/admin/photos/[id]/route.ts for structure.

  </action>
  <verify>
    Run `npm run lint && npm run build` - no errors
    All three route files exist and export correct HTTP methods
    Manually inspect routes have proper auth checks
  </verify>
  <done>
    Album API routes complete: GET/POST at /api/admin/albums, PATCH/DELETE at /api/admin/albums/[id], POST at /api/admin/albums/reorder
  </done>
</task>

</tasks>

<verification>
1. `npm run lint` passes
2. `npm run build` succeeds
3. New route files exist at expected paths
4. SQLiteAlbumRepository implements all three new methods
5. Album entity includes tags field
6. Schema includes tags column
</verification>

<success_criteria>

- Album API endpoints ready for UI consumption
- Photo counts available in GET response
- Reorder endpoint persists sortOrder changes
- Delete endpoint supports both modes (album-only and album+photos)
- All routes protected by admin session verification
  </success_criteria>

<output>
After completion, create `.planning/phases/06-album-management/06-01-SUMMARY.md`
</output>
