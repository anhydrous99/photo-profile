---
phase: 03-admin-auth
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/infrastructure/config/env.ts
  - src/infrastructure/auth/session.ts
  - src/infrastructure/auth/password.ts
  - src/infrastructure/auth/rateLimiter.ts
  - src/infrastructure/auth/dal.ts
  - src/infrastructure/auth/index.ts
  - .env.example
  - scripts/hash-password.ts
autonomous: true

must_haves:
  truths:
    - "AUTH_SECRET and ADMIN_PASSWORD_HASH env vars are validated on startup"
    - "JWT can be encrypted and decrypted with 8-hour expiry"
    - "Password can be verified against stored hash using bcrypt"
    - "Rate limiter blocks after 5 failed attempts for 15 minutes"
    - "Session verification returns auth state from cookie"
  artifacts:
    - path: "src/infrastructure/auth/session.ts"
      provides: "JWT encrypt/decrypt and cookie management"
      exports: ["encrypt", "decrypt", "createSession", "deleteSession"]
    - path: "src/infrastructure/auth/password.ts"
      provides: "Password hashing utilities"
      exports: ["verifyPassword", "hashPassword"]
    - path: "src/infrastructure/auth/rateLimiter.ts"
      provides: "Login attempt rate limiting"
      exports: ["checkRateLimit", "resetRateLimit"]
    - path: "src/infrastructure/auth/dal.ts"
      provides: "Data Access Layer for session verification"
      exports: ["verifySession"]
    - path: "scripts/hash-password.ts"
      provides: "One-time password hash generation script"
  key_links:
    - from: "src/infrastructure/auth/session.ts"
      to: "src/infrastructure/config/env.ts"
      via: "AUTH_SECRET import"
      pattern: "env\\.AUTH_SECRET"
    - from: "src/infrastructure/auth/rateLimiter.ts"
      to: "src/infrastructure/config/env.ts"
      via: "REDIS_URL import"
      pattern: "env\\.REDIS_URL"
    - from: "src/infrastructure/auth/dal.ts"
      to: "src/infrastructure/auth/session.ts"
      via: "decrypt function import"
      pattern: "import.*decrypt.*from.*session"
---

<objective>
Create the authentication infrastructure including JWT session management, password verification, rate limiting, and data access layer for session verification.

Purpose: Provides the foundation modules that login and route protection will use. All auth-related utilities centralized in src/infrastructure/auth/.
Output: Session utilities (jose), password utilities (bcrypt), rate limiter (rate-limiter-flexible), DAL pattern, and password hash script.
</objective>

<execution_context>
@/Users/arxherre/.claude/get-shit-done/workflows/execute-plan.md
@/Users/arxherre/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-admin-auth/03-CONTEXT.md
@.planning/phases/03-admin-auth/03-RESEARCH.md
@src/infrastructure/config/env.ts
@src/infrastructure/jobs/queues.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add auth environment variables and install dependencies</name>
  <files>
    src/infrastructure/config/env.ts
    .env.example
    package.json
  </files>
  <action>
1. Install auth dependencies:
   ```bash
   npm install jose bcrypt rate-limiter-flexible
   npm install -D @types/bcrypt
   ```

2. Update env.ts to add AUTH_SECRET and ADMIN_PASSWORD_HASH:
   - AUTH_SECRET: z.string().min(32) - must be at least 32 characters for security
   - ADMIN_PASSWORD_HASH: z.string().min(1) - bcrypt hash of admin password

3. Update .env.example with placeholders:
   - AUTH_SECRET=your-secret-key-at-least-32-characters-long
   - ADMIN_PASSWORD_HASH=generate-with-scripts/hash-password.ts

Note: REDIS_URL already exists in env.ts from Phase 2.
</action>
<verify>
`npm run build` passes (env validation won't fail in build since using process.env)
`grep -q "AUTH_SECRET" src/infrastructure/config/env.ts` returns 0
`grep -q "ADMIN_PASSWORD_HASH" src/infrastructure/config/env.ts` returns 0
</verify>
<done>
Environment schema validates AUTH_SECRET (min 32 chars) and ADMIN_PASSWORD_HASH (required string).
jose, bcrypt, rate-limiter-flexible installed with types.
</done>
</task>

<task type="auto">
  <name>Task 2: Create auth infrastructure modules</name>
  <files>
    src/infrastructure/auth/session.ts
    src/infrastructure/auth/password.ts
    src/infrastructure/auth/rateLimiter.ts
    src/infrastructure/auth/dal.ts
    src/infrastructure/auth/index.ts
    scripts/hash-password.ts
  </files>
  <action>
1. Create src/infrastructure/auth/session.ts:
   - Import "server-only" at top to prevent client-side usage
   - Import SignJWT, jwtVerify from "jose"
   - Import cookies from "next/headers"
   - Import env for AUTH_SECRET
   - Encode AUTH_SECRET with TextEncoder for jose
   - Define SessionPayload interface: { isAdmin: true, expiresAt: Date }
   - encrypt(payload): Create JWT with HS256, setIssuedAt(), setExpirationTime("8h")
   - decrypt(session): Verify JWT with jwtVerify, return payload or null on error
   - createSession(): Create 8-hour session, set httpOnly cookie with secure flag in production
   - deleteSession(): Clear the session cookie
   - Cookie settings: httpOnly: true, secure: NODE_ENV === "production", sameSite: "lax", path: "/"

2. Create src/infrastructure/auth/password.ts:
   - Import "server-only"
   - Import bcrypt
   - Import env for ADMIN_PASSWORD_HASH
   - verifyPassword(password: string): Promise<boolean> - compare against ADMIN_PASSWORD_HASH
   - hashPassword(password: string): Promise<string> - for the hash script (cost factor 10)

3. Create src/infrastructure/auth/rateLimiter.ts:
   - Import RateLimiterRedis from "rate-limiter-flexible"
   - Import IORedis from "ioredis"
   - Import env for REDIS_URL
   - Create Redis client with enableOfflineQueue: false, maxRetriesPerRequest: null
   - Configure: points: 5, duration: 60 _ 15 (15 min), blockDuration: 60 _ 15, keyPrefix: "login_fail_ip"
   - checkRateLimit(ip: string): Promise<{ allowed: boolean, retryAfter?: number }>
   - resetRateLimit(ip: string): Promise<void> - call limiter.delete(ip) on successful login

4. Create src/infrastructure/auth/dal.ts:
   - Import "server-only"
   - Import cookies from "next/headers"
   - Import cache from "react"
   - Import decrypt from "./session"
   - verifySession = cache(async (): Promise<{ isAuth: true } | null>) - check cookie, decrypt, return auth state

5. Create src/infrastructure/auth/index.ts:
   - Re-export from session: createSession, deleteSession, encrypt, decrypt
   - Re-export from password: verifyPassword, hashPassword
   - Re-export from rateLimiter: checkRateLimit, resetRateLimit
   - Re-export from dal: verifySession

6. Create scripts/hash-password.ts:
   - Import bcrypt
   - Read password from process.argv[2]
   - If no password, print usage and exit 1
   - Hash with cost factor 10
   - Print: "Add to .env:\nADMIN_PASSWORD_HASH={hash}"
   - Usage: npx tsx scripts/hash-password.ts mypassword
     </action>
     <verify>
     `npm run lint` passes
     `npm run build` passes (with test env vars set)
     File exists: `test -f src/infrastructure/auth/session.ts`
     File exists: `test -f src/infrastructure/auth/dal.ts`
     File exists: `test -f scripts/hash-password.ts`
     </verify>
     <done>
     All auth modules created with proper imports and exports.
     session.ts handles JWT with 8-hour expiry.
     password.ts uses bcrypt for secure hashing.
     rateLimiter.ts uses Redis for distributed rate limiting (5 attempts per 15 min).
     dal.ts provides cached session verification.
     hash-password.ts script ready for password setup.
     </done>
     </task>

</tasks>

<verification>
1. All auth module files exist in src/infrastructure/auth/
2. Environment schema includes AUTH_SECRET and ADMIN_PASSWORD_HASH
3. Scripts folder has hash-password.ts
4. `npm run lint` passes
5. `npm run build` passes (may need test env vars)
</verification>

<success_criteria>

- [ ] jose, bcrypt, rate-limiter-flexible installed
- [ ] env.ts validates AUTH_SECRET (min 32 chars) and ADMIN_PASSWORD_HASH
- [ ] session.ts encrypts/decrypts JWT with 8-hour expiry
- [ ] password.ts verifies passwords against stored hash
- [ ] rateLimiter.ts limits to 5 attempts per 15 minutes
- [ ] dal.ts provides cached verifySession
- [ ] hash-password.ts script generates bcrypt hashes
- [ ] All files use "server-only" where appropriate
      </success_criteria>

<output>
After completion, create `.planning/phases/03-admin-auth/03-01-SUMMARY.md`
</output>
