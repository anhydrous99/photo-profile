---
phase: 03-admin-auth
plan: 03
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - src/proxy.ts
  - src/app/admin/(protected)/layout.tsx
  - src/app/admin/(protected)/page.tsx
autonomous: true

must_haves:
  truths:
    - "Unauthenticated access to /admin/* returns 404 (hides admin existence)"
    - "Authenticated users can access /admin pages"
    - "/admin/login is accessible without authentication"
    - "Session expiry causes redirect to login"
  artifacts:
    - path: "src/proxy.ts"
      provides: "Route protection returning 404 for unauthenticated access"
      exports: ["proxy", "config"]
    - path: "src/app/admin/(protected)/layout.tsx"
      provides: "Protected layout with session verification"
      min_lines: 10
    - path: "src/app/admin/(protected)/page.tsx"
      provides: "Admin dashboard placeholder"
      min_lines: 5
  key_links:
    - from: "src/proxy.ts"
      to: "request.cookies"
      via: "cookie existence check"
      pattern: "cookies\\.get.*session"
    - from: "src/app/admin/(protected)/layout.tsx"
      to: "src/infrastructure/auth/dal.ts"
      via: "verifySession import"
      pattern: "import.*verifySession.*from.*@/infrastructure/auth"
---

<objective>
Create route protection using proxy.ts and protected layout to secure /admin/* routes.

Purpose: Ensures only authenticated users can access admin features. Unauthenticated users see 404 to hide admin panel existence (per user decision). Protected layout provides server-side session verification.
Output: proxy.ts for edge protection, protected layout for Server Component verification, admin placeholder page.
</objective>

<execution_context>
@/Users/arxherre/.claude/get-shit-done/workflows/execute-plan.md
@/Users/arxherre/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-admin-auth/03-CONTEXT.md
@.planning/phases/03-admin-auth/03-RESEARCH.md
@.planning/phases/03-admin-auth/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create proxy.ts for route protection</name>
  <files>src/proxy.ts</files>
  <action>
Create src/proxy.ts (Next.js 16 renamed middleware.ts to proxy.ts):

1. Import NextRequest, NextResponse from "next/server"

2. Create proxy function:

   ```typescript
   export function proxy(request: NextRequest) {
     const path = request.nextUrl.pathname;

     // Only apply to /admin/* routes (except login)
     if (path.startsWith("/admin") && !path.startsWith("/admin/login")) {
       const session = request.cookies.get("session")?.value;

       // No session cookie = 404 (hide admin existence per CONTEXT.md)
       if (!session) {
         return new NextResponse("Not found", { status: 404 });
       }
       // Note: Don't verify JWT here - keep proxy lightweight per research
       // Full verification happens in protected layout Server Component
     }

     return NextResponse.next();
   }
   ```

3. Configure matcher to only run on admin routes:
   ```typescript
   export const config = {
     matcher: ["/admin/:path*"],
   };
   ```

Important: proxy.ts only checks cookie EXISTENCE, not validity. This keeps the edge runtime fast. Full JWT verification happens in the protected layout Server Component.
</action>
<verify>
`npm run lint` passes
File exists: `test -f src/proxy.ts`
Exports proxy function: `grep -q "export function proxy" src/proxy.ts`
Has matcher config: `grep -q "matcher:" src/proxy.ts`
</verify>
<done>
proxy.ts returns 404 for unauthenticated /admin/\* requests.
/admin/login is excluded from protection.
Lightweight - only checks cookie existence, not JWT validity.
</done>
</task>

<task type="auto">
  <name>Task 2: Create protected admin layout and placeholder page</name>
  <files>
    src/app/admin/(protected)/layout.tsx
    src/app/admin/(protected)/page.tsx
  </files>
  <action>
1. Create src/app/admin/(protected)/layout.tsx as Server Component:
   ```typescript
   import { verifySession } from '@/infrastructure/auth'
   import { redirect } from 'next/navigation'

export default async function ProtectedAdminLayout({
children,
}: {
children: React.ReactNode
}) {
const session = await verifySession()

     if (!session) {
       // Session invalid or expired - redirect to login
       redirect('/admin/login')
     }

     return <>{children}</>

}

````

This provides full JWT verification via the DAL. If JWT is invalid or expired,
user is redirected to login (per CONTEXT.md "auto-redirect on expiry").

2. Create src/app/admin/(protected)/page.tsx as placeholder:
```typescript
export default function AdminDashboard() {
  return (
    <div className="p-8">
      <h1 className="text-2xl font-bold">Admin Dashboard</h1>
      <p className="text-gray-600 mt-2">
        Welcome to the admin panel. Photo management coming in Phase 4.
      </p>
    </div>
  )
}
````

This serves as /admin route (the main admin page) - placeholder until Phase 4 adds upload UI.

Route structure:

- /admin/login - Login page (unprotected, created in 03-02)
- /admin - Admin dashboard (protected via route group)
- /admin/\* - Future admin pages will go in (protected) group
  </action>
  <verify>
  `npm run lint` passes
  `npm run build` passes
  File exists: `test -f src/app/admin/\(protected\)/layout.tsx`
  File exists: `test -f src/app/admin/\(protected\)/page.tsx`
  </verify>
  <done>
  Protected layout verifies session server-side.
  Invalid/expired sessions redirect to /admin/login.
  Admin dashboard placeholder ready at /admin.
  </done>
  </task>

</tasks>

<verification>
1. Without auth: curl -s http://localhost:3000/admin returns 404 (or "Not found")
2. Navigate to /admin/login - accessible without session
3. After login: /admin shows dashboard placeholder
4. Session expiry: clearing cookie and refreshing /admin redirects to login
5. `npm run lint` passes
6. `npm run build` passes
</verification>

<success_criteria>

- [ ] proxy.ts exists in src/ directory
- [ ] Unauthenticated /admin/\* returns 404 status
- [ ] /admin/login is accessible without session
- [ ] Protected layout at src/app/admin/(protected)/layout.tsx
- [ ] Layout verifies session and redirects if invalid
- [ ] Admin dashboard placeholder at /admin
- [ ] Build and lint pass
      </success_criteria>

<output>
After completion, create `.planning/phases/03-admin-auth/03-03-SUMMARY.md`
</output>
