---
phase: 03-admin-auth
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - src/app/actions/auth.ts
  - src/app/admin/login/page.tsx
autonomous: true

must_haves:
  truths:
    - "Login form accepts password input"
    - "Incorrect password shows inline error message"
    - "Rate-limited attempts show countdown message"
    - "Correct password creates session and redirects"
    - "Form shows loading state during submission"
  artifacts:
    - path: "src/app/actions/auth.ts"
      provides: "Server Action for login"
      exports: ["login", "LoginState"]
    - path: "src/app/admin/login/page.tsx"
      provides: "Login page component"
      min_lines: 30
  key_links:
    - from: "src/app/admin/login/page.tsx"
      to: "src/app/actions/auth.ts"
      via: "useActionState hook"
      pattern: "useActionState.*login"
    - from: "src/app/actions/auth.ts"
      to: "src/infrastructure/auth"
      via: "auth module imports"
      pattern: "import.*from.*@/infrastructure/auth"
---

<objective>
Create the login page and server action for admin authentication.

Purpose: Provides the user-facing login interface and backend logic for password verification with rate limiting. This is the entry point for admin access.
Output: Login page at /admin/login with Server Action handling authentication.
</objective>

<execution_context>
@/Users/arxherre/.claude/get-shit-done/workflows/execute-plan.md
@/Users/arxherre/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-admin-auth/03-CONTEXT.md
@.planning/phases/03-admin-auth/03-RESEARCH.md
@.planning/phases/03-admin-auth/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create login Server Action</name>
  <files>src/app/actions/auth.ts</files>
  <action>
Create src/app/actions/auth.ts with "use server" directive:

1. Import dependencies:
   - z from "zod"
   - redirect from "next/navigation"
   - headers from "next/headers"
   - createSession from "@/infrastructure/auth"
   - verifyPassword from "@/infrastructure/auth"
   - checkRateLimit, resetRateLimit from "@/infrastructure/auth"

2. Define loginSchema with Zod:
   - password: z.string().min(1, "Password is required")

3. Define LoginState type:

   ```typescript
   export type LoginState = {
     error?: string;
     rateLimited?: boolean;
     retryAfter?: number;
   };
   ```

4. Create login function:

   ```typescript
   export async function login(
     _prevState: LoginState,
     formData: FormData,
   ): Promise<LoginState>;
   ```

5. Implementation:
   - Get IP from headers: x-forwarded-for first segment, fallback to "unknown"
   - Check rate limit first - return early with rateLimited: true and retryAfter if blocked
   - Validate form data with loginSchema.safeParse
   - If validation fails, return { error: "Password is required" }
   - Call verifyPassword with the password
   - If invalid, return { error: "Incorrect password" } (per CONTEXT.md decision)
   - On success: await createSession(), await resetRateLimit(ip), redirect("/admin")

Note: Redirect to /admin (not return-to-origin) per research recommendation to start simple.
</action>
<verify>
`npm run lint` passes
File exists and exports login function: `grep -q "export async function login" src/app/actions/auth.ts`
</verify>
<done>
Server Action validates password, checks rate limits, creates session on success.
Rate limiting returns countdown. Invalid password shows "Incorrect password".
</done>
</task>

<task type="auto">
  <name>Task 2: Create login page</name>
  <files>src/app/admin/login/page.tsx</files>
  <action>
Create src/app/admin/login/page.tsx as a client component:

1. Add "use client" directive

2. Import:
   - useActionState from "react"
   - login, LoginState from "@/app/actions/auth"

3. Create LoginPage component:

   ```typescript
   export default function LoginPage() {
     const [state, action, pending] = useActionState<LoginState, FormData>(
       login,
       {},
     );
     // ...
   }
   ```

4. Render minimal centered form per CONTEXT.md:
   - Full-screen flex container with items-center justify-center
   - Form with action={action}
   - Password input field:
     - type="password"
     - name="password"
     - placeholder="Password"
     - Tailwind: w-full px-4 py-2 border rounded
     - disabled={pending}
   - Error message (if state.error):
     - Text: "{state.error}" in red (text-red-600 text-sm)
     - Display below password field
   - Rate limit message (if state.rateLimited):
     - Text: "Too many attempts. Try again in {state.retryAfter} seconds."
     - Display in red (text-red-600 text-sm)
   - Submit button:
     - Text: "Sign In" (or "Signing in..." when pending)
     - Tailwind: w-full py-2 bg-black text-white rounded
     - disabled={pending} with opacity-50 when disabled

5. Keep design minimal - just password field and button on blank page per user decision.
   - No logo, no "Admin Login" header - let simplicity speak
   - Max width on form (max-w-sm) for good proportions
     </action>
     <verify>
     `npm run lint` passes
     `npm run build` passes
     File exists: `test -f src/app/admin/login/page.tsx`
     </verify>
     <done>
     Login page renders at /admin/login with password field and submit button.
     Shows inline error for invalid password. Shows countdown for rate limiting.
     Loading state shown during submission.
     </done>
     </task>

</tasks>

<verification>
1. `npm run dev` starts without errors
2. Navigate to http://localhost:3000/admin/login
3. Page shows minimal login form
4. (With env vars set) Incorrect password shows "Incorrect password" error
5. `npm run lint` passes
6. `npm run build` passes
</verification>

<success_criteria>

- [ ] Server Action at src/app/actions/auth.ts handles login
- [ ] Login page renders at /admin/login
- [ ] Password field and submit button visible
- [ ] Error message displays for invalid password
- [ ] Rate limit message displays with countdown
- [ ] Loading state shows during form submission
- [ ] Successful login redirects to /admin
      </success_criteria>

<output>
After completion, create `.planning/phases/03-admin-auth/03-02-SUMMARY.md`
</output>
