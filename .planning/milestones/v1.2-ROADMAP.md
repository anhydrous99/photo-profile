# Milestone v1.2: Quality & Hardening

**Status:** SHIPPED 2026-02-08
**Phases:** 15-19
**Total Plans:** 14

## Overview

Make the portfolio solid, tested, and resilient -- unit tests for core logic, error handling across all surfaces, worker recovery, performance optimization, and tech debt cleanup.

## Phases

### Phase 15: Testing Infrastructure

**Goal**: Developers can write and run tests against the full infrastructure layer without module-level crashes, Redis hangs, or schema drift
**Depends on**: Nothing (first phase of milestone)
**Plans**: 2 plans

Plans:

- [x] 15-01: Vitest setup mocks and test database helper
- [x] 15-02: Test fixtures, coverage config, and smoke tests

**Details:**
Vitest config with env vars, 7-module global mock setup (server-only, next/headers, next/navigation, next/cache, ioredis, react.cache, bullmq), in-memory SQLite test database factory replicating full production migration chain, V8 coverage for infrastructure layer, 3 tiny Sharp-generated fixture images, 17 smoke tests.

### Phase 16: Error Boundaries & API Hardening

**Goal**: Users never see a white screen crash, a raw framework 404, or an inconsistent API error -- every failure surface has a designed recovery path
**Depends on**: Nothing (standalone)
**Plans**: 3 plans

Plans:

- [x] 16-01: Error boundaries and loading states (error.tsx, global-error.tsx, not-found.tsx, loading.tsx)
- [x] 16-02: API hardening (Zod validation, try/catch wrappers, consistent responses, upload safeguards)
- [x] 16-03: Data layer safety and upload UX (JSON.parse try/catch, DropZone 25MB limit, rejection toasts)

**Details:**
Error boundaries for root, album detail, and admin routes with retry buttons. Global error boundary with self-contained html/body. Styled 404 page. Loading skeletons for all route segments. Zod validation on all 8 API routes with consistent `{ error: string }` response format. Upload file size enforcement (Content-Length pre-check + file.size post-check). Queue failure logging. Safe JSON.parse wrapper for EXIF data. Client-side 25MB upload limit with rejection notifications.

### Phase 17: Unit & Integration Testing

**Goal**: Core infrastructure has automated test coverage proving repositories, image processing, auth, and API routes work correctly
**Depends on**: Phase 15 (test infrastructure), Phase 16 (error handling patterns)
**Plans**: 3 plans

Plans:

- [x] 17-01: Photo & album repository integration tests (CRUD, junction ops, serialization edge cases)
- [x] 17-02: Image service, EXIF service, and auth unit tests (derivatives, blur, JWT, bcrypt)
- [x] 17-03: Admin API route integration tests (auth checks, Zod validation, CRUD responses)

**Details:**
43 repository tests (CRUD, junction, serialization edge cases including null EXIF, Unicode, zero dimensions). 20 service tests (image derivatives, blur placeholders, EXIF extraction). 10 auth tests (JWT lifecycle, bcrypt). 31 API route tests (auth gates, Zod validation, CRUD responses). Total: 179 tests passing in <2s.

### Phase 18: Worker Resilience & Tech Debt

**Goal**: Photos never get permanently stuck in "processing" status, and known schema/code debt is resolved
**Depends on**: Phase 15 (test infrastructure)
**Plans**: 3 plans

Plans:

- [x] 18-01: Worker resilience (in-processor DB updates, findByStatus/findStaleProcessing repo methods, findOriginalFile helper)
- [x] 18-02: Admin UI for stuck/failed photos (status filter dropdown, stale detection, reprocess API endpoint)
- [x] 18-03: Tech debt cleanup (FK constraint SET NULL in initial CREATE, schema drift fix, stale comment correction)

**Details:**
DB status update moved inside BullMQ processor function (covered by 3-attempt retry). retryDbUpdate wrapper for failed handler with exponential backoff. findByStatus and findStaleProcessing repository methods. Admin status filter dropdown. Stale photo notification bar (30min threshold). Reprocess API endpoint. FK constraint ON DELETE SET NULL in initial albums CREATE. Test DB schema aligned with production. Misleading FK comment corrected.

### Phase 19: Performance & Production

**Goal**: Performance is measured with baselines, targeted optimizations are applied where data justifies them, and production observability is in place
**Depends on**: Nothing (independent)
**Plans**: 3 plans

Plans:

- [x] 19-01: Bundle analysis configuration and Lighthouse baseline measurement infrastructure
- [x] 19-02: Health check endpoint, structured logging utility, and console.\* migration
- [x] 19-03: Targeted optimizations (SQLite WAL mode, image ETag/304) with documented justification

**Details:**
Bundle analyzer configured (@next/bundle-analyzer with --webpack flag). Baseline bundle composition recorded (1007KB raw / 312KB gzipped). Lighthouse measurement script. Health check endpoint (GET /api/health, checks DB + storage, public). Structured logger with JSON output in production. All 16 server-side files migrated from console.\* to logger. SQLite WAL mode for concurrent read/write. ETag/304 conditional responses on image serving.

---

## Milestone Summary

**Key Decisions:**

- D-15-01-01: Env vars in vitest.config.ts test.env (not .env.test file)
- D-15-01-02: Setup file uses only vi.mock(), no imports of mocked modules
- D-15-01-03: test-db.ts replays exact migration chain from client.ts
- D-16-01-01: global-error.tsx uses inline styles (root layout replaced)
- D-16-02-01: Inner throw + outer catch pattern for image route ENOENT
- D-16-02-02: Standardized validation error message to "Validation failed"
- D-17-01-01: Fixed async transaction callbacks to synchronous (better-sqlite3 v12)
- D-17-02-01: Runtime-generated 400x300 JPEG for derivative tests
- D-19-01-01: Use --webpack flag for bundle analyzer (Turbopack incompatible)
- D-19-02-01: Logger reads process.env.LOG_LEVEL directly (avoid circular dep)
- D-19-02-02: Health check is public (no auth) -- operational endpoint
- D-19-03-01: ETag uses MD5 of mtime+size (not file content) for cheap generation
- D-19-03-02: Omitted synchronous=normal pragma to preserve data safety

**Issues Resolved:**

- FK constraint mismatch (schema said SET NULL, DB had NO ACTION) -- fixed in initial CREATE
- Schema drift between test-db.ts and client.ts -- aligned
- Stale photo_albums FK reference after albums table rebuild in test-db.ts
- ioredis/bullmq mock arrow functions not constructable with `new`
- Turbopack incompatible with @next/bundle-analyzer

**Issues Deferred:**

- Docker build untested (Docker not installed on dev machine)
- Lighthouse baselines as template (requires running server with data)
- Pre-existing TS error in mocks.smoke.test.ts (does not affect builds)
- findByStatus exported but not yet consumed by UI (forward-looking)

**Technical Debt Incurred:**

- alert() used for reprocess error display in admin (acceptable for single-admin app)
- Client error boundaries use console.error (correct -- client-side cannot use server logger)

---

_For current project status, see .planning/ROADMAP.md_
