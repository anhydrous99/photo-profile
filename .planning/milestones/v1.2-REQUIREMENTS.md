# Requirements Archive: v1.2 Quality & Hardening

**Archived:** 2026-02-08
**Status:** SHIPPED

For current requirements, see `.planning/REQUIREMENTS.md`.

---

# Requirements: Photo Portfolio v1.2 Quality & Hardening

**Defined:** 2026-02-06
**Core Value:** Let the photos speak for themselves -- a clean, distraction-free experience where the photography is the focus

## v1 Requirements

Requirements for v1.2 milestone. Each maps to roadmap phases.

### Testing Infrastructure

- [x] **TEST-01**: Vitest setup file mocks Next.js server APIs (server-only, cookies, headers, navigation, cache) so infrastructure imports do not crash
- [x] **TEST-02**: Vitest setup file mocks IORedis so tests do not hang on Redis connections
- [x] **TEST-03**: Test database helper creates in-memory SQLite with full migration chain matching production schema
- [x] **TEST-04**: Test fixture images exist for Sharp/EXIF testing (tiny programmatically-generated images, not large files)
- [x] **TEST-05**: Coverage reporting configured via @vitest/coverage-v8 targeting infrastructure layer

### Unit & Integration Testing

- [x] **UNIT-01**: Repository integration tests verify CRUD operations with real in-memory SQLite (not mocked Drizzle)
- [x] **UNIT-02**: Repository tests verify toDomain/toDatabase round-trip serialization including edge cases (null EXIF, Unicode filenames, zero dimensions)
- [x] **UNIT-03**: Image service tests verify derivative generation logic with fixture images
- [x] **UNIT-04**: Auth module tests verify JWT session creation, verification, and expiry
- [x] **UNIT-05**: API route integration tests verify request validation, auth checks, and error responses

### Error Handling

- [x] **ERR-01**: Root error.tsx catches unhandled errors with recovery UI and error logging
- [x] **ERR-02**: Root global-error.tsx catches root layout errors with its own html/body tags
- [x] **ERR-03**: Album detail error.tsx shows "Failed to load album" with retry button
- [x] **ERR-04**: Admin error.tsx catches authenticated page errors without exposing stack traces
- [x] **ERR-05**: Root not-found.tsx shows styled 404 with navigation back to site
- [x] **ERR-06**: Loading.tsx files at key route segments prevent blank flash during navigation
- [x] **ERR-07**: JSON.parse in repository toDomain() wrapped in try/catch returning null on corrupt data
- [x] **ERR-08**: All API routes validate input with Zod (standardize the 3 routes currently using raw type assertions)
- [x] **ERR-09**: All API routes have consistent try/catch with error logging and standard error response format
- [x] **ERR-10**: Upload route enforces file size limit before reading file into memory
- [x] **ERR-11**: Upload route logs Redis/queue failures instead of silently swallowing them

### Worker Resilience

- [x] **WORK-01**: Admin can see photos stuck in "processing" or "error" status with filtering
- [x] **WORK-02**: Admin can trigger reprocessing of failed photos
- [x] **WORK-03**: Stale processing detection finds photos in "processing" status beyond a time threshold
- [x] **WORK-04**: Worker DB status update is resilient to failures (moved to processor function or has retry logic)

### Performance & Production

- [x] **PERF-01**: Performance baselines measured before optimization (Lighthouse on public pages, API response times)
- [x] **PERF-02**: Bundle analysis configured via @next/bundle-analyzer with baseline recorded
- [x] **PERF-03**: Health check endpoint (GET /api/health) verifies DB connectivity and storage access
- [x] **PERF-04**: Structured logging utility replaces raw console.log with log levels and JSON output
- [x] **PERF-05**: Targeted performance optimizations applied based on measurement data (e.g., WAL mode, ETag/304)

### Tech Debt

- [x] **DEBT-01**: FK constraint on albums.coverPhotoId verified to have ON DELETE SET NULL (fix if missing)
- [x] **DEBT-02**: Schema drift reconciled -- Drizzle schema matches actual database tables (tags column, etc.)
- [x] **DEBT-03**: Stale comments fixed (imageProcessor.ts JPEG reference, any other misleading comments)

## v2 Requirements

Deferred to future milestone. Tracked but not in current roadmap.

### End-to-End Testing

- **E2E-01**: Playwright configured with test seed script for deterministic data
- **E2E-02**: E2E smoke tests cover critical user flows (login, upload, album creation, gallery)
- **E2E-03**: CI pipeline runs lint + typecheck + tests on push/PR

### Advanced Quality

- **QUAL-01**: Application service layer extracted where business logic duplication warrants it
- **QUAL-02**: Full observability stack (error tracking service integration)
- **QUAL-03**: Database migration framework adoption

## Out of Scope

Explicitly excluded. Documented to prevent scope creep.

| Feature                            | Reason                                                                                 |
| ---------------------------------- | -------------------------------------------------------------------------------------- |
| 100% test coverage target          | Focus on high-value infrastructure tests, not coverage metrics                         |
| Sentry/Datadog integration         | Self-hosted single-admin app -- structured logging sufficient                          |
| Comprehensive E2E suite            | 3-5 smoke tests deferred to v2; high setup cost, low ROI until unit tests exist        |
| Component-level React testing      | Presentation layer deferred -- test infrastructure and API layers first                |
| Database migration framework       | Fix FK constraint with targeted ALTER TABLE; defer migration tooling                   |
| Application service layer refactor | Empty layer is acceptable at current complexity; add services when duplication emerges |
| Rate limiting on all API routes    | Login rate limiting exists; admin routes require auth; low threat model                |

## Traceability

| Requirement | Phase | Status   |
| ----------- | ----- | -------- |
| TEST-01     | 15    | Complete |
| TEST-02     | 15    | Complete |
| TEST-03     | 15    | Complete |
| TEST-04     | 15    | Complete |
| TEST-05     | 15    | Complete |
| UNIT-01     | 17    | Complete |
| UNIT-02     | 17    | Complete |
| UNIT-03     | 17    | Complete |
| UNIT-04     | 17    | Complete |
| UNIT-05     | 17    | Complete |
| ERR-01      | 16    | Complete |
| ERR-02      | 16    | Complete |
| ERR-03      | 16    | Complete |
| ERR-04      | 16    | Complete |
| ERR-05      | 16    | Complete |
| ERR-06      | 16    | Complete |
| ERR-07      | 16    | Complete |
| ERR-08      | 16    | Complete |
| ERR-09      | 16    | Complete |
| ERR-10      | 16    | Complete |
| ERR-11      | 16    | Complete |
| WORK-01     | 18    | Complete |
| WORK-02     | 18    | Complete |
| WORK-03     | 18    | Complete |
| WORK-04     | 18    | Complete |
| PERF-01     | 19    | Complete |
| PERF-02     | 19    | Complete |
| PERF-03     | 19    | Complete |
| PERF-04     | 19    | Complete |
| PERF-05     | 19    | Complete |
| DEBT-01     | 18    | Complete |
| DEBT-02     | 18    | Complete |
| DEBT-03     | 18    | Complete |

**Coverage:**

- v1 requirements: 33 total
- Mapped to phases: 33
- Completed: 33
- Unmapped: 0

---

## Milestone Summary

**Shipped:** 33 of 33 requirements
**Adjusted:** None
**Dropped:** None

---

_Archived: 2026-02-08 as part of v1.2 milestone completion_
